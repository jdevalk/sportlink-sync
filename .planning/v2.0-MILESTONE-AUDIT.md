---
milestone: v2.0
audited: 2026-01-29T21:00:00Z
status: gaps_found
scores:
  requirements: 9/13
  phases: 5/5
  integration: 6/8
  flows: 1/4
gaps:
  requirements:
    - CONF-03: Conflict resolution never called in production (infrastructure exists but orphaned)
    - RSYNC-01: Change detection infrastructure exists but never runs (not scheduled)
    - INTEG-01: Audit logging prepared but starved (no data flows through)
    - INTEG-02: Email reports exist but reverse sync always reports zero changes
  integration:
    - Change detection (Phase 22) not connected to reverse sync (Phase 23/24) - no cron entry
    - Conflict resolver (Phase 21) orphaned - never called from forward or reverse sync
  flows:
    - "Stadion Edit → Sportlink Update" - broken at change detection step
    - "Bidirectional Conflict Resolution" - conflict resolver never invoked
    - "Audit Trail" - tables exist but starved (no data)
tech_debt: []
---

# v2.0 Milestone Audit Report

**Milestone:** v2.0 Bidirectional Sync
**Audited:** 2026-01-29T21:00:00Z
**Status:** GAPS FOUND

## Executive Summary

The v2.0 milestone has **all infrastructure built but critical integration gaps** prevent the E2E flows from working. All 5 phases passed verification individually, but cross-phase wiring is incomplete:

1. **Change detection never runs** - No cron entry or pipeline integration
2. **Conflict resolution never called** - Orphaned module
3. **Reverse sync is starved** - Runs every 15 minutes but finds zero changes

The infrastructure is complete and correct. The gap is purely in wiring the pieces together.

## Scores

| Area | Score | Status |
|------|-------|--------|
| Requirements | 9/13 | ⚠️ 4 blocked by integration gaps |
| Phases | 5/5 | ✓ All passed verification |
| Integration | 6/8 | ⚠️ 2 critical connections missing |
| E2E Flows | 1/4 | ✗ 3 flows broken |

## Phase Verification Status

| Phase | Status | Score | Notes |
|-------|--------|-------|-------|
| 20. Foundation | ✅ Passed | 4/4 | Database schema complete |
| 21. Conflict Resolution | ✅ Passed | 6/6 | Infrastructure complete, never called |
| 22. Change Detection | ✅ Passed | 4/4 | Works when run, never scheduled |
| 23. Contact Fields | ✅ Passed | 5/5 | Automation complete, starved for data |
| 24. Multi-Page Sync | ✅ Passed | 6/6 | All pages implemented, starved for data |

## Requirements Coverage

### Satisfied ✓

| Requirement | Phase | Evidence |
|-------------|-------|----------|
| FOUND-01: Per-field timestamp tracking | 20 | 14 columns in stadion_members |
| FOUND-02: Sync origin attribution | 20 | sync_origin column, SYNC_ORIGIN constants |
| FOUND-03: UTC normalization | 20 | createTimestamp uses toISOString() |
| CONF-01: Timestamp comparison for LWW | 21 | compareTimestamps() in conflict-resolver.js |
| CONF-02: Field-level conflict resolution | 21 | resolveFieldConflicts() loops through TRACKED_FIELDS |
| RSYNC-02: Contact fields reverse sync | 23 | Playwright automation for email, email2, mobile, phone |
| RSYNC-03: Free fields reverse sync | 24 | datum-vog, freescout-id mapped to /other page |
| RSYNC-04: Financial toggle reverse sync | 24 | financiele-blokkade checkbox handling |
| INTEG-03: 15-minute cron schedule | 24 | install-cron.sh line 120 |

### Blocked ⚠️

| Requirement | Phase | Issue |
|-------------|-------|-------|
| CONF-03: Operator notification on conflicts | 21 | generateConflictSummary() exists but never called |
| RSYNC-01: Query Stadion for modified members | 22 | detectChanges() exists but never runs (no schedule) |
| INTEG-01: Audit logging | 22 | logChangeDetection() exists but table stays empty |
| INTEG-02: Email includes reverse sync stats | 24 | Reports "0 synced" because no changes detected |

## Integration Gaps

### Critical Gap 1: Change Detection Not Scheduled

**Problem:** Phase 22 built `detect-stadion-changes.js` with full functionality, but it is never called:
- No cron entry in `install-cron.sh`
- Not called by `reverse-sync.js`
- Not called by any other pipeline

**Impact:** `stadion_change_detections` table stays empty → reverse sync finds nothing to sync.

**Evidence:**
- `scripts/install-cron.sh`: No entry for detect-stadion-changes
- `reverse-sync.js`: Calls `runReverseSyncMultiPage()` directly without detection

**Fix Required:** Call `detectChanges()` at start of `reverse-sync.js` before `runReverseSyncMultiPage()`.

### Critical Gap 2: Conflict Resolution Orphaned

**Problem:** Phase 21 built `lib/conflict-resolver.js` with complete logic, but nothing imports it:

**Evidence:**
```bash
# No imports of conflict-resolver outside its own self-test:
grep -r "require.*conflict-resolver" --include="*.js"
# Returns only: lib/conflict-resolver.js (self-test)
```

**Impact:** Conflicts between Sportlink and Stadion are never detected. Last sync always wins without timestamp comparison.

**Fix Required:** Integrate `resolveFieldConflicts()` into forward sync (`submit-stadion-sync.js`).

## E2E Flow Analysis

### Flow 1: Stadion Edit → Sportlink Update ✗ BROKEN

**Expected:**
1. User edits email in Stadion ✓
2. `detectChanges()` queries modified members ✗ (never runs)
3. Change logged to `stadion_change_detections` ✗ (step 2 missing)
4. `reverse-sync.js` reads changes ✓ (runs but finds nothing)
5. Pushes to Sportlink ✗ (no data to push)

**Broken At:** Step 2

### Flow 2: Bidirectional Conflict Resolution ✗ BROKEN

**Expected:**
1. Both systems have modifications
2. Forward sync compares timestamps
3. `resolveFieldConflicts()` applies LWW
4. Winner value synced, loser logged

**Broken At:** Step 3 (resolver never called)

### Flow 3: Multi-Page Sync ⚠️ BLOCKED

**Status:** Would work IF change detection ran. All infrastructure complete.

### Flow 4: Cron Integration ⚠️ PARTIAL

**Working:** 15-minute schedule runs `reverse-sync.js`
**Blocked:** Reverse sync finds nothing because detection never ran

## Recommended Fix

### Option A: Minimal Integration (Recommended)

Modify `reverse-sync.js` to call detection before sync:

```javascript
// Add at start of runAllFieldsReverseSync():
const { detectChanges } = require('./lib/detect-stadion-changes');
await detectChanges({ verbose, logger });
```

This makes detection and sync atomic (same 15-minute cycle).

### Option B: Separate Schedules

Add detection to cron (run before reverse sync):
```bash
*/10 * * * * detect-stadion-changes.js  # Detect
*/15 * * * * sync.sh reverse             # Sync
```

### Conflict Resolution

Integrate into `submit-stadion-sync.js`:
```javascript
const { resolveFieldConflicts } = require('./lib/conflict-resolver');
// Before updating Stadion, resolve any conflicts
```

## Human Verification Items

Carried forward from phase verifications:

1. **Sportlink selectors** - Phase 23/24 selectors are placeholders needing browser inspection
2. **Production reverse sync test** - Full E2E test once gaps fixed
3. **Multi-page session persistence** - Verify single login spans all pages

## Conclusion

**v2.0 cannot be considered complete.** While all phases passed individual verification and the infrastructure is correct, the critical integration gaps mean:

- Reverse sync runs but does nothing (starved for data)
- Conflicts can occur silently (resolver never called)
- Audit tables stay empty (no data flows through)

**Estimated effort to close gaps:** Small - both fixes are integration wiring, not new features.

---

*Audited: 2026-01-29T21:00:00Z*
*Auditor: Claude (milestone audit orchestrator)*
