# Milestone v2.0: Bidirectional Sync

**Status:** SHIPPED 2026-01-29
**Phases:** 20-26
**Total Plans:** 10

## Overview

v2.0 adds bidirectional sync capability to enable corrections made in Stadion to flow back to Sportlink via browser automation. The roadmap implements loop prevention and conflict resolution infrastructure before enabling reverse sync, starting with low-risk contact fields and expanding to free fields and financial toggles. All reverse sync operations are audited and reported via email.

## Phases

### Phase 20: Foundation (Database & Origin Tracking)

**Goal**: Database schema supports bidirectional timestamp tracking and origin attribution to prevent infinite sync loops

**Depends on**: Phase 19

**Requirements**: FOUND-01, FOUND-02, FOUND-03

**Success Criteria**:
1. SQLite schema includes forward and reverse modification timestamps per field
2. All sync operations record origin (user-edit vs sync-initiated)
3. Timestamp comparison operations normalize all times to UTC before comparison
4. Migration script successfully adds columns to existing stadion-sync.sqlite without data loss

**Plans:** 1 plan

Plans:
- [x] 20-01-PLAN.md - Add per-field timestamp columns and sync-origin utilities

**Details:**
Per-field bidirectional timestamps (14 columns) and sync_origin tracking enable conflict detection for future reverse sync. Created lib/sync-origin.js with TRACKED_FIELDS array (7 fields), timestamp utilities, and 5-second tolerance comparison.

### Phase 21: Conflict Resolution Infrastructure

**Goal**: System detects conflicts and resolves them using last-edit-wins logic at field level

**Depends on**: Phase 20

**Requirements**: CONF-01, CONF-02, CONF-03

**Success Criteria**:
1. Conflict resolver compares timestamps to determine which edit is newer
2. Conflicts detected and resolved at individual field level, not whole record
3. Operator receives email notification when conflicts are detected with details of resolution
4. Grace period tolerates minor clock drift between systems

**Plans:** 1 plan

Plans:
- [x] 21-01-PLAN.md - Conflict detection and resolution module with audit trail

**Details:**
Field-level LWW conflict detection with 5-second grace period and audit trail. Created lib/conflict-resolver.js with resolveFieldConflicts() and generateConflictSummary(). Added conflict_resolutions audit table.

### Phase 22: Stadion Change Detection

**Goal**: System identifies which Stadion members have modifications newer than Sportlink for reverse sync

**Depends on**: Phase 21

**Requirements**: RSYNC-01, INTEG-01

**Success Criteria**:
1. System queries Stadion REST API for members with modified_gmt timestamps
2. Timestamp comparison identifies members with Stadion changes newer than last forward sync
3. Hash-based change detection confirms actual field changes (not just modification time)
4. All detected changes logged with timestamps and field values for audit trail

**Plans:** 2 plans

Plans:
- [x] 22-01-PLAN.md - Stadion change detection script with audit table and hash comparison
- [x] 22-02-PLAN.md - Fix field-level comparison (gap closure)

**Details:**
Hash-based change detection for 7 tracked fields with SQLite audit trail. Created lib/detect-stadion-changes.js and detect-stadion-changes.js CLI. Added stadion_change_detections and reverse_sync_state tables.

### Phase 23: Contact Fields Reverse Sync

**Goal**: Contact field corrections (email, email2, mobile, phone) sync from Stadion to Sportlink via browser automation

**Depends on**: Phase 22

**Requirements**: RSYNC-02

**Success Criteria**:
1. System navigates to Sportlink /general page and enters edit mode
2. Contact fields (email, email2, mobile, phone) update in Sportlink with values from Stadion
3. Form submission verified by reading back saved values from Sportlink
4. Failed submissions retry with exponential backoff up to 3 attempts
5. Successful reverse sync updates forward_modified timestamp to prevent re-sync

**Plans:** 2 plans

Plans:
- [x] 23-01-PLAN.md - Core reverse sync module with Playwright automation
- [x] 23-02-PLAN.md - Pipeline integration and email reporting

**Details:**
Playwright-based reverse sync engine pushing email/mobile/phone changes from Stadion to Sportlink with retry and verification. Created lib/reverse-sync-sportlink.js and reverse-sync-contact-fields.js CLI.

### Phase 24: Free Fields & Financial Toggle Reverse Sync

**Goal**: All remaining target fields (datum-vog, freescout-id, financial block) sync from Stadion to Sportlink with full observability

**Depends on**: Phase 23

**Requirements**: RSYNC-03, RSYNC-04, INTEG-02, INTEG-03

**Success Criteria**:
1. System syncs datum-vog and freescout-id from Stadion to Sportlink /other page
2. System syncs financiele-blokkade toggle from Stadion to Sportlink /financial page
3. Multi-page navigation maintains session state across /general, /other, and /financial pages
4. Email reports include reverse sync statistics (members updated, fields changed, conflicts resolved)
5. Reverse sync runs on separate cron schedule every 15 minutes via scripts/sync.sh reverse
6. Graceful degradation on failures (forward sync not blocked by reverse sync issues)

**Plans:** 2 plans

Plans:
- [x] 24-01-PLAN.md - Multi-page reverse sync core with session timeout detection
- [x] 24-02-PLAN.md - CLI entry point and 15-minute cron integration

**Details:**
Multi-page Sportlink navigation enabling reverse sync for datum-vog, freescout-id, and financiele-blokkade across /general, /other, and /financial pages. Added 15-minute cron schedule via scripts/sync.sh reverse.

### Phase 25: Wire Change Detection to Reverse Sync (Gap Closure)

**Goal**: Connect orphaned change detection infrastructure to reverse sync pipeline so Stadion edits flow through to Sportlink

**Depends on**: Phase 24

**Requirements**: RSYNC-01, INTEG-01, INTEG-02

**Gap Closure**: Closes integration gap from v2.0-MILESTONE-AUDIT.md

**Success Criteria**:
1. reverse-sync.js calls detectChanges() before runReverseSyncMultiPage()
2. stadion_change_detections table populates with real data when Stadion members are modified
3. E2E flow works: Stadion edit -> change detected -> reverse sync -> Sportlink updated
4. Email reports show actual reverse sync statistics (non-zero when changes exist)

**Plans:** 1 plan

Plans:
- [x] 25-01-PLAN.md - Wire detectChanges() into reverse sync entry point

**Details:**
Wired detectChanges() from lib/detect-stadion-changes.js to reverse-sync.js, populating stadion_change_detections table before reverse sync processing.

### Phase 26: Wire Conflict Resolution to Forward Sync (Gap Closure)

**Goal**: Connect orphaned conflict resolution infrastructure to forward sync so bidirectional conflicts are detected and resolved

**Depends on**: Phase 25

**Requirements**: CONF-03

**Gap Closure**: Closes integration gap from v2.0-MILESTONE-AUDIT.md

**Success Criteria**:
1. submit-stadion-sync.js calls resolveFieldConflicts() before updating Stadion
2. Conflicts are detected when both systems have modifications to same field
3. Last-edit-wins is applied based on timestamp comparison
4. Conflict resolutions logged to audit table and included in email reports

**Plans:** 1 plan

Plans:
- [x] 26-01-PLAN.md - Wire conflict resolution to forward sync UPDATE path

**Details:**
Forward sync now detects bidirectional conflicts using last-write-wins with 5-second grace period and reports them in email summaries. Added extractTrackedFieldValues() and applyResolutions() helpers.

---

## Milestone Summary

**Key Decisions:**
- Per-field timestamp tracking (14 columns for 7 fields Ã— 2 systems)
- 5-second grace period for clock drift tolerance
- Sportlink wins on timestamp tie (forward sync bias)
- NULL timestamps treated as "modified before tracking started"
- Playwright for Sportlink form automation (no API available)
- Field verification after save by reading values back
- Sequential member processing with rate limiting
- Exponential backoff retry (3 attempts) with jitter

**Issues Resolved:**
- Orphaned change detection infrastructure connected (Phase 25)
- Orphaned conflict resolution infrastructure connected (Phase 26)

**Issues Deferred:**
- Sportlink selector verification needs browser inspection before production use
- NTP clock sync verification on production server

**Technical Debt Incurred:**
- SYNC_ORIGIN.SYNC_FORWARD defined but never written to database (loop prevention works via timestamps)
- Placeholder Sportlink selectors need real browser verification

---

*For current project status, see .planning/PROJECT.md*
