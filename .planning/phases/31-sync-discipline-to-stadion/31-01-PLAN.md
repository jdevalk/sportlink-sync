---
phase: 31-sync-discipline-to-stadion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/discipline-db.js
  - submit-stadion-discipline.js
autonomous: true

must_haves:
  truths:
    - "Cases create as discipline-cases posts in Stadion when person exists"
    - "Cases update when source data changes (hash mismatch)"
    - "Cases skip when person not yet synced to Stadion"
    - "Season is derived from match date (Aug 1 boundary)"
    - "Season category auto-creates if missing"
  artifacts:
    - path: "lib/discipline-db.js"
      provides: "Sync tracking columns and helper functions"
      exports: ["getCasesNeedingSync", "updateCaseSyncState", "getSeasonFromDate"]
    - path: "submit-stadion-discipline.js"
      provides: "Stadion sync script"
      exports: ["runSync"]
  key_links:
    - from: "submit-stadion-discipline.js"
      to: "lib/discipline-db.js"
      via: "getCasesNeedingSync(), updateCaseSyncState()"
      pattern: "require.*discipline-db"
    - from: "submit-stadion-discipline.js"
      to: "lib/stadion-db.js"
      via: "Person stadion_id lookup"
      pattern: "stadion_members.*knvb_id"
    - from: "submit-stadion-discipline.js"
      to: "/wp/v2/discipline-cases"
      via: "stadionRequest POST/PUT"
      pattern: "stadionRequest.*discipline-cases"
    - from: "submit-stadion-discipline.js"
      to: "/wp/v2/seizoen"
      via: "Season term lookup/create"
      pattern: "stadionRequest.*seizoen"
---

<objective>
Sync discipline cases from SQLite to Stadion WordPress as `discipline-cases` custom post type with person linking and season categories.

Purpose: Enable discipline case data to appear in Stadion alongside member profiles, organized by season for filtering and archive pages.

Output: Working sync script that creates/updates discipline cases in Stadion with proper ACF field mapping, person relationships, and season categorization.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/31-sync-discipline-to-stadion/31-CONTEXT.md
@.planning/phases/31-sync-discipline-to-stadion/31-RESEARCH.md
@.planning/phases/31-sync-discipline-to-stadion/31-STADION-REQUIREMENTS.md
@.planning/phases/30-download-discipline-cases/30-01-SUMMARY.md

# Existing patterns to follow
@lib/discipline-db.js
@lib/stadion-db.js
@submit-stadion-teams.js
@sync-important-dates.js
@lib/stadion-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend discipline-db.js with sync tracking</name>
  <files>lib/discipline-db.js</files>
  <action>
Add sync tracking columns and helper functions to the existing discipline-db.js module.

**Schema migration (add columns if not exist):**
- `stadion_id INTEGER` - WordPress post ID after creation
- `last_synced_hash TEXT` - Hash at last successful sync
- `last_synced_at TEXT` - ISO timestamp of last sync
- `season TEXT` - Derived season string (e.g., "2025-2026")

Use the PRAGMA table_info pattern from research to check column existence before ALTER TABLE.

**Add functions:**

1. `getSeasonFromDate(dateString)` - Returns season string from date
   - August (month >= 7 in 0-indexed) or later = new season starting that year
   - July or earlier = season started previous year
   - Example: "2026-01-15" -> "2025-2026", "2026-08-01" -> "2026-2027"

2. `getCasesNeedingSync(db, force = false)` - Returns cases needing Stadion sync
   - If force=true: return all cases
   - Otherwise: return cases where last_synced_hash IS NULL OR last_synced_hash != source_hash
   - Include computed source_hash in returned rows
   - Order by match_date DESC

3. `updateCaseSyncState(db, dossierId, syncedHash, stadionId, season)` - Update after successful sync
   - Set stadion_id, last_synced_hash, last_synced_at, season
   - last_synced_at = new Date().toISOString()

4. `getCaseByDossierId(db, dossierId)` - Get single case for lookup

**Export all new functions in module.exports.**

Follow the exact patterns from stadion-db.js for:
- Column existence checking (PRAGMA table_info)
- Prepared statement usage
- Error handling
  </action>
  <verify>
```bash
node -e "
const db = require('./lib/discipline-db');
const testDb = db.openDb(':memory:');

// Test schema migration
const cols = testDb.prepare('PRAGMA table_info(discipline_cases)').all();
const colNames = cols.map(c => c.name);
console.log('Has stadion_id:', colNames.includes('stadion_id'));
console.log('Has last_synced_hash:', colNames.includes('last_synced_hash'));
console.log('Has season:', colNames.includes('season'));

// Test getSeasonFromDate
console.log('Jan 2026:', db.getSeasonFromDate('2026-01-15') === '2025-2026');
console.log('Aug 2026:', db.getSeasonFromDate('2026-08-01') === '2026-2027');
console.log('Jul 2026:', db.getSeasonFromDate('2026-07-31') === '2025-2026');

// Test exports exist
console.log('getCasesNeedingSync:', typeof db.getCasesNeedingSync === 'function');
console.log('updateCaseSyncState:', typeof db.updateCaseSyncState === 'function');

testDb.close();
console.log('All checks passed');
"
```
  </verify>
  <done>
- Schema migration adds 4 new columns to discipline_cases table
- getSeasonFromDate() correctly derives season from date string
- getCasesNeedingSync() returns cases with hash mismatch
- updateCaseSyncState() updates sync tracking fields
- All functions exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create submit-stadion-discipline.js sync script</name>
  <files>submit-stadion-discipline.js</files>
  <action>
Create the main sync script following the established pattern from submit-stadion-teams.js.

**Structure:**

```javascript
require('varlock/auto-load');

const { stadionRequest } = require('./lib/stadion-client');
const {
  openDb: openDisciplineDb,
  getCasesNeedingSync,
  updateCaseSyncState,
  getSeasonFromDate,
  getAllCases
} = require('./lib/discipline-db');
const { openDb: openStadionDb } = require('./lib/stadion-db');
```

**Key functions:**

1. `buildPersonLookup()` - Load knvb_id -> stadion_id mapping from stadion-sync.sqlite
   - Open stadion-sync.sqlite (not discipline-sync.sqlite)
   - Query: SELECT knvb_id, stadion_id FROM stadion_members WHERE stadion_id IS NOT NULL
   - Return Map for O(1) lookup
   - Close database after query

2. `fetchPersonName(stadionId, options)` - Get person name for title
   - GET /wp/v2/people/{stadionId}
   - Return title.rendered or construct from ACF first_name + last_name
   - Cache results in Map during sync run to avoid duplicate fetches

3. `getOrCreateSeasonTermId(seasonName, options)` - Ensure season term exists
   - GET /wp/v2/seizoen?slug={seasonName}
   - If found: return term ID
   - If not found: POST /wp/v2/seizoen with name and slug
   - Cache results in Map during sync run

4. `buildCaseTitle(personName, matchDescription, matchDate)` - Format title
   - Return: "{personName} - {matchDescription} - {matchDate}"

5. `syncCase(caseData, personStadionId, seasonTermId, personName, db, options)` - Sync single case
   - Build WordPress payload with all ACF fields:
     - title: buildCaseTitle result
     - status: 'publish'
     - seizoen: [seasonTermId]
     - acf: all fields from STADION-REQUIREMENTS.md
   - If caseData.stadion_id exists: PUT to update
   - Otherwise: POST to create
   - Handle 404 on update (case deleted in WordPress) - clear stadion_id and recreate
   - Call updateCaseSyncState on success
   - Return { action: 'created'|'updated'|'skipped', id }

6. `runSync(options = {})` - Main orchestration
   - options: { logger, verbose, force }
   - Build person lookup map
   - Initialize caches for person names and season terms
   - Get cases needing sync
   - For each case:
     - Look up person stadion_id from public_person_id
     - If no match: skip case (count as skipped_no_person)
     - Fetch person name (cached)
     - Derive season from match_date
     - Get/create season term ID (cached)
     - Sync case
   - Return result object: { success, total, synced, created, updated, skipped, skipped_no_person, errors }

**ACF field mapping (from CONTEXT.md and STADION-REQUIREMENTS.md):**
- dossier-id: caseData.dossier_id
- person: personStadionId (single ID, not array)
- match-date: caseData.match_date
- match-description: caseData.match_description
- team-name: caseData.team_name
- charge-codes: caseData.charge_codes (already JSON string if array)
- charge-description: caseData.charge_description
- sanction-description: caseData.sanction_description
- processing-date: caseData.processing_date
- administrative-fee: caseData.administrative_fee
- is-charged: caseData.is_charged === 1

**CLI entry point:**
```javascript
if (require.main === module) {
  const verbose = process.argv.includes('--verbose');
  const force = process.argv.includes('--force');

  runSync({ verbose, force })
    .then(result => {
      console.log(`Discipline cases sync: ${result.synced}/${result.total} synced`);
      console.log(`  Created: ${result.created}`);
      console.log(`  Updated: ${result.updated}`);
      console.log(`  Skipped (unchanged): ${result.skipped}`);
      console.log(`  Skipped (no person): ${result.skipped_no_person}`);
      if (result.errors.length > 0) {
        console.error(`  Errors: ${result.errors.length}`);
        result.errors.forEach(e => console.error(`    - ${e.dossier_id}: ${e.message}`));
        process.exitCode = 1;
      }
    })
    .catch(err => {
      console.error('Error:', err.message);
      process.exitCode = 1;
    });
}
```

**Important:**
- Do NOT delete cases from Stadion (per requirements - historical record)
- Skip cases where person not found, log count for email report
- Use verbose logging pattern from submit-stadion-teams.js
- Export runSync for pipeline integration in Phase 32
  </action>
  <verify>
```bash
# Verify module loads without syntax errors
node -e "const { runSync } = require('./submit-stadion-discipline'); console.log('Module loads, runSync is:', typeof runSync);"

# Verify all imports resolve
node -e "
require('varlock/auto-load');
const { stadionRequest } = require('./lib/stadion-client');
const disciplineDb = require('./lib/discipline-db');
const stadionDb = require('./lib/stadion-db');
console.log('All imports resolve successfully');
"
```
  </verify>
  <done>
- submit-stadion-discipline.js exists and loads without errors
- runSync function exported
- Person lookup loads from stadion-sync.sqlite
- Season term get/create works via REST API
- Case sync creates/updates with all ACF fields
- Cases without matching person are skipped and counted
- CLI entry point works with --verbose and --force flags
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full sync workflow:

```bash
# 1. Module loads and all functions available
node -e "
const disciplineDb = require('./lib/discipline-db');
const { runSync } = require('./submit-stadion-discipline');

// Check discipline-db exports
const exports = ['openDb', 'getCasesNeedingSync', 'updateCaseSyncState', 'getSeasonFromDate', 'getAllCases'];
exports.forEach(fn => {
  if (typeof disciplineDb[fn] !== 'function') {
    console.error('Missing:', fn);
    process.exit(1);
  }
});

// Check sync exports
if (typeof runSync !== 'function') {
  console.error('Missing: runSync');
  process.exit(1);
}

console.log('All exports verified');
"

# 2. Season calculation is correct
node -e "
const { getSeasonFromDate } = require('./lib/discipline-db');
const tests = [
  ['2026-01-15', '2025-2026'],
  ['2026-07-31', '2025-2026'],
  ['2026-08-01', '2026-2027'],
  ['2025-12-25', '2025-2026'],
  ['2025-09-01', '2025-2026']
];
tests.forEach(([input, expected]) => {
  const result = getSeasonFromDate(input);
  if (result !== expected) {
    console.error('FAIL:', input, '->', result, 'expected', expected);
    process.exit(1);
  }
});
console.log('Season calculation tests passed');
"
```

Full integration test requires server execution with discipline cases in database and Stadion configured.
</verification>

<success_criteria>
1. lib/discipline-db.js has sync tracking columns (stadion_id, last_synced_hash, last_synced_at, season)
2. getSeasonFromDate() correctly derives season using August 1 boundary
3. getCasesNeedingSync() returns cases with hash mismatch or all cases with force
4. submit-stadion-discipline.js creates/updates discipline-cases posts in Stadion
5. Person linking uses stadion_id from stadion-sync.sqlite lookup
6. Season terms are auto-created via /wp/v2/seizoen if missing
7. Cases without matching person are skipped (not orphaned in Stadion)
8. runSync() returns result object suitable for email report integration
</success_criteria>

<output>
After completion, create `.planning/phases/31-sync-discipline-to-stadion/31-01-SUMMARY.md`
</output>
