---
phase: 34-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/laposta-db.js
  - lib/rondo-club-db.js
  - lib/freescout-db.js
  - lib/nikki-db.js
  - lib/discipline-db.js
  - lib/dashboard-db.js
autonomous: false

must_haves:
  truths:
    - "Every openDb() call enables WAL journal mode and sets busy_timeout"
    - "dashboard.sqlite is created with runs, run_steps, and run_errors tables"
    - "All dashboard tables include a club_slug column"
    - "Node.js 22 is running on the production server"
    - "All existing cron pipelines work after the upgrade"
  artifacts:
    - path: "lib/laposta-db.js"
      provides: "WAL mode and busy_timeout in openDb()"
      contains: "pragma journal_mode"
    - path: "lib/rondo-club-db.js"
      provides: "WAL mode and busy_timeout in openDb()"
      contains: "pragma journal_mode"
    - path: "lib/freescout-db.js"
      provides: "WAL mode and busy_timeout in openDb()"
      contains: "pragma journal_mode"
    - path: "lib/nikki-db.js"
      provides: "WAL mode and busy_timeout in openDb()"
      contains: "pragma journal_mode"
    - path: "lib/discipline-db.js"
      provides: "WAL mode and busy_timeout in openDb()"
      contains: "pragma journal_mode"
    - path: "lib/dashboard-db.js"
      provides: "Dashboard database with run tracking schema"
      exports: ["openDb", "initDb"]
  key_links:
    - from: "lib/dashboard-db.js"
      to: "data/dashboard.sqlite"
      via: "openDb() creates database file"
      pattern: "dashboard-sync\\.sqlite"
    - from: "lib/*-db.js"
      to: "SQLite databases"
      via: "WAL pragma in openDb()"
      pattern: "journal_mode.*WAL"
---

<objective>
Add WAL journal mode and busy_timeout to all 5 existing SQLite database modules, and create the dashboard database module with run tracking schema.

Purpose: Prepare all databases for concurrent access from cron pipelines and a future long-running web server. Without WAL mode, simultaneous reads and writes cause SQLITE_BUSY errors.

Output: 5 modified database modules with WAL+busy_timeout, 1 new dashboard-db.js with runs/run_steps/run_errors tables.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevald/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@lib/laposta-db.js
@lib/rondo-club-db.js
@lib/freescout-db.js
@lib/nikki-db.js
@lib/discipline-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WAL mode and busy_timeout to all 5 existing database modules</name>
  <files>
    lib/laposta-db.js
    lib/rondo-club-db.js
    lib/freescout-db.js
    lib/nikki-db.js
    lib/discipline-db.js
  </files>
  <action>
In each of the 5 database modules, modify the `openDb()` function to enable WAL journal mode and set a busy_timeout immediately after creating the Database instance and before calling `initDb()`.

The current pattern in each file is:
```javascript
function openDb(dbPath = DEFAULT_DB_PATH) {
  const db = new Database(dbPath);
  initDb(db);
  return db;
}
```

Change it to:
```javascript
function openDb(dbPath = DEFAULT_DB_PATH) {
  const db = new Database(dbPath);
  db.pragma('journal_mode = WAL');
  db.pragma('busy_timeout = 5000');
  initDb(db);
  return db;
}
```

Apply this exact same change to all 5 files:
1. `lib/laposta-db.js` (line 23-27)
2. `lib/rondo-club-db.js` (line 19-23)
3. `lib/freescout-db.js` (line 19-23)
4. `lib/nikki-db.js` (line 25-29)
5. `lib/discipline-db.js` (line 30-34)

The `busy_timeout` of 5000ms (5 seconds) gives concurrent readers time to complete without failing. WAL mode allows concurrent reads while a write is in progress. Both pragmas are set per-connection (not persistent in the database file for busy_timeout), so they must be set every time a connection is opened.
  </action>
  <verify>
Run `node -e "const db = require('./lib/laposta-db'); const d = db.openDb(); console.log(d.pragma('journal_mode')); d.close()"` and confirm output includes `wal`.

Repeat for all 5 modules (laposta-db, rondo-club-db, freescout-db, nikki-db, discipline-db).
  </verify>
  <done>All 5 openDb() functions set WAL journal mode and 5-second busy_timeout before initializing schema.</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard database module with run tracking schema</name>
  <files>lib/dashboard-db.js</files>
  <action>
Create `lib/dashboard-db.js` following the exact same patterns as the existing database modules (CommonJS, module/CLI hybrid, same code style).

The module must:

1. Use `data/dashboard.sqlite` as the default database path.

2. Export `openDb(dbPath)` that creates the database, sets WAL + busy_timeout (same as Task 1), and calls `initDb()`.

3. The `initDb(db)` function creates 3 tables:

**Table `runs`:**
```sql
CREATE TABLE IF NOT EXISTS runs (
  id INTEGER PRIMARY KEY,
  club_slug TEXT NOT NULL DEFAULT 'rondo',
  pipeline TEXT NOT NULL,
  started_at TEXT NOT NULL,
  finished_at TEXT,
  duration_ms INTEGER,
  outcome TEXT CHECK(outcome IN ('success', 'failure', 'running')),
  total_created INTEGER DEFAULT 0,
  total_updated INTEGER DEFAULT 0,
  total_skipped INTEGER DEFAULT 0,
  total_failed INTEGER DEFAULT 0,
  summary_json TEXT
);

CREATE INDEX IF NOT EXISTS idx_runs_club_pipeline
  ON runs (club_slug, pipeline, started_at);
```

**Table `run_steps`:**
```sql
CREATE TABLE IF NOT EXISTS run_steps (
  id INTEGER PRIMARY KEY,
  run_id INTEGER NOT NULL REFERENCES runs(id),
  club_slug TEXT NOT NULL DEFAULT 'rondo',
  step_name TEXT NOT NULL,
  started_at TEXT NOT NULL,
  finished_at TEXT,
  duration_ms INTEGER,
  outcome TEXT CHECK(outcome IN ('success', 'failure', 'skipped')),
  created_count INTEGER DEFAULT 0,
  updated_count INTEGER DEFAULT 0,
  skipped_count INTEGER DEFAULT 0,
  failed_count INTEGER DEFAULT 0,
  detail_json TEXT
);

CREATE INDEX IF NOT EXISTS idx_run_steps_run_id
  ON run_steps (run_id);
```

**Table `run_errors`:**
```sql
CREATE TABLE IF NOT EXISTS run_errors (
  id INTEGER PRIMARY KEY,
  run_id INTEGER NOT NULL REFERENCES runs(id),
  run_step_id INTEGER REFERENCES run_steps(id),
  club_slug TEXT NOT NULL DEFAULT 'rondo',
  step_name TEXT NOT NULL,
  member_identifier TEXT,
  error_message TEXT NOT NULL,
  error_stack TEXT,
  created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_run_errors_run_id
  ON run_errors (run_id);

CREATE INDEX IF NOT EXISTS idx_run_errors_club_step
  ON run_errors (club_slug, step_name, created_at);
```

4. Export the module: `module.exports = { DEFAULT_DB_PATH, openDb, initDb };`

5. Include the `if (require.main === module)` CLI block that opens the database and logs "Dashboard database initialized at {path}" — useful for verifying the schema is created correctly.

Use the same code conventions: 2-space indentation, JSDoc comments on exported functions, `const path = require('path')` and `const Database = require('better-sqlite3')` at the top. Import `nowISO` from `./utils` for the CLI block.

Do NOT add CRUD helper functions yet — those belong in Phase 35 (Run Tracking). This task only creates the schema.
  </action>
  <verify>
Run `node lib/dashboard-db.js` and confirm it prints "Dashboard database initialized at ..." without errors.

Then verify tables exist: `node -e "const db = require('./lib/dashboard-db').openDb(); const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all(); console.log(tables.map(t => t.name))"` — should show `runs`, `run_steps`, `run_errors`.

Verify club_slug column exists on all 3 tables: `node -e "const db = require('./lib/dashboard-db').openDb(); ['runs','run_steps','run_errors'].forEach(t => { const cols = db.pragma('table_info(' + t + ')'); const has = cols.some(c => c.name === 'club_slug'); console.log(t + ': club_slug=' + has) })"` — all should print `true`.
  </verify>
  <done>
`lib/dashboard-db.js` exists and creates `data/dashboard.sqlite` with `runs`, `run_steps`, and `run_errors` tables. All 3 tables include a `club_slug` column with default value `'rondo'`. WAL mode and busy_timeout are set on connection open.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
WAL mode and busy_timeout added to all 5 existing database modules. New dashboard database module created with run tracking schema. Code is ready to deploy.

The remaining Phase 34 requirement is INFRA-01: Node.js 22 upgrade on the production server. This should be done manually via SSH:

```bash
ssh root@46.202.155.16
# Check current version
node --version

# Install Node.js 22 LTS (using NodeSource)
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt-get install -y nodejs

# Verify
node --version  # Should report v22.x

# Deploy new code
cd /home/sportlink && git pull

# Rebuild native modules (better-sqlite3)
npm install

# Test a pipeline
scripts/sync.sh people --verbose
```
  </what-built>
  <how-to-verify>
1. Deploy the code changes: `git push` then `ssh root@46.202.155.16 "cd /home/sportlink && git pull && npm install"`
2. Upgrade Node.js on server to v22 if not already done
3. Verify `node --version` shows v22.x on the server
4. Run `node lib/dashboard-db.js` on the server — should create `data/dashboard.sqlite`
5. Run `scripts/sync.sh people` on the server — should complete successfully with no regressions
6. Verify WAL mode is active: `node -e "const db = require('./lib/laposta-db').openDb(); console.log(db.pragma('journal_mode'))"` on the server
  </how-to-verify>
  <resume-signal>Type "approved" when Node.js 22 is installed and pipelines verified, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. All 5 existing db modules have `db.pragma('journal_mode = WAL')` and `db.pragma('busy_timeout = 5000')` in openDb()
2. `lib/dashboard-db.js` exists and creates 3 tables with club_slug columns
3. `node lib/dashboard-db.js` runs without errors
4. No changes to any pipeline logic, step scripts, or tools
5. On production server: `node --version` reports v22.x and `scripts/sync.sh people` completes successfully
</verification>

<success_criteria>
- `node --version` on production server reports v22.x (INFRA-01)
- Every SQLite database opens in WAL mode with busy_timeout (INFRA-02)
- `dashboard.sqlite` exists with `runs`, `run_steps`, `run_errors` tables, all with `club_slug` (INFRA-03, MULTI-01)
- All cron pipelines continue to work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/34-infrastructure-foundation/34-01-SUMMARY.md`
</output>
