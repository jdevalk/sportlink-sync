---
phase: 01-summary-output
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - submit-laposta-list.js
  - sync-all.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running npm run sync-all produces a concise summary (not verbose progress)"
    - "Summary shows timestamp, duration, and grand totals at top"
    - "Summary shows per-list breakdown with added/updated/error counts"
    - "Errors are grouped in dedicated section at end (if any)"
    - "Output goes to both stdout and dated log file"
    - "--verbose flag shows per-member progress"
  artifacts:
    - path: "submit-laposta-list.js"
      provides: "Laposta submission with exportable main function and stats tracking"
      exports: ["runSubmit"]
    - path: "sync-all.js"
      provides: "Orchestrator that runs full sync and produces summary"
      exports: ["runSyncAll"]
    - path: "package.json"
      provides: "Updated sync-all script pointing to orchestrator"
      contains: "sync-all.js"
  key_links:
    - from: "sync-all.js"
      to: "lib/logger.js"
      via: "createSyncLogger import"
      pattern: "require.*lib/logger"
    - from: "sync-all.js"
      to: "download-data-from-sportlink.js"
      via: "runDownload import"
      pattern: "require.*download.*runDownload"
    - from: "sync-all.js"
      to: "prepare-laposta-members.js"
      via: "runPrepare import"
      pattern: "require.*prepare.*runPrepare"
    - from: "sync-all.js"
      to: "submit-laposta-list.js"
      via: "runSubmit import"
      pattern: "require.*submit.*runSubmit"
---

<objective>
Create summary orchestrator that produces clean, email-ready sync reports.

Purpose: Replace verbose per-member progress with concise summary output showing totals, per-list breakdown, duration, and grouped errors - suitable for cron email delivery.

Output: Refactored submit script, new sync-all.js orchestrator, updated package.json.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-summary-output/01-CONTEXT.md
@.planning/phases/01-summary-output/01-RESEARCH.md
@.planning/phases/01-summary-output/01-01-SUMMARY.md

@submit-laposta-list.js
@lib/logger.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modularize submit script with stats tracking</name>
  <files>submit-laposta-list.js</files>
  <action>
Refactor `submit-laposta-list.js` to:

1. **Export runSubmit function**:
   ```javascript
   async function runSubmit(options = {}) {
     // options.logger - logger instance
     // options.verbose - verbose mode (show per-member progress)
     // options.force - sync all members, not just changed
     // options.listIndex - specific list (1-4) or null for all
     // Returns: {
     //   success: boolean,
     //   lists: [{
     //     index: 1,
     //     listId: 'abc123',
     //     total: N,
     //     synced: M,
     //     errors: [{ email: '...', message: '...' }]
     //   }, ...],
     //   error?: string
     // }
   }
   module.exports = { runSubmit };
   ```

2. **Replace progress logging**:
   - Remove: `console.log(\`Progress list ${listIndex}: ${i + 1}/${members.length}\`)`
   - In verbose mode only: `logger.verbose(\`Syncing ${i + 1}/${members.length}: ${member.email}\`)`
   - Remove: `console.log('Submitting members one by one...')`

3. **Track stats per list**:
   - Count total members attempted
   - Count successful syncs
   - Collect errors with email + message (not full stack trace)

4. **Remove file-based error output**: Don't write `laposta-submit-errors-listN.json` - errors go in return value

5. **Keep CLI compatibility**: Same pattern as other scripts.

6. **Handle skipped lists gracefully**: If LAPOSTA_LIST env var not set, include in results with total: 0, synced: 0
  </action>
  <verify>
Test both modes:
1. CLI: `node submit-laposta-list.js` runs (may show "No changes" if nothing to sync)
2. CLI verbose: `node submit-laposta-list.js --verbose` shows per-member progress
3. Module:
   ```javascript
   const { runSubmit } = require('./submit-laposta-list');
   runSubmit({ verbose: false }).then(r => console.log(JSON.stringify(r, null, 2)));
   // Should return { success: true, lists: [...] }
   ```
  </verify>
  <done>Submit script exports runSubmit(), tracks per-list stats, suppresses verbose output by default</done>
</task>

<task type="auto">
  <name>Task 2: Create sync-all orchestrator with summary output</name>
  <files>sync-all.js</files>
  <action>
Create `sync-all.js` orchestrator that:

1. **Parse CLI args**:
   - `--verbose`: Enable detailed per-member output
   - `--force`: Sync all members (pass to submit)

2. **Create shared logger**: Use createSyncLogger from lib/logger.js

3. **Run pipeline sequentially**:
   ```javascript
   const downloadResult = await runDownload({ logger, verbose });
   const prepareResult = await runPrepare({ logger, verbose });
   const submitResult = await runSubmit({ logger, verbose, force });
   ```

4. **Produce summary output** (format per CONTEXT.md):
   ```
   ========================================
   SPORTLINK SYNC SUMMARY
   ========================================

   Completed: 2026-01-24 10:30:45
   Duration: 2m 34s

   TOTALS
   ----------------------------------------
   Members downloaded: 342
   Members prepared: 342 (4 excluded as duplicates)
   Members synced: 28 (12 added, 16 updated)
   Errors: 2

   PER-LIST BREAKDOWN
   ----------------------------------------
   List 1: 120 members, 8 synced (3 added, 5 updated)
   List 2: 98 members, 12 synced (5 added, 7 updated)
   List 3: 74 members, 5 synced (2 added, 3 updated)
   List 4: 50 members, 3 synced (2 added, 1 updated)

   ERRORS (2)
   ----------------------------------------
   - john@example.com: Invalid email format
   - jane@test.org: API rate limit exceeded

   ========================================
   ```

5. **Handle partial failures**: If download fails, report and exit. If prepare fails, report and exit. If submit has errors, include in summary but don't fail overall.

6. **Export runSyncAll**: For potential future use (though primary use is CLI)

7. **Close logger on exit**: Call logger.close() to flush file stream

Summary format notes:
- Show all 4 lists even if they have 0 members or no changes
- "X synced (Y added, Z updated)" - added = was new, updated = had changes
- Errors section only appears if there are errors
- Use plain text dividers (no markdown, no color codes)
  </action>
  <verify>
Run full sync and verify output:
```bash
node sync-all.js
```
Expected:
- Summary appears on stdout (not verbose progress)
- Same summary written to `logs/sync-YYYY-MM-DD.log`
- Format matches specification above

Test verbose mode:
```bash
node sync-all.js --verbose
```
Expected:
- Per-member progress shown during submit phase
- Summary still appears at end
  </verify>
  <done>Orchestrator produces concise summary with totals, per-list breakdown, and grouped errors</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json scripts</name>
  <files>package.json</files>
  <action>
Update package.json scripts section:

1. **Change sync-all**: Point to new orchestrator instead of chained commands
   ```json
   "sync-all": "node sync-all.js"
   ```

2. **Add sync-all-verbose**: Convenience script for detailed output
   ```json
   "sync-all-verbose": "node sync-all.js --verbose"
   ```

3. **Keep individual scripts**: download, prepare-laposta, sync-laposta remain for manual use

Result should be:
```json
"scripts": {
  "download": "node download-data-from-sportlink.js",
  "prepare-laposta": "node prepare-laposta-members.js",
  "submit-laposta": "node submit-laposta-list.js",
  "sync-laposta": "node submit-laposta-list.js",
  "dedupe-laposta": "node dedupe-laposta-list.js",
  "sync-all": "node sync-all.js",
  "sync-all-verbose": "node sync-all.js --verbose",
  "show-laposta-member": "node show-laposta-member.js",
  "show-sportlink-member": "node show-sportlink-member.js",
  "show-laposta-changes": "node show-laposta-changes.js"
}
```
  </action>
  <verify>
Test that npm scripts work:
```bash
npm run sync-all
# Should produce summary output

npm run sync-all-verbose
# Should produce detailed output with summary at end
```
  </verify>
  <done>package.json updated with sync-all pointing to orchestrator</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run sync-all` produces clean summary (not verbose progress)
2. Summary includes: timestamp, duration, totals, per-list breakdown
3. Errors grouped at end (only if errors exist)
4. Output appears in both terminal and `logs/sync-YYYY-MM-DD.log`
5. `npm run sync-all-verbose` shows per-member progress
6. Individual scripts (`npm run download`, etc.) still work
</verification>

<success_criteria>
- `npm run sync-all` produces email-ready summary output
- Summary shows timestamp, duration, member counts, sync counts, error counts
- Per-list breakdown shows all 4 lists with their stats
- Errors section appears only when there are errors, shows email + message
- Log file created with same content as terminal output
- `--verbose` flag enables per-member progress during sync
- Requirements OUT-01, OUT-02, OUT-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-summary-output/01-02-SUMMARY.md`
</output>
