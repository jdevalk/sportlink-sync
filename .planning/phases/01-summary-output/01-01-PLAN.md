---
phase: 01-summary-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/logger.js
  - download-data-from-sportlink.js
  - prepare-laposta-members.js
autonomous: true

must_haves:
  truths:
    - "Logger writes to both stdout and log file simultaneously"
    - "Log files are created in logs/ directory with date-based naming"
    - "Verbose flag controls output detail level"
    - "Download and prepare scripts can be imported as modules"
  artifacts:
    - path: "lib/logger.js"
      provides: "Dual-stream logger with verbosity control and timing"
      exports: ["createLogger", "createSyncLogger"]
    - path: "download-data-from-sportlink.js"
      provides: "Sportlink download with exportable main function"
      exports: ["runDownload"]
    - path: "prepare-laposta-members.js"
      provides: "Laposta preparation with exportable main function"
      exports: ["runPrepare"]
  key_links:
    - from: "lib/logger.js"
      to: "node:fs"
      via: "createWriteStream for log file"
      pattern: "fs\\.createWriteStream"
    - from: "lib/logger.js"
      to: "node:perf_hooks"
      via: "performance.now for timing"
      pattern: "performance\\.now"
---

<objective>
Create logging infrastructure and modularize download/prepare scripts for summary output.

Purpose: Establish foundation for unified summary reporting by creating a shared logger module and making existing scripts importable as functions (not just CLI executables).

Output: Logger module in lib/, updated download and prepare scripts that export their main functions while remaining CLI-compatible.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-summary-output/01-CONTEXT.md
@.planning/phases/01-summary-output/01-RESEARCH.md

@download-data-from-sportlink.js
@prepare-laposta-members.js
@laposta-db.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dual-stream logger module</name>
  <files>lib/logger.js</files>
  <action>
Create `lib/logger.js` with the following capabilities:

1. **Directory setup**: Create `logs/` directory if it doesn't exist (use fs.mkdirSync with recursive:true)

2. **createSyncLogger(options)** factory function:
   - `options.verbose` (boolean, default false): Controls detail level
   - `options.logFile` (string, optional): Override log file path, defaults to `logs/sync-YYYY-MM-DD.log`
   - Returns logger object with methods:
     - `log(...args)`: Always outputs (summary-level)
     - `verbose(...args)`: Only outputs if verbose mode enabled
     - `error(...args)`: Always outputs, prefixed for visibility
     - `section(title)`: Outputs section divider (e.g., "========== TITLE ==========")
     - `startTimer()`: Returns timer ID, starts timing
     - `endTimer(id)`: Returns duration in seconds (one decimal)
     - `close()`: Closes file stream (call on exit)

3. **Dual output**: Use native Console class with two streams:
   - stdout for terminal
   - fs.createWriteStream for log file (append mode)

4. **Stream error handling**: Attach error handler to write stream, log warning if disk write fails

5. **Process exit handler**: Register process.on('exit') to ensure stream is closed

Use ISO 8601 timestamps in log file names: `sync-2026-01-24.log`
  </action>
  <verify>
Create a test script that:
```javascript
const { createSyncLogger } = require('./lib/logger');
const logger = createSyncLogger({ verbose: true });
logger.section('TEST');
logger.log('Always visible');
logger.verbose('Only in verbose mode');
const t = logger.startTimer();
setTimeout(() => {
  logger.log('Duration:', logger.endTimer(t), 'seconds');
  logger.close();
}, 100);
```
Run it and verify:
- Output appears in terminal
- Log file created in `logs/` with today's date
- Both contain same content
  </verify>
  <done>Logger module exists, creates dated log files, supports verbose flag, provides timing utilities</done>
</task>

<task type="auto">
  <name>Task 2: Modularize download script</name>
  <files>download-data-from-sportlink.js</files>
  <action>
Refactor `download-data-from-sportlink.js` to:

1. **Export runDownload function**:
   ```javascript
   async function runDownload(options = {}) {
     // options.logger - optional logger instance
     // options.verbose - verbose mode (creates logger if not provided)
     // Returns: { success: boolean, memberCount: number, error?: string }
   }
   module.exports = { runDownload };
   ```

2. **Accept logger parameter**: If options.logger provided, use it. Otherwise create internal logger or use console.

3. **Return stats object**: Return member count from the JSON response (jsonData.Members.length or 0)

4. **Keep CLI compatibility**: At bottom of file, detect if run directly:
   ```javascript
   if (require.main === module) {
     const verbose = process.argv.includes('--verbose');
     runDownload({ verbose })
       .then(result => {
         if (!result.success) process.exitCode = 1;
       })
       .catch(err => {
         console.error('Error:', err.message);
         process.exitCode = 1;
       });
   }
   ```

5. **Replace console.log calls**:
   - `logDebug(...)` stays as-is (already conditional)
   - `console.log('Results JSON saved to SQLite.')` -> `logger.log('Downloaded X members from Sportlink')`

6. **Error handling**: Catch errors and return { success: false, error: message } instead of throwing
  </action>
  <verify>
Test both modes:
1. CLI: `node download-data-from-sportlink.js` works as before
2. Module:
   ```javascript
   const { runDownload } = require('./download-data-from-sportlink');
   runDownload({ verbose: false }).then(console.log);
   // Should return { success: true, memberCount: N }
   ```
  </verify>
  <done>Download script exports runDownload(), returns stats, remains CLI-compatible</done>
</task>

<task type="auto">
  <name>Task 3: Modularize prepare script</name>
  <files>prepare-laposta-members.js</files>
  <action>
Refactor `prepare-laposta-members.js` to:

1. **Export runPrepare function**:
   ```javascript
   async function runPrepare(options = {}) {
     // options.logger - optional logger instance
     // options.verbose - verbose mode
     // Returns: {
     //   success: boolean,
     //   lists: [{ index: 1, total: N, updates: M }, ...],
     //   excluded: number,
     //   error?: string
     // }
   }
   module.exports = { runPrepare };
   ```

2. **Accept logger parameter**: Use provided logger or fall back to console.

3. **Return stats object**: Collect the per-list counts that are currently logged:
   - `listMembers[index].length` -> total
   - `updateCounts[index]` -> updates
   - `excludedDueToDuplication` -> excluded

4. **Keep CLI compatibility**: Same pattern as download script.

5. **Replace console.log calls**:
   - Remove per-list `console.log(Prepared X members...)` - this will be in summary
   - Keep data for return value
   - `console.error` for excluded members stays (but use logger.error if available)

6. **Error handling**: Return { success: false, error: message } on failure
  </action>
  <verify>
Test both modes:
1. CLI: `node prepare-laposta-members.js` runs without verbose output (just returns)
2. Module:
   ```javascript
   const { runPrepare } = require('./prepare-laposta-members');
   runPrepare({ verbose: false }).then(console.log);
   // Should return { success: true, lists: [...], excluded: N }
   ```
  </verify>
  <done>Prepare script exports runPrepare(), returns per-list stats, remains CLI-compatible</done>
</task>

</tasks>

<verification>
After all tasks:
1. `lib/logger.js` exists and exports createSyncLogger
2. `logs/` directory is created on first logger use
3. Both scripts export their main functions
4. Both scripts still work from CLI: `npm run download`, `npm run prepare-laposta`
5. No verbose progress output in default mode
</verification>

<success_criteria>
- Logger module provides dual-stream output with verbosity control
- Download script exports runDownload() returning { success, memberCount }
- Prepare script exports runPrepare() returning { success, lists[], excluded }
- CLI commands `npm run download` and `npm run prepare-laposta` still work
- Log file created in `logs/sync-YYYY-MM-DD.log` when logger used
</success_criteria>

<output>
After completion, create `.planning/phases/01-summary-output/01-01-SUMMARY.md`
</output>
