---
phase: 23-contact-fields-reverse-sync
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - sync-people.js
  - lib/reverse-sync-sportlink.js
  - lib/stadion-db.js
autonomous: true

must_haves:
  truths:
    - "Reverse sync runs as part of people sync pipeline"
    - "Email report includes reverse sync section with summary statistics"
    - "No email noise when no changes to sync"
    - "Verbose mode shows field-level detail controlled by REVERSE_SYNC_DETAIL env var"
    - "Sportlink timestamps updated after successful sync to prevent loop"
  artifacts:
    - path: "sync-people.js"
      provides: "Integrated reverse sync step in people pipeline"
      contains: "REVERSE SYNC"
    - path: "lib/reverse-sync-sportlink.js"
      provides: "Timestamp update after successful sync"
      contains: "sportlink_modified"
  key_links:
    - from: "sync-people.js"
      to: "lib/reverse-sync-sportlink.js"
      via: "runReverseSync import and call"
      pattern: "runReverseSync"
    - from: "lib/reverse-sync-sportlink.js"
      to: "lib/stadion-db.js"
      via: "updateSportlinkTimestamp after sync"
      pattern: "sportlink_modified"
---

<objective>
Integrate reverse sync into the people pipeline and add email report section for visibility.

Purpose: Make reverse sync operational within the existing sync infrastructure with proper reporting.
Output: People sync includes reverse sync step with statistics in email report.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-contact-fields-reverse-sync/23-01-PLAN.md

# Key source files
@sync-people.js
@lib/reverse-sync-sportlink.js
@lib/stadion-db.js
@lib/sync-origin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sportlink timestamp update after successful sync</name>
  <files>lib/reverse-sync-sportlink.js, lib/stadion-db.js</files>
  <action>
After successfully syncing a member's contact fields to Sportlink, update the per-field Sportlink timestamps in stadion_members to prevent sync loops.

In lib/stadion-db.js, add helper function:

```javascript
/**
 * Update Sportlink modification timestamps for fields after reverse sync.
 * This prevents the same values from being detected as changes again.
 * @param {Object} db - Database connection
 * @param {string} knvbId - Member KNVB ID
 * @param {string[]} fieldNames - Array of field names that were synced
 */
function updateSportlinkTimestamps(db, knvbId, fieldNames) {
  const now = new Date().toISOString();
  const { SYNC_ORIGIN } = require('./sync-origin');

  // Build dynamic SET clause for specified fields
  const setClauses = fieldNames.map(field => `${field}_sportlink_modified = ?`).join(', ');
  const values = fieldNames.map(() => now);

  const sql = `
    UPDATE stadion_members
    SET ${setClauses}, sync_origin = ?
    WHERE knvb_id = ?
  `;

  const stmt = db.prepare(sql);
  stmt.run(...values, SYNC_ORIGIN.SYNC_REVERSE, knvbId);
}
```

Export updateSportlinkTimestamps.

In lib/reverse-sync-sportlink.js, after successful sync in runReverseSync:

```javascript
// After successful sync
if (result.success) {
  const syncedFields = fieldChanges.map(c => c.field_name);
  markChangesSynced(db, knvbId, syncedFields);
  updateSportlinkTimestamps(db, knvbId, syncedFields);
  logger?.verbose(`Updated Sportlink timestamps for ${knvbId}: ${syncedFields.join(', ')}`);
}
```
  </action>
  <verify>Run `node -e "const db = require('./lib/stadion-db'); console.log('updateSportlinkTimestamps:', typeof db.updateSportlinkTimestamps);"` - should output "function"</verify>
  <done>Sportlink timestamps are updated after successful reverse sync, sync_origin set to SYNC_REVERSE</done>
</task>

<task type="auto">
  <name>Task 2: Integrate reverse sync into people pipeline with email reporting</name>
  <files>sync-people.js</files>
  <action>
Add reverse sync as Step 8 in the people sync pipeline with email report integration.

1. Add import at top of file:
```javascript
const { runReverseSync } = require('./lib/reverse-sync-sportlink');
```

2. Add to stats object (after photos):
```javascript
reverseSync: {
  synced: 0,
  failed: 0,
  errors: []
}
```

3. Add Step 8 after photo sync (before "Complete"):
```javascript
// Step 8: Reverse Sync (Stadion -> Sportlink)
logger.verbose('Running reverse sync (Stadion -> Sportlink)...');
try {
  const reverseSyncResult = await runReverseSync({ logger, verbose });

  stats.reverseSync.synced = reverseSyncResult.synced;
  stats.reverseSync.failed = reverseSyncResult.failed;

  if (reverseSyncResult.results) {
    // Add field-level detail to errors for failed syncs
    for (const result of reverseSyncResult.results) {
      if (!result.success) {
        stats.reverseSync.errors.push({
          knvb_id: result.knvb_id,
          message: result.error || 'Sync failed',
          system: 'reverse-sync'
        });
      }
    }
  }
} catch (err) {
  logger.error(`Reverse sync failed: ${err.message}`);
  stats.reverseSync.errors.push({
    message: `Reverse sync failed: ${err.message}`,
    system: 'reverse-sync'
  });
}
```

4. Add to printSummary after PHOTO SYNC section:
```javascript
// Only show reverse sync section if there were changes or failures
if (stats.reverseSync.synced > 0 || stats.reverseSync.failed > 0) {
  logger.log('REVERSE SYNC (STADION -> SPORTLINK)');
  logger.log(minorDivider);
  logger.log(`Contact fields synced: ${stats.reverseSync.synced} members`);
  if (stats.reverseSync.failed > 0) {
    logger.log(`Failed: ${stats.reverseSync.failed} members`);
  }

  // Optional: field-level detail if REVERSE_SYNC_DETAIL=detailed
  const detailLevel = process.env.REVERSE_SYNC_DETAIL || 'summary';
  if (detailLevel === 'detailed' && stats.reverseSync.results) {
    for (const result of stats.reverseSync.results) {
      if (result.success && result.changes) {
        logger.log(`  ${result.knvb_id}:`);
        for (const change of result.changes) {
          logger.log(`    - ${change.field_name}: "${change.old_value}" -> "${change.new_value}"`);
        }
      }
    }
  }
  logger.log('');
}
```

5. Add reverseSync.errors to allErrors collection:
```javascript
const allErrors = [
  ...stats.errors,
  ...stats.stadion.errors,
  ...stats.birthdays.errors,
  ...stats.photos.errors,
  ...stats.reverseSync.errors  // Add this line
];
```

6. Update success check to include reverse sync:
```javascript
return {
  success: stats.errors.length === 0 &&
           stats.stadion.errors.length === 0 &&
           stats.birthdays.errors.length === 0 &&
           stats.photos.errors.length === 0 &&
           stats.reverseSync.errors.length === 0,  // Add this line
  stats
};
```
  </action>
  <verify>Run `grep -c "REVERSE SYNC" sync-people.js` - should return at least 1 (the section header)</verify>
  <done>People sync pipeline includes reverse sync step with summary in email report, no output when nothing synced</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Database function test:
```bash
node -e "
  const db = require('./lib/stadion-db');
  console.log('updateSportlinkTimestamps exists:', typeof db.updateSportlinkTimestamps === 'function');
"
```

2. Pipeline integration test:
```bash
grep -n "runReverseSync" sync-people.js
grep -n "reverseSync" sync-people.js | head -5
```

3. Email section test:
```bash
grep "REVERSE SYNC" sync-people.js
```

4. Verify stats integration:
```bash
grep "reverseSync.errors" sync-people.js
```
</verification>

<success_criteria>
- [ ] updateSportlinkTimestamps function exists and updates per-field Sportlink timestamps
- [ ] sync_origin set to SYNC_REVERSE after successful reverse sync
- [ ] sync-people.js imports and calls runReverseSync
- [ ] stats.reverseSync tracks synced/failed counts and errors
- [ ] Email report shows REVERSE SYNC section only when there are changes
- [ ] REVERSE_SYNC_DETAIL env var controls field-level output (summary default)
- [ ] Reverse sync failures included in allErrors collection
- [ ] Overall success includes reverseSync.errors.length === 0
</success_criteria>

<output>
After completion, create `.planning/phases/23-contact-fields-reverse-sync/23-02-SUMMARY.md`
</output>
