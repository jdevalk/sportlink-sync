---
phase: 06-member-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prepare-stadion-members.js
autonomous: true

must_haves:
  truths:
    - "Sportlink members are transformed to Stadion person format"
    - "Name fields handle Dutch tussenvoegsel correctly"
    - "Contact info is structured as array for ACF repeater"
    - "Address fields are mapped to structured addresses array"
    - "Gender codes are mapped (Male->M, Female->F)"
    - "Birth date is stored for Important Dates"
  artifacts:
    - path: "prepare-stadion-members.js"
      provides: "Sportlink to Stadion data transformation"
      exports: ["runPrepare"]
  key_links:
    - from: "prepare-stadion-members.js"
      to: "laposta-db.js"
      via: "getLatestSportlinkResults"
      pattern: "getLatestSportlinkResults"
---

<objective>
Create Stadion member preparation script that transforms Sportlink data to Stadion person format.

Purpose: Map all required fields from Sportlink members to Stadion WordPress person records, handling Dutch naming conventions and structuring data for ACF repeater fields.

Output: `prepare-stadion-members.js` that reads Sportlink data and produces Stadion-ready member objects.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-member-sync/06-CONTEXT.md
@.planning/phases/06-member-sync/06-RESEARCH.md
@prepare-laposta-members.js
@laposta-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prepare-stadion-members.js with field mapping</name>
  <files>prepare-stadion-members.js</files>
  <action>
Create `prepare-stadion-members.js` following the pattern from `prepare-laposta-members.js`:

1. **Module setup:**
   - Use varlock/auto-load for env loading
   - Import getLatestSportlinkResults from laposta-db.js (reuse existing function)
   - Module/CLI hybrid pattern (exports runPrepare, CLI entry point)

2. **Field mapping functions:**

   ```javascript
   function mapGender(sportlinkGender) {
     const mapping = { 'Male': 'M', 'Female': 'F' };
     return mapping[sportlinkGender] || '';
   }

   function buildName(member) {
     // Merge tussenvoegsel into last name per CONTEXT.md decision
     const firstName = (member.FirstName || '').trim();
     const infix = (member.Infix || '').trim();
     const lastName = (member.LastName || '').trim();
     const fullLastName = [infix, lastName].filter(Boolean).join(' ');
     return {
       first_name: firstName,
       last_name: fullLastName
     };
   }

   function buildContactInfo(member) {
     const contacts = [];
     if (member.Email) contacts.push({ type: 'email', value: member.Email.trim() });
     if (member.Mobile) contacts.push({ type: 'mobile', value: member.Mobile.trim() });
     if (member.Telephone) contacts.push({ type: 'phone', value: member.Telephone.trim() });
     return contacts;
   }

   function buildAddresses(member) {
     if (!member.StreetName && !member.City) return [];
     return [{
       street: (member.StreetName || '').trim(),
       number: (member.AddressNumber || '').toString().trim(),
       addition: (member.AddressNumberAppendix || '').trim(),
       postal_code: (member.ZipCode || '').trim(),
       city: (member.City || '').trim()
     }];
   }

   function buildImportantDates(member) {
     if (!member.DateOfBirth) return [];
     return [{ type: 'birth_date', date: member.DateOfBirth }];
   }
   ```

3. **Member preparation function:**
   ```javascript
   function preparePerson(sportlinkMember) {
     const name = buildName(sportlinkMember);
     const title = [name.first_name, name.last_name].filter(Boolean).join(' ');

     return {
       knvb_id: sportlinkMember.PublicPersonId, // relatiecode for matching
       email: (sportlinkMember.Email || '').trim().toLowerCase() || null,
       data: {
         title: title,
         status: 'publish',
         meta: {
           knvb_id: sportlinkMember.PublicPersonId,
           first_name: name.first_name,
           last_name: name.last_name,
           gender: mapGender(sportlinkMember.GenderCode)
         },
         acf: {
           contact_info: buildContactInfo(sportlinkMember),
           addresses: buildAddresses(sportlinkMember),
           important_dates: buildImportantDates(sportlinkMember)
         }
       }
     };
   }
   ```

4. **Validation - skip members missing required fields:**
   ```javascript
   function isValidMember(member) {
     // PublicPersonId (KNVB ID) is required for matching
     if (!member.PublicPersonId) return false;
     // Must have at least a name
     if (!member.FirstName && !member.LastName) return false;
     return true;
   }
   ```

5. **Main runPrepare function:**
   - Load Sportlink data from SQLite (getLatestSportlinkResults)
   - Filter out invalid members (log skipped)
   - Transform each member using preparePerson
   - Return: `{ success: boolean, members: Array, skipped: number, error?: string }`
   - NOTE: Do NOT write to stadion-db.js yet - that happens in submit phase
   - Just return the prepared member array for the sync script to use

6. **CLI entry point:**
   - Support --verbose flag
   - Print summary: total members, valid members, skipped members
   - Example output: "Prepared 150 members for Stadion sync (3 skipped - missing KNVB ID)"

7. **Empty field handling (per CONTEXT.md):**
   - Empty Sportlink fields should result in empty strings (not undefined/null)
   - This ensures Stadion fields get cleared when source data is removed
   - For repeater arrays, omit the item entirely if all fields empty
  </action>
  <verify>
1. Run `node --check prepare-stadion-members.js` - syntax valid
2. Run `node prepare-stadion-members.js --verbose` - should show preparation stats
3. Verify output structure by checking a sample member:
   ```javascript
   const { runPrepare } = require('./prepare-stadion-members');
   runPrepare({ verbose: true }).then(r => {
     if (r.members.length > 0) {
       console.log('Sample:', JSON.stringify(r.members[0], null, 2));
     }
   });
   ```
4. Confirm tussenvoegsel handling: "van de Berg" should become last_name: "van de Berg"
  </verify>
  <done>
- prepare-stadion-members.js exists and exports runPrepare
- Field mappings correct: name, contact_info, addresses, important_dates, gender
- Invalid members (no KNVB ID or no name) are skipped with warning
- Empty fields produce empty strings (not null/undefined)
- CLI shows preparation summary
  </done>
</task>

</tasks>

<verification>
1. Module loads without errors: `node -e "require('./prepare-stadion-members')"`
2. CLI runs: `node prepare-stadion-members.js`
3. Sample member has correct structure with meta and acf fields
4. Gender mapping: Male->M, Female->F, Unknown->''
5. Name handling: "Jan" + "van" + "Berg" -> first_name: "Jan", last_name: "van Berg"
</verification>

<success_criteria>
- prepare-stadion-members.js created with runPrepare export
- All field mappings implemented per CONTEXT.md decisions
- Invalid members skipped with logging
- Returns prepared members array ready for sync
</success_criteria>

<output>
After completion, create `.planning/phases/06-member-sync/06-02-SUMMARY.md`
</output>
