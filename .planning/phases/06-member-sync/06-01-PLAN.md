---
phase: 06-member-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stadion-db.js
autonomous: true

must_haves:
  truths:
    - "Stadion sync state is tracked in SQLite database"
    - "Hash-based change detection identifies members needing sync"
    - "Sync state updates after successful API operations"
  artifacts:
    - path: "lib/stadion-db.js"
      provides: "Stadion sync state tracking functions"
      exports: ["openDb", "computeSourceHash", "upsertMembers", "getMembersNeedingSync", "updateSyncState", "deleteMember"]
  key_links:
    - from: "lib/stadion-db.js"
      to: "better-sqlite3"
      via: "database operations"
      pattern: "new Database"
    - from: "lib/stadion-db.js"
      to: "crypto"
      via: "SHA-256 hashing"
      pattern: "createHash.*sha256"
---

<objective>
Create Stadion database module for hash-based change detection and sync state tracking.

Purpose: Enable efficient sync by only processing members whose data has changed since last sync, matching the proven pattern from Laposta sync.

Output: `lib/stadion-db.js` providing SQLite-based state tracking with hash computation and CRUD operations.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-member-sync/06-CONTEXT.md
@.planning/phases/06-member-sync/06-RESEARCH.md
@laposta-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stadion-db.js with hash-based change detection</name>
  <files>lib/stadion-db.js</files>
  <action>
Create `lib/stadion-db.js` following the pattern from `laposta-db.js`:

1. **Database setup:**
   - Use `better-sqlite3` (already in package.json)
   - Default path: `stadion-sync.sqlite` in project root
   - Create `stadion_members` table:
     ```sql
     CREATE TABLE IF NOT EXISTS stadion_members (
       id INTEGER PRIMARY KEY,
       knvb_id TEXT NOT NULL UNIQUE,
       stadion_id INTEGER,
       email TEXT,
       data_json TEXT NOT NULL,
       source_hash TEXT NOT NULL,
       last_seen_at TEXT NOT NULL,
       last_synced_at TEXT,
       last_synced_hash TEXT,
       created_at TEXT NOT NULL
     );
     CREATE INDEX IF NOT EXISTS idx_stadion_members_hash
       ON stadion_members (source_hash, last_synced_hash);
     CREATE INDEX IF NOT EXISTS idx_stadion_members_email
       ON stadion_members (email);
     ```

2. **Hash computation (copy from laposta-db.js):**
   - `stableStringify(value)` - Deterministic JSON serialization
   - `computeSourceHash(knvbId, data)` - SHA-256 hash of identifier + data
   - Use knvb_id as the stable identifier (not email, which can change)

3. **Database operations:**
   - `openDb(dbPath)` - Open/create database, initialize tables
   - `upsertMembers(db, members)` - Insert/update member records
     - Each member object: `{ knvb_id, email, data }` where data is the Stadion payload
     - ON CONFLICT(knvb_id) DO UPDATE for existing members
   - `getMembersNeedingSync(db, force)` - Get members where source_hash != last_synced_hash
     - If force=true, return all members
     - Return: `[{ knvb_id, email, data, source_hash, stadion_id }]`
   - `updateSyncState(db, knvbId, sourceHash, stadionId)` - Mark member as synced
     - Update last_synced_at, last_synced_hash, and stadion_id (if created)
   - `deleteMember(db, knvbId)` - Remove member from tracking table
   - `getMembersNotInList(db, knvbIds)` - Find tracked members not in provided list (for delete detection)

4. **Module exports:**
   - Export: `openDb`, `computeSourceHash`, `stableStringify`, `upsertMembers`, `getMembersNeedingSync`, `updateSyncState`, `deleteMember`, `getMembersNotInList`, `DEFAULT_DB_PATH`

Key differences from laposta-db.js:
- Uses knvb_id as primary key (not email)
- Tracks stadion_id (WordPress post ID) for updates/deletes
- No list_index concept (single Stadion destination)
- Simpler schema (no field caching needed)
  </action>
  <verify>
1. Run `node --check lib/stadion-db.js` - syntax valid
2. Run quick test in Node REPL:
   ```javascript
   const { openDb, computeSourceHash } = require('./lib/stadion-db');
   const db = openDb();
   console.log('Tables:', db.prepare("SELECT name FROM sqlite_master WHERE type='table'").all());
   console.log('Hash:', computeSourceHash('TEST123', { name: 'Test' }));
   db.close();
   ```
3. Verify stadion-sync.sqlite created in project root
  </verify>
  <done>
- lib/stadion-db.js exists and exports all required functions
- Database file created with stadion_members table
- Hash computation produces consistent SHA-256 hashes
- getMembersNeedingSync returns empty array initially
  </done>
</task>

</tasks>

<verification>
1. Module loads without errors: `node -e "require('./lib/stadion-db')"`
2. Exports include: openDb, computeSourceHash, upsertMembers, getMembersNeedingSync, updateSyncState, deleteMember, getMembersNotInList
3. Hash is deterministic: same input produces same hash
4. Database schema matches specification
</verification>

<success_criteria>
- lib/stadion-db.js created with all exported functions
- SQLite database initializes with correct schema
- Hash computation is deterministic and stable
- CRUD operations work correctly with knvb_id as primary key
</success_criteria>

<output>
After completion, create `.planning/phases/06-member-sync/06-01-SUMMARY.md`
</output>
