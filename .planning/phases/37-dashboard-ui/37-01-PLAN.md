---
phase: 37-dashboard-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/dashboard-queries.js
  - lib/web-server.js
  - views/layout.ejs
  - views/overview.ejs
  - views/run-history.ejs
  - views/run-detail.ejs
  - public/style.css
autonomous: true

must_haves:
  truths:
    - "Pipeline overview page shows traffic-light status (green/yellow/red) for all 6 pipelines"
    - "Each pipeline shows last run time, outcome, and key counts (created, updated, failed)"
    - "Overdue pipelines are visually flagged based on their cron schedule"
    - "User can click a pipeline to see paginated run history"
    - "User can click a run to see per-step breakdown with counts"
    - "All pages use server-rendered HTML via EJS templates (no SPA, no build step)"
  artifacts:
    - path: "lib/dashboard-queries.js"
      provides: "All SQL queries for dashboard data"
      exports: ["getPipelineOverview", "getRunHistory", "getRunDetail"]
    - path: "views/layout.ejs"
      provides: "Shared HTML layout with header, nav, logout"
    - path: "views/overview.ejs"
      provides: "Pipeline overview grid with traffic-light cards"
    - path: "views/run-history.ejs"
      provides: "Paginated run history table for a pipeline"
    - path: "views/run-detail.ejs"
      provides: "Run detail with step breakdown table"
  key_links:
    - from: "lib/web-server.js"
      to: "lib/dashboard-queries.js"
      via: "require and call in route handlers"
      pattern: "require.*dashboard-queries"
    - from: "lib/web-server.js"
      to: "views/*.ejs"
      via: "reply.view() in route handlers"
      pattern: "reply\\.view\\("
    - from: "views/overview.ejs"
      to: "/pipeline/:name"
      via: "href links on pipeline cards"
      pattern: "href.*pipeline"
    - from: "views/run-history.ejs"
      to: "/run/:id"
      via: "href links on run rows"
      pattern: "href.*run"
---

<objective>
Build the pipeline overview page, run history page, and run detail page for the dashboard.

Purpose: Operators need to monitor all 6 pipeline activities at a glance and drill into individual runs to see per-step breakdown with counts -- replacing SSH access as the primary monitoring tool.

Output: Three functional dashboard pages served via EJS templates with a shared layout, backed by a data query module that reads from the dashboard SQLite database.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/web-server.js
@lib/dashboard-db.js
@lib/run-tracker.js
@lib/auth.js
@views/login.ejs
@public/style.css
@scripts/install-cron.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard queries module and pipeline overview page</name>
  <files>
    lib/dashboard-queries.js
    views/layout.ejs
    views/overview.ejs
    public/style.css
    lib/web-server.js
  </files>
  <action>
**1. Create `lib/dashboard-queries.js`** - A module that exports query functions using better-sqlite3. Import `openDb` from `./dashboard-db`. Open a shared db connection lazily (open on first call, reuse). Export these functions:

- `getPipelineOverview()` - For each of the 6 primary pipelines (`people`, `nikki`, `freescout`, `teams`, `functions`, `discipline`), return the latest run (outcome, started_at, finished_at, duration_ms, total_created, total_updated, total_skipped, total_failed). Query: `SELECT * FROM runs WHERE pipeline = ? AND club_slug = 'rondo' ORDER BY started_at DESC LIMIT 1` for each pipeline. Also compute `isOverdue` for each pipeline by comparing last run's `started_at` against the expected schedule. Use these cron intervals to determine overdue threshold (multiply by 1.5 for grace):
  - `people`: 3 hours (runs at 8,11,14,17 -- gap is 3h, so overdue if >4.5h since last run, but only during 8-17 window. Simplify: overdue if no run in last 4 hours)
  - `nikki`: 25 hours (daily)
  - `freescout`: 25 hours (daily)
  - `teams`: 8 days (weekly)
  - `functions`: 4 hours (runs at 7:30,10:30,13:30,16:30 -- similar to people)
  - `discipline`: 8 days (weekly)

- `getRunHistory(pipeline, page, perPage)` - Return paginated runs for a pipeline. `SELECT * FROM runs WHERE pipeline = ? AND club_slug = 'rondo' ORDER BY started_at DESC LIMIT ? OFFSET ?`. Also return total count for pagination.

- `getRunDetail(runId)` - Return the run row plus all its steps: `SELECT * FROM run_steps WHERE run_id = ? ORDER BY started_at ASC`. Also return error count: `SELECT COUNT(*) FROM run_errors WHERE run_id = ?`.

- `closeDb()` - Close the shared connection (for clean shutdown).

Follow the module/CLI hybrid pattern: export functions AND add `if (require.main === module)` that tests the queries.

**2. Create `views/layout.ejs`** - Shared EJS layout partial. Structure:

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= title %> - Rondo Sync</title>
  <link rel="stylesheet" href="/public/style.css">
</head>
<body>
  <div class="dashboard">
    <header>
      <h1><a href="/">Rondo Sync</a></h1>
      <nav>
        <a href="/" class="<%= page === 'overview' ? 'active' : '' %>">Overview</a>
        <a href="/errors" class="<%= page === 'errors' ? 'active' : '' %>">Errors</a>
      </nav>
      <div class="user-info">
        <span><%= user.displayName %></span>
        <form method="POST" action="/logout" style="display:inline">
          <button type="submit" class="btn-logout">Logout</button>
        </form>
      </div>
    </header>
    <main>
      <%- body %>
    </main>
  </div>
</body>
</html>
```

Note: Since @fastify/view with EJS does not support layout inheritance natively, use `<%- include('layout-head') %>` and `<%- include('layout-foot') %>` partials approach instead. Create `views/partials/header.ejs` and `views/partials/footer.ejs`. Each page template includes these at top and bottom. The header partial receives `title`, `page`, and `user` locals.

Actually, simpler approach: just have each page template be a full page that includes a shared header/footer partial. Create:
- `views/partials/head.ejs` - DOCTYPE through opening `<main>` tag (receives `title`, `page`, `user`)
- `views/partials/foot.ejs` - Closing `</main></div></body></html>`

**3. Create `views/overview.ejs`** - Pipeline overview page. Shows a grid of 6 pipeline cards. Each card has:
- Pipeline name (human-readable: "People", "Nikki", "FreeScout", "Teams", "Functions", "Discipline")
- Status indicator: green circle (success), red circle (failure), yellow circle (running), gray circle (never run)
- If overdue, show an orange "OVERDUE" badge
- Last run time as relative time (e.g., "2 hours ago") - compute in the route handler using a simple helper
- Key counts: "Created: X, Updated: Y, Failed: Z" (only show non-zero)
- Duration (formatted as "Xm Ys")
- The entire card is a link to `/pipeline/:name`

The pipeline name mapping: `{ people: 'People', nikki: 'Nikki', freescout: 'FreeScout', teams: 'Teams', functions: 'Functions', discipline: 'Discipline' }`

**4. Update `public/style.css`** - Add styles for:
- `.pipeline-grid` - CSS Grid, 3 columns on desktop, 2 on tablet, 1 on mobile
- `.pipeline-card` - White background, rounded corners, box-shadow, padding. Clickable (block link)
- `.pipeline-card:hover` - Subtle shadow increase
- `.status-indicator` - 12px circle inline before pipeline name
- `.status-success` (green #28a745), `.status-failure` (red #dc3545), `.status-running` (yellow #ffc107), `.status-unknown` (gray #6c757d)
- `.badge-overdue` - Orange (#fd7e14) small badge text
- `.pipeline-card .counts` - Smaller text, gray
- `.pipeline-card .last-run` - Smaller text, lighter gray
- Navigation styles: `.dashboard nav` inline links with active state
- `.dashboard header h1 a` - No text-decoration, inherit color

**5. Update `lib/web-server.js`** - Replace the inline HTML `GET /` route with:
- Import `dashboard-queries.js` at the top
- `GET /` route calls `getPipelineOverview()`, computes relative times using a helper function (inline in the route or in a small helper), and renders `overview.ejs` with `{ title: 'Dashboard', page: 'overview', user: request.session.user, pipelines: overviewData }`
- Add helper function `formatRelativeTime(isoString)` that returns "2 hours ago", "3 days ago", etc. Keep it simple: compute diff in seconds, then pick the right unit.
- Add helper function `formatDuration(ms)` that returns "1m 23s" or "45s" or "2h 5m".
- Pass these helpers to the template as locals so EJS can use them: `{ formatRelativeTime, formatDuration }`
- Register a `onClose` hook to call `closeDb()` from dashboard-queries for clean shutdown.

Ensure the `requireAuth` preHandler is on all new routes.
  </action>
  <verify>
    Run `node -e "require('./lib/dashboard-queries')"` to verify the module loads without errors.
    Run `node lib/dashboard-queries.js` to test the CLI self-test.
    Run `node -e "const {buildServer} = require('./lib/web-server'); buildServer().then(s => { console.log('OK'); s.close(); })"` to verify the server builds without errors.
    Verify views/partials/head.ejs and views/partials/foot.ejs exist.
    Verify views/overview.ejs exists and contains pipeline-grid class.
  </verify>
  <done>
    Pipeline overview page renders with traffic-light cards for all 6 pipelines. Each card shows status color, last run time (relative), key counts, and duration. Overdue pipelines show an orange badge. Cards link to /pipeline/:name. A shared layout wraps all dashboard pages with header navigation and logout button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run history and run detail pages</name>
  <files>
    lib/dashboard-queries.js
    views/run-history.ejs
    views/run-detail.ejs
    lib/web-server.js
    public/style.css
  </files>
  <action>
**1. Create `views/run-history.ejs`** - Paginated run history for a single pipeline. Structure:
- Include head/foot partials
- Breadcrumb: "Overview > People" (pipeline name)
- Pipeline name as h2
- Table with columns: Started, Duration, Outcome, Created, Updated, Skipped, Failed
- Each row links to `/run/:id`
- Outcome column shows colored text: green "success", red "failure", yellow "running"
- Started column shows formatted date/time (e.g., "Feb 9, 2026 14:00")
- Duration column uses `formatDuration` helper
- Pagination controls at bottom: "Previous" / "Next" with page numbers. Show "Page X of Y".
- If no runs, show "No runs recorded yet" message.

**2. Create `views/run-detail.ejs`** - Run detail with step breakdown. Structure:
- Include head/foot partials
- Breadcrumb: "Overview > People > Run #123"
- Run summary: started_at, finished_at, duration, outcome (with colored badge)
- Total counts row: Created: X, Updated: Y, Skipped: Z, Failed: F
- Steps table with columns: Step Name, Duration, Outcome, Created, Updated, Skipped, Failed
- Outcome column shows colored text like run-history
- If the run has errors (error count > 0), show a link: "View N errors" linking to `/errors?run_id=:id`
- If no steps, show "No step data recorded" message.

**3. Add routes to `lib/web-server.js`**:

- `GET /pipeline/:name` - Validates `:name` is one of the 6 known pipelines (respond 404 otherwise). Parses `?page=1` query param (default 1). Calls `getRunHistory(name, page, 20)`. Renders `run-history.ejs` with `{ title: 'Pipeline Name - Run History', page: 'overview', user, pipeline, runs, pagination }`. The `pagination` object: `{ current, total, perPage, totalRuns }`.

- `GET /run/:id` - Parses `:id` as integer. Calls `getRunDetail(id)`. If run not found, return 404. Renders `run-detail.ejs` with `{ title: 'Run #ID', page: 'overview', user, run, steps, errorCount, formatDuration }`.

Both routes use `{ preHandler: requireAuth }`.

**4. Add styles to `public/style.css`**:
- `.data-table` - Full width, border-collapse, striped rows (nth-child)
- `.data-table th` - Background #f8f9fa, padding 0.75rem, text-align left, border-bottom 2px solid #dee2e6
- `.data-table td` - Padding 0.75rem, border-bottom 1px solid #dee2e6
- `.data-table tr:hover` - Background #f5f5f5
- `.data-table a` - Color #007bff
- `.breadcrumb` - Font-size 0.9rem, margin-bottom 1rem, color #666
- `.breadcrumb a` - Color #007bff
- `.pagination` - Flex, justify-center, gap 0.5rem, margin-top 1.5rem
- `.pagination a, .pagination span` - Padding 0.5rem 0.75rem, border 1px solid #dee2e6, border-radius 4px
- `.pagination .active` - Background #007bff, color white
- `.outcome-success` - Color #28a745
- `.outcome-failure` - Color #dc3545, font-weight 600
- `.outcome-running` - Color #ffc107
- `.run-summary` - Background white, padding 1.5rem, border-radius 8px, margin-bottom 1.5rem, box-shadow
- `.run-summary .counts` - Display flex, gap 2rem, margin-top 0.75rem
- `.count-item` - Text-align center with label below number
- On mobile (<768px): `.data-table` horizontal scroll via overflow-x: auto on wrapper div, `.run-summary .counts` wraps to 2 columns
  </action>
  <verify>
    Run `node -e "const q = require('./lib/dashboard-queries'); console.log(typeof q.getRunHistory, typeof q.getRunDetail)"` to verify exports exist.
    Run `node -e "const {buildServer} = require('./lib/web-server'); buildServer().then(s => { s.inject({method:'GET',url:'/health'}).then(r => { console.log(r.statusCode); s.close(); }); })"` to verify server starts.
    Verify views/run-history.ejs exists and contains 'data-table' class.
    Verify views/run-detail.ejs exists and contains 'run-summary' class.
    Check that /pipeline/:name route exists in web-server.js.
    Check that /run/:id route exists in web-server.js.
  </verify>
  <done>
    Run history page shows paginated list of runs for a selected pipeline with outcome, counts, and duration. Run detail page shows per-step breakdown with counts. Breadcrumb navigation connects overview -> pipeline -> run. Pagination works with Previous/Next controls. Tables are styled with striped rows and hover states.
  </done>
</task>

</tasks>

<verification>
1. `node lib/dashboard-queries.js` runs without errors (CLI self-test)
2. `node -e "const {buildServer} = require('./lib/web-server'); buildServer().then(s => s.close())"` succeeds
3. All 6 view files exist: partials/head.ejs, partials/foot.ejs, overview.ejs, run-history.ejs, run-detail.ejs (plus login.ejs from Phase 36)
4. `public/style.css` contains pipeline-grid, data-table, pagination classes
5. Routes registered: GET /, GET /pipeline/:name, GET /run/:id (all with requireAuth)
</verification>

<success_criteria>
- Pipeline overview page renders traffic-light status for all 6 pipelines with last run time and key counts
- Overdue pipelines show orange visual flag
- Clicking a pipeline shows paginated run history
- Clicking a run shows per-step breakdown with counts
- All pages share consistent layout with navigation and logout
- All pages server-rendered with EJS (no client-side JS required for core functionality)
</success_criteria>

<output>
After completion, create `.planning/phases/37-dashboard-ui/37-01-SUMMARY.md`
</output>
