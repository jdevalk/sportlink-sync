---
phase: 45-photo-url-sync-to-freescout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - steps/prepare-freescout-customers.js
  - steps/submit-freescout-sync.js
autonomous: true

must_haves:
  truths:
    - "Members with photo_state='synced' get their Rondo Club photo URL sent as FreeScout customer photoUrl"
    - "Members without synced photos are skipped (no broken image URLs in FreeScout)"
    - "Photo URL changes trigger re-sync via existing hash-based change detection"
    - "Null/missing photoUrl is omitted from FreeScout API payload (not sent as null)"
  artifacts:
    - path: "steps/prepare-freescout-customers.js"
      provides: "Async getPhotoUrl() fetching from Rondo Club API with ?_embed"
      contains: "_embedded"
    - path: "steps/submit-freescout-sync.js"
      provides: "photoUrl included in create/update customer payloads"
      contains: "photoUrl"
  key_links:
    - from: "steps/prepare-freescout-customers.js"
      to: "lib/rondo-club-client.js"
      via: "rondoClubRequest with ?_embed parameter"
      pattern: "rondoClubRequest.*_embed"
    - from: "steps/prepare-freescout-customers.js"
      to: "steps/submit-freescout-sync.js"
      via: "photoUrl in customer.data passed through freescout-db hash detection"
      pattern: "photoUrl"
    - from: "steps/submit-freescout-sync.js"
      to: "FreeScout API"
      via: "photoUrl field in create/update customer payload"
      pattern: "customer\\.data\\.photoUrl"
---

<objective>
Enable member photos from Rondo Club to appear as FreeScout customer avatars by syncing photo URLs through the existing FreeScout sync pipeline.

Purpose: Support agents see member photos in FreeScout ticket views without switching to Rondo Club, improving identification and workflow efficiency.
Output: Modified prepare and submit steps that fetch photo URLs from Rondo Club API and include them in FreeScout customer payloads.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-photo-url-sync-to-freescout/45-RESEARCH.md

@steps/prepare-freescout-customers.js
@steps/submit-freescout-sync.js
@lib/rondo-club-client.js
@lib/freescout-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement async photo URL fetching in prepare step</name>
  <files>steps/prepare-freescout-customers.js</files>
  <action>
Modify `steps/prepare-freescout-customers.js` to fetch photo URLs from the Rondo Club WordPress API:

1. **Add import** at the top of the file:
   ```javascript
   const { rondoClubRequest } = require('../lib/rondo-club-client');
   ```

2. **Replace the stub `getPhotoUrl()` function** (lines 61-73) with an async version that queries the Rondo Club API:
   - Check `member.photo_state !== 'synced'` — return null if not synced
   - Check `member.rondo_club_id` exists — return null if no WordPress post
   - Call `rondoClubRequest(`wp/v2/people/${member.rondo_club_id}?_embed`, 'GET', null, options)`
   - Extract URL from `response.body?._embedded?.['wp:featuredmedia']?.[0]?.source_url`
   - Validate the URL starts with `https://` before returning
   - Return null on any error (graceful degradation)
   - Log photo URL fetching in verbose mode via `options.logger?.verbose` or similar

3. **Make `prepareCustomer()` async** (line 131):
   - Change `function prepareCustomer(member, freescoutDb, rondoClubDb, nikkiDb)` to `async function prepareCustomer(member, freescoutDb, rondoClubDb, nikkiDb, options)`
   - Add `options` as fifth parameter (needed for API calls in getPhotoUrl)
   - Change `getPhotoUrl(member)` call on line 223 to `await getPhotoUrl(member, options)`

4. **Update the `runPrepare()` loop** (around line 298):
   - Change `const customer = prepareCustomer(member, freescoutDb, rondoClubDb, nikkiDb);`
   to `const customer = await prepareCustomer(member, freescoutDb, rondoClubDb, nikkiDb, { logger, verbose });`

**Important considerations:**
- Only pass `options` with logger/verbose to getPhotoUrl — do NOT pass the full options from runPrepare since getPhotoUrl just needs logger access
- The `getPhotoUrl` function should construct a minimal options object: `{ logger: options.logger, verbose: options.verbose }`
- Existing hash-based change detection in freescout-db.js will automatically detect when photoUrl changes (it's part of customer.data which feeds into source_hash)
- Omit photoUrl from the returned customer data when null (use conditional spread): `...(photoUrl ? { photoUrl } : {})` to avoid sending null values
  </action>
  <verify>
Run `node -c steps/prepare-freescout-customers.js` to verify syntax is valid. Then run `node -e "const m = require('./steps/prepare-freescout-customers'); console.log(typeof m.runPrepare)"` from the project root to verify the module exports correctly and runPrepare is still a function.
  </verify>
  <done>
The getPhotoUrl function is async and queries the Rondo Club API with ?_embed parameter. prepareCustomer is async and awaits getPhotoUrl. The runPrepare loop awaits prepareCustomer. Members with photo_state !== 'synced' or without rondo_club_id return null for photoUrl. photoUrl is conditionally included in customer data (omitted when null).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add photoUrl to FreeScout create and update payloads</name>
  <files>steps/submit-freescout-sync.js</files>
  <action>
Modify `steps/submit-freescout-sync.js` to include photoUrl in customer payloads sent to FreeScout:

1. **In `createCustomer()` function** (around line 114-136):
   Add a conditional block after the phones block (around line 131):
   ```javascript
   // Add photoUrl if available
   if (customer.data.photoUrl) {
     payload.photoUrl = customer.data.photoUrl;
   }
   ```
   Place this BEFORE the websites block to maintain logical ordering (personal info → photo → websites).

2. **In `updateCustomer()` function** (around line 145-165):
   Add the same conditional block after the phones block (around line 158):
   ```javascript
   // Add photoUrl if available
   if (customer.data.photoUrl) {
     payload.photoUrl = customer.data.photoUrl;
   }
   ```
   Place this BEFORE the websites block.

**Key points:**
- Use truthy check (`if (customer.data.photoUrl)`) not null check — this correctly handles both null and undefined
- Do NOT send photoUrl when it's falsy — FreeScout expects either a valid URL string or the field omitted entirely
- No changes needed to `syncCustomer()`, `deleteOrphanCustomers()`, or `buildCustomFieldsPayload()` — they work with the data as-is
- No changes needed to `freescout-db.js` — hash detection already covers photoUrl since it's in customer.data
  </action>
  <verify>
Run `node -c steps/submit-freescout-sync.js` to verify syntax is valid. Then run `node -e "const m = require('./steps/submit-freescout-sync'); console.log(typeof m.runSubmit)"` from the project root to verify the module exports correctly.
  </verify>
  <done>
The createCustomer and updateCustomer functions both conditionally include photoUrl in the FreeScout API payload when the value is truthy. Null/undefined photoUrl values are omitted from the payload entirely.
  </done>
</task>

</tasks>

<verification>
1. Syntax validation: `node -c steps/prepare-freescout-customers.js && node -c steps/submit-freescout-sync.js`
2. Module export validation: Both files export their main functions correctly
3. Code review checklist:
   - getPhotoUrl is async and fetches from Rondo Club API with ?_embed
   - getPhotoUrl checks photo_state === 'synced' before making API call
   - getPhotoUrl checks rondo_club_id exists before making API call
   - getPhotoUrl validates URL starts with https:// before returning
   - getPhotoUrl returns null on any error (graceful degradation)
   - prepareCustomer is async and awaits getPhotoUrl
   - prepareCustomer passes options through for API calls
   - photoUrl is conditionally included in customer data (omitted when null)
   - createCustomer payload includes photoUrl when truthy
   - updateCustomer payload includes photoUrl when truthy
   - No photoUrl sent as null to FreeScout API
</verification>

<success_criteria>
- `prepare-freescout-customers.js` has async getPhotoUrl that queries Rondo Club API with ?_embed parameter
- `prepare-freescout-customers.js` has async prepareCustomer that passes options and awaits getPhotoUrl
- `submit-freescout-sync.js` createCustomer includes photoUrl in payload when available
- `submit-freescout-sync.js` updateCustomer includes photoUrl in payload when available
- Both files pass syntax validation
- Both files export their main functions correctly
</success_criteria>

<output>
After completion, create `.planning/phases/45-photo-url-sync-to-freescout/45-01-SUMMARY.md`
</output>
