# Plan 25-01: Wire Change Detection to Reverse Sync

**Phase:** 25 - Wire Change Detection to Reverse Sync (Gap Closure)
**Objective:** Connect detectChanges() to reverse sync pipeline so Stadion edits flow to Sportlink

## Frontmatter

```yaml
wave: 1
depends_on: []
files_modified:
  - reverse-sync.js
autonomous: true
```

## Context

Phase 22 built complete change detection infrastructure (`lib/detect-stadion-changes.js`), and Phase 24 built the multi-page reverse sync (`reverse-sync.js` calling `runReverseSyncMultiPage()`). However, these modules are disconnected:

- `detectChanges()` populates `stadion_change_detections` table
- `getUnsyncedChanges()` reads from that table
- But `reverse-sync.js` never calls `detectChanges()`
- Result: table stays empty, reverse sync finds nothing to push

The fix is minimal: add the `detectChanges()` call at the start of `runAllFieldsReverseSync()`.

## Tasks

<task type="auto">
<name>Task 1: Add detectChanges import to reverse-sync.js</name>
<files>reverse-sync.js</files>
<action>
Import the detectChanges function from lib/detect-stadion-changes.js at the top of reverse-sync.js.

Add after line 5 (after the runReverseSyncMultiPage import):
```javascript
const { detectChanges } = require('./lib/detect-stadion-changes');
```
</action>
<verify>grep "detectChanges" reverse-sync.js | grep "require"</verify>
<done>Import statement for detectChanges exists in reverse-sync.js</done>
</task>

<task type="auto">
<name>Task 2: Call detectChanges before runReverseSyncMultiPage</name>
<files>reverse-sync.js</files>
<action>
Modify runAllFieldsReverseSync() to call detectChanges() before calling runReverseSyncMultiPage().

Inside the try block (after line 22 "try {"), add before the runReverseSyncMultiPage call:
```javascript
    // Detect Stadion changes to populate stadion_change_detections table
    logger.log('Detecting Stadion changes...');
    const detectedChanges = await detectChanges({ verbose, logger });
    logger.log(`Detected ${detectedChanges.length} field change(s)`);
```

Error handling: If detectChanges() throws, let it propagate to the existing catch block. This fails the entire reverse sync, which is correct behavior since without detection there are no changes to push. The catch block at line 32-35 will log the error and return { success: false, synced: 0, failed: 0, error: err.message }.
</action>
<verify>grep -A5 "Detecting Stadion" reverse-sync.js</verify>
<done>detectChanges() is called inside try block before runReverseSyncMultiPage(), and detection count is logged</done>
</task>

<task type="checkpoint:manual">
<name>Task 3: Verify integration on production server</name>
<what-built>Change detection wired to reverse sync pipeline</what-built>
<how-to-verify>
SSH to production server and run:
```bash
ssh root@46.202.155.16
cd /home/sportlink
git pull
node reverse-sync.js --verbose
```

Expected output:
1. "Detecting Stadion changes..." message appears
2. "Detected N field change(s)" message (N may be 0 if no edits in Stadion)
3. Reverse sync proceeds to process any detected changes

If Stadion has been edited since last forward sync, the stadion_change_detections table should have entries and reverse sync should push them to Sportlink.
</how-to-verify>
<resume-signal>Confirm output shows detection messages and reverse sync proceeds</resume-signal>
</task>

## Verification

Run from project root:

```bash
# 1. Verify import exists
grep "detectChanges" reverse-sync.js

# 2. Verify function is called
grep -A5 "Detecting Stadion" reverse-sync.js

# 3. Run the script (will show detection output)
node reverse-sync.js --verbose 2>&1 | head -20
```

Expected: Output shows "Detecting Stadion changes..." followed by detection count, then reverse sync proceeds.

## Must-Haves (Goal-Backward Verification)

From Phase 25 Success Criteria:

1. **reverse-sync.js calls detectChanges() before runReverseSyncMultiPage()** - Verified by grep showing import and call
2. **stadion_change_detections table populates with real data** - Verified by running on production and checking table
3. **E2E flow works: Stadion edit -> change detected -> reverse sync -> Sportlink updated** - Verified by production test with actual Stadion edit
4. **Email reports show actual reverse sync statistics** - Verified by reports showing non-zero when changes exist (detection logs go through shared logger)

## Rollback

If issues arise, revert the two additions to reverse-sync.js:
1. Remove the detectChanges import line
2. Remove the detectChanges call and log lines

The system will return to previous behavior (reverse sync runs but finds no changes).
