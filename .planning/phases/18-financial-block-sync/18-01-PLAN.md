---
phase: 18-financial-block-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prepare-stadion-members.js
  - submit-stadion-sync.js
autonomous: true

must_haves:
  truths:
    - "Financial block status from Sportlink syncs to Stadion financiele-blokkade ACF field"
    - "When financial block status changes, an activity is logged on the person in Stadion"
    - "First-time blocked members get an initial activity logged"
    - "Activity logging failures do not block field updates"
  artifacts:
    - path: "prepare-stadion-members.js"
      provides: "Financial block inclusion in ACF data"
      contains: "financiele-blokkade"
    - path: "submit-stadion-sync.js"
      provides: "Activity logging for financial block changes"
      contains: "logFinancialBlockActivity"
  key_links:
    - from: "prepare-stadion-members.js"
      to: "submit-stadion-sync.js"
      via: "prepared member data with financiele-blokkade field"
      pattern: "financiele-blokkade"
    - from: "submit-stadion-sync.js"
      to: "Stadion REST API /stadion/v1/people/{id}/activities"
      via: "activity creation POST request"
      pattern: "activities.*POST"
---

<objective>
Sync financial transfer block status from Sportlink to Stadion WordPress

Purpose: Members with financial blocks should have this status visible in Stadion, with historical tracking via activities
Output: Financial block syncs to `financiele-blokkade` ACF field, status changes logged as activities
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-financial-block-sync/18-CONTEXT.md
@.planning/phases/18-financial-block-sync/18-RESEARCH.md
@.planning/phases/17-memberheader-data-capture/17-01-SUMMARY.md

Key implementation details from context:
- Financial block data already captured in Phase 17: `sportlink_member_free_fields.has_financial_block` (INTEGER 0/1)
- Hash computation already includes `has_financial_block` (Phase 17 updated `computeMemberFreeFieldsHash`)
- Stadion activity endpoint: `POST /stadion/v1/people/{person_id}/activities` with `content`, `activity_type` fields
- Activity text in Dutch: "Financiele blokkade ingesteld" when blocked, "Financiele blokkade opgeheven" when unblocked
- Activity logging failures should NOT block field updates (field sync is critical, activity is nice-to-have)
- Must handle initial sync: if member is blocked on first sync, log activity

Reference files:
@prepare-stadion-members.js
@submit-stadion-sync.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add financial block to prepared member ACF data</name>
  <files>prepare-stadion-members.js</files>
  <action>
Extend the `preparePerson()` function to include financial block status from free fields.

In the free fields section (around line 129-133), add financial block handling:

```javascript
// Free fields from Sportlink /other tab (FreeScout ID, VOG datum, financial block)
if (freeFields) {
  if (freeFields.freescout_id) acf['freescout-id'] = freeFields.freescout_id;
  if (freeFields.vog_datum) acf['datum-vog'] = freeFields.vog_datum;
  // Financial block status (convert SQLite INTEGER 0/1 to boolean)
  // Explicitly check for 1 to treat null/undefined/0 as "not blocked"
  if (freeFields.has_financial_block !== undefined) {
    acf['financiele-blokkade'] = (freeFields.has_financial_block === 1);
  }
}
```

Key implementation notes:
- Convert SQLite INTEGER (0/1) to JavaScript boolean (true/false)
- Use strict equality `=== 1` to ensure only actual "blocked" (1) becomes true
- Treat undefined, null, and 0 as "not blocked" (false)
- Only add field if freeFields exists and has_financial_block is defined
  </action>
  <verify>
Run: `node prepare-stadion-members.js --verbose | head -100`

Check output includes:
1. Sample prepared member shows `financiele-blokkade` field in ACF data
2. Value is boolean (true/false), not integer
3. No errors during preparation
  </verify>
  <done>
`preparePerson()` includes `financiele-blokkade` ACF field converted from SQLite integer to boolean
  </done>
</task>

<task type="auto">
  <name>Task 2: Add activity logging for financial block changes</name>
  <files>submit-stadion-sync.js</files>
  <action>
Add activity logging when financial block status changes during sync.

1. Add a helper function to log financial block activities:

```javascript
/**
 * Log financial block status change as activity on person
 * Uses Stadion's activity endpoint: POST /stadion/v1/people/{id}/activities
 * @param {number} stadionId - WordPress person post ID
 * @param {boolean} isBlocked - New financial block status
 * @param {Object} options - Logger and verbose options
 */
async function logFinancialBlockActivity(stadionId, isBlocked, options) {
  const logVerbose = options.logger?.verbose.bind(options.logger) || (options.verbose ? console.log : () => {});

  const activityText = isBlocked
    ? 'Financiele blokkade ingesteld'
    : 'Financiele blokkade opgeheven';

  try {
    await stadionRequest(
      `stadion/v1/people/${stadionId}/activities`,
      'POST',
      {
        content: activityText,
        activity_type: 'financial_block_change',
        activity_date: new Date().toISOString().split('T')[0]  // YYYY-MM-DD
      },
      options
    );
    logVerbose(`  Logged activity: ${activityText}`);
  } catch (error) {
    // Activity logging is nice-to-have, don't fail sync
    logVerbose(`  Warning: Could not log activity: ${error.message}`);
  }
}
```

2. Modify `syncPerson()` to detect financial block changes and log activities.

In the UPDATE path (inside the `if (stadion_id)` block), after the existing try block that fetches existing person (around line 35-62):

- Before the PUT request, fetch existing person to get previous financial block status
- After successful PUT, compare previous vs new status and log activity if changed
- For NEW persons (create path), log activity if they start with a block

The update logic should be:
```javascript
// In syncPerson, UPDATE path:
// After the existing code that handles 404...

// Get existing person to compare financial block status
let previousBlockStatus = false;
try {
  const existing = await stadionRequest(`wp/v2/people/${stadion_id}`, 'GET', null, options);
  previousBlockStatus = existing.body.acf?.['financiele-blokkade'] || false;
} catch (fetchError) {
  // If we can't fetch, continue with update but skip activity comparison
  logVerbose(`  Could not fetch existing person for activity comparison: ${fetchError.message}`);
}

// After successful PUT update (inside the existing try block for PUT):
const newBlockStatus = data.acf?.['financiele-blokkade'] || false;
if (previousBlockStatus !== newBlockStatus) {
  await logFinancialBlockActivity(stadion_id, newBlockStatus, options);
}
```

For the CREATE path (around line 65-86):
```javascript
// After successful POST and updateSyncState:
const newBlockStatus = data.acf?.['financiele-blokkade'] || false;
if (newBlockStatus) {
  // Log initial block status for newly created persons
  await logFinancialBlockActivity(newId, true, options);
}
```

IMPORTANT: Do NOT add an extra GET request for the update path - we need to check if there's already a GET happening. Looking at the current code, there's no existing GET before PUT for members (only for parents). So we need to add one GET to compare status.

Structure the code carefully:
1. For UPDATE: GET existing -> compare status -> PUT update -> if status changed, log activity
2. For CREATE: POST new -> if blocked, log initial activity
  </action>
  <verify>
1. Verify code compiles: `node -c submit-stadion-sync.js`
2. Verify activity logging function exists: `grep -n "logFinancialBlockActivity" submit-stadion-sync.js`
3. Verify function is called in both update and create paths: `grep -n "await logFinancialBlockActivity" submit-stadion-sync.js`
  </verify>
  <done>
- `logFinancialBlockActivity()` helper function added
- `syncPerson()` detects financial block changes and logs activities
- Activity logging failures are caught and logged as warnings without failing sync
- New blocked persons get initial activity logged
  </done>
</task>

</tasks>

<verification>
1. Code syntax valid: `node -c prepare-stadion-members.js && node -c submit-stadion-sync.js`
2. Financial block field included in preparation: `node prepare-stadion-members.js --verbose 2>&1 | grep -i "financiele-blokkade\|financial"`
3. Activity logging function implemented: `grep -A5 "async function logFinancialBlockActivity" submit-stadion-sync.js`
4. Activity endpoint used correctly: `grep "stadion/v1/people.*activities" submit-stadion-sync.js`

Note: Full integration testing requires running on the production server against live Stadion API. These verifications confirm code correctness at the syntax/structure level.
</verification>

<success_criteria>
- [ ] `preparePerson()` includes `financiele-blokkade` ACF field from `freeFields.has_financial_block`
- [ ] Boolean conversion works correctly (INTEGER 1 -> true, 0/null/undefined -> false)
- [ ] `logFinancialBlockActivity()` helper function sends activity to Stadion API
- [ ] `syncPerson()` UPDATE path compares previous vs new status and logs activity on change
- [ ] `syncPerson()` CREATE path logs activity if person starts with financial block
- [ ] Activity logging failures are caught and don't fail the sync
- [ ] Activity text is in Dutch: "Financiele blokkade ingesteld" / "Financiele blokkade opgeheven"
</success_criteria>

<output>
After completion, create `.planning/phases/18-financial-block-sync/18-01-SUMMARY.md`
</output>
