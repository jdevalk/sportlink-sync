---
phase: 46-freescout-conversations-as-activities
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - steps/submit-freescout-activities.js
  - pipelines/sync-freescout-conversations.js
  - scripts/sync.sh
  - pipelines/sync-all.js
autonomous: true

must_haves:
  truths:
    - "FreeScout email conversations appear in Rondo Club person activity timeline"
    - "Each conversation syncs only once (no duplicate timeline entries on re-sync)"
    - "Pipeline is accessible via sync.sh conversations command"
    - "Pipeline is included in sync-all.js full sync run"
    - "Support agents working in Rondo Club can see conversation history without tab switching"
  artifacts:
    - path: "steps/submit-freescout-activities.js"
      provides: "Submit activity payloads to Rondo Club Activities API with deduplication"
      exports: ["runSubmitActivities"]
    - path: "pipelines/sync-freescout-conversations.js"
      provides: "Pipeline orchestrator for FreeScout conversations sync"
      exports: ["runFreescoutConversationsSync"]
    - path: "scripts/sync.sh"
      provides: "CLI entry point for conversations pipeline"
      contains: "conversations"
    - path: "pipelines/sync-all.js"
      provides: "Conversations sync included in full sync"
      contains: "freescout-conversations"
  key_links:
    - from: "steps/submit-freescout-activities.js"
      to: "lib/rondo-club-client.js"
      via: "rondoClubRequestWithRetry for activity creation"
      pattern: "rondoClubRequestWithRetry.*activities"
    - from: "steps/submit-freescout-activities.js"
      to: "lib/freescout-conversations-db.js"
      via: "markConversationSynced after successful creation"
      pattern: "markConversationSynced"
    - from: "pipelines/sync-freescout-conversations.js"
      to: "steps/download-freescout-conversations.js"
      via: "runDownloadConversations step call"
      pattern: "runDownloadConversations"
    - from: "pipelines/sync-freescout-conversations.js"
      to: "steps/prepare-freescout-activities.js"
      via: "runPrepareActivities step call"
      pattern: "runPrepareActivities"
    - from: "pipelines/sync-freescout-conversations.js"
      to: "steps/submit-freescout-activities.js"
      via: "runSubmitActivities step call"
      pattern: "runSubmitActivities"
    - from: "scripts/sync.sh"
      to: "pipelines/sync-freescout-conversations.js"
      via: "case statement mapping conversations to pipeline"
      pattern: "conversations.*sync-freescout-conversations"
---

<objective>
Create the submit step, pipeline orchestrator, and integrate FreeScout conversations sync into sync.sh and sync-all.js.

Purpose: Complete the end-to-end flow — activities get created in Rondo Club and the pipeline is operational via CLI.
Output: Submit step, pipeline orchestrator, updated sync.sh and sync-all.js.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-freescout-conversations-as-activities/46-RESEARCH.md
@.planning/phases/46-freescout-conversations-as-activities/46-01-SUMMARY.md

@pipelines/sync-freescout.js — Pattern for FreeScout pipeline orchestrator (credential check, RunTracker, step tracking, printSummary)
@pipelines/sync-nikki.js — Pattern for multi-step pipeline with RunTracker
@pipelines/sync-all.js — Where to add conversations sync step
@scripts/sync.sh — Where to add conversations command
@lib/rondo-club-client.js — rondoClubRequestWithRetry for activity creation
@lib/freescout-conversations-db.js — markConversationSynced for dedup tracking (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submit step for FreeScout activities</name>
  <files>steps/submit-freescout-activities.js</files>
  <action>
Create `steps/submit-freescout-activities.js` following the module/CLI hybrid pattern.

**Core logic of `runSubmitActivities({ logger, verbose, activities })`:**

If `activities` not provided as parameter, run the prepare step internally to get them:
```javascript
const { runPrepareActivities } = require('./prepare-freescout-activities');
const prepareResult = await runPrepareActivities({ logger, verbose });
activities = prepareResult.activities;
```

**For each activity payload:**
1. Call Rondo Club Activities API:
   ```javascript
   const response = await rondoClubRequestWithRetry(
     `rondo/v1/people/${activity.personId}/activities`,
     'POST',
     activity.body,
     { logger, verbose }
   );
   ```
2. On success: extract `response.body.id` as `rondoClubActivityId`
3. Mark conversation as synced in conversations DB:
   ```javascript
   markConversationSynced(conversationsDb, activity.conversationId, rondoClubActivityId);
   ```
4. Increment `created` counter
5. On error (try/catch per activity): log error, increment `failed` counter, push to errors array. Continue to next activity.
6. Add 100ms delay between API calls (rate limiting precaution)

**Open conversations DB** at start via `require('../lib/freescout-conversations-db').openDb()`. Close at end.

**Return:** `{ success: true, total: activities.length, created, skipped, failed, errors }`

Where `skipped` = activities that were already synced (defensive check: query `freescout_conversations` table before POST — if `rondo_club_activity_id IS NOT NULL`, skip).

**CLI entry point:**
```javascript
if (require.main === module) {
  const { verbose } = parseCliArgs();
  runSubmitActivities({ verbose })
    .then(result => { if (!result.success) process.exitCode = 1; })
    .catch(err => { console.error('Error:', err.message); process.exitCode = 1; });
}
```

`module.exports = { runSubmitActivities };`

Use `require('../lib/rondo-club-client').rondoClubRequestWithRetry`, `require('../lib/freescout-conversations-db')`, `require('../lib/logger').createSyncLogger`, `require('../lib/utils').parseCliArgs`.
  </action>
  <verify>
Run: `node -e "require('./steps/submit-freescout-activities')"` — should load without error
  </verify>
  <done>Submit step creates activities via Rondo Club API, marks conversations as synced in SQLite to prevent duplicates, handles errors per-activity gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline orchestrator and integrate into sync.sh and sync-all.js</name>
  <files>pipelines/sync-freescout-conversations.js, scripts/sync.sh, pipelines/sync-all.js</files>
  <action>
**File 1: `pipelines/sync-freescout-conversations.js`**

Follow the exact pattern from `pipelines/sync-freescout.js` (credential check, RunTracker, step tracking, printSummary, module/CLI hybrid).

**Core logic of `runFreescoutConversationsSync(options = {})`:**

1. Parse options: `{ verbose = false, force = false }`
2. Create logger: `createSyncLogger({ verbose, prefix: 'freescout-conversations' })`
3. Check FreeScout credentials via `checkCredentials()` from `../lib/freescout-client` — exit early if not configured
4. Create RunTracker: `new RunTracker('freescout-conversations')`
5. Initialize stats object:
   ```javascript
   const stats = {
     completedAt: '',
     duration: '',
     download: { totalCustomers: 0, totalConversations: 0, newConversations: 0, errors: [] },
     prepare: { total: 0, prepared: 0, skipped: 0 },
     submit: { total: 0, created: 0, skipped: 0, failed: 0, errors: [] }
   };
   ```

6. **Step 1: Download conversations**
   ```javascript
   const downloadStepId = tracker.startStep('conversations-download');
   const downloadResult = await runDownloadConversations({ logger, verbose, force });
   // Map result to stats.download
   tracker.endStep(downloadStepId, { outcome: 'success', created: downloadResult.totalConversations });
   ```

7. **Step 2: Prepare activity payloads**
   ```javascript
   const prepareStepId = tracker.startStep('activities-prepare');
   const prepareResult = await runPrepareActivities({ logger, verbose });
   // Map result to stats.prepare
   tracker.endStep(prepareStepId, { outcome: 'success' });
   ```

8. **Step 3: Submit to Rondo Club**
   ```javascript
   const submitStepId = tracker.startStep('activities-submit');
   const submitResult = await runSubmitActivities({ logger, verbose, activities: prepareResult.activities });
   // Map result to stats.submit
   tracker.endStep(submitStepId, { outcome: 'success', created: submitResult.created, failed: submitResult.failed });
   ```

9. Each step wrapped in try/catch (non-critical pattern from sync-nikki.js). Record errors via `tracker.recordErrors()` and `tracker.recordError()`.

10. Print summary, end run, close logger. Return `{ success, stats }`.

**printSummary function:** Follow sync-freescout.js pattern with dividers. Show:
- Completed/Duration
- CONVERSATION DOWNLOAD: customers processed, conversations found, new conversations
- ACTIVITY PREPARATION: total, prepared, skipped (no Rondo Club ID)
- ACTIVITY SUBMISSION: total, created, skipped, failed
- ERRORS section if any

**CLI entry point:** Same pattern as sync-freescout.js with `verbose` and `force` flags.

---

**File 2: Update `scripts/sync.sh`**

Add `conversations` to the valid sync types and interactive menu:

1. In the interactive menu section, add option 11:
   ```
   echo " 11) conversations    FreeScout conversations as activities"
   ```
   And in the case statement: `11) set -- "conversations" ;;`

2. Update the choice range text from `[1-10]` to `[1-11]`

3. In the validation case statement, add `conversations` to the valid types:
   ```
   people|photos|teams|functions|invoice|nikki|freescout|reverse|discipline|former-members|conversations|all)
   ```

4. In the script mapping case statement, add:
   ```
   conversations)
       SYNC_SCRIPT="sync-freescout-conversations.js"
       ;;
   ```

---

**File 3: Update `pipelines/sync-all.js`**

Add conversations sync as a new non-critical step after FreeScout customer sync (Step 7):

1. Add import at top:
   ```javascript
   const { runFreescoutConversationsSync } = require('./sync-freescout-conversations');
   ```

2. Add stats section to the stats object:
   ```javascript
   freescoutConversations: {
     total: 0,
     created: 0,
     skipped: 0,
     failed: 0,
     errors: []
   }
   ```

3. Add Step 7b after the FreeScout customer sync block (inside the `if (freescoutCreds.configured)` block):
   ```javascript
   // Step 7b: FreeScout Conversations Sync (NON-CRITICAL)
   logger.verbose('Syncing FreeScout conversations to Rondo Club activities...');
   try {
     const convResult = await runFreescoutConversationsSync({ verbose, force });
     if (convResult.stats) {
       stats.freescoutConversations = {
         total: convResult.stats.submit.total,
         created: convResult.stats.submit.created,
         skipped: convResult.stats.submit.skipped,
         failed: convResult.stats.submit.failed,
         errors: (convResult.stats.submit.errors || []).map(e => ({
           message: e.message,
           system: 'freescout-conversations'
         }))
       };
     }
   } catch (err) {
     logger.error(`FreeScout conversations sync failed: ${err.message}`);
     stats.freescoutConversations.errors.push({
       message: `FreeScout conversations sync failed: ${err.message}`,
       system: 'freescout-conversations'
     });
   }
   ```

4. Add to printSummary section (after FREESCOUT SYNC block):
   ```javascript
   logger.log('FREESCOUT CONVERSATIONS');
   logger.log(minorDivider);
   if (stats.freescoutConversations.total > 0 || stats.freescoutConversations.created > 0) {
     logger.log(`Activities created: ${stats.freescoutConversations.created}`);
     if (stats.freescoutConversations.skipped > 0) {
       logger.log(`  Skipped: ${stats.freescoutConversations.skipped}`);
     }
     if (stats.freescoutConversations.failed > 0) {
       logger.log(`  Failed: ${stats.freescoutConversations.failed}`);
     }
   } else {
     logger.log('Conversations synced: 0 changes');
   }
   logger.log('');
   ```

5. Add `stats.freescoutConversations.errors` to the `allErrors` and `allErrorArrays` arrays used for total error counting.

6. Update the sync.sh help comment at the top to include `conversations`.
  </action>
  <verify>
Run: `node -e "require('./pipelines/sync-freescout-conversations')"` — should load without error.
Run: `node -e "require('./pipelines/sync-all')"` — should load without error.
Run: `grep -c 'conversations' scripts/sync.sh` — should return 3+ matches.
  </verify>
  <done>Pipeline orchestrator runs download → prepare → submit with RunTracker. sync.sh accepts "conversations" command. sync-all.js includes conversations sync as non-critical step after FreeScout customer sync. End-to-end flow operational.</done>
</task>

</tasks>

<verification>
1. `node -e "require('./steps/submit-freescout-activities')"` loads without error
2. `node -e "require('./pipelines/sync-freescout-conversations')"` loads without error
3. `node -e "require('./pipelines/sync-all')"` loads without error (no broken imports)
4. `scripts/sync.sh` validates `conversations` as a sync type
5. Pipeline follows RunTracker pattern with step tracking
6. Submit step marks conversations as synced after successful API call (deduplication)
</verification>

<success_criteria>
- Submit step creates activities via POST to rondo/v1/people/{personId}/activities
- Submit step marks conversations synced in SQLite after successful creation (prevents duplicates)
- Pipeline orchestrator follows sync-freescout.js pattern with credential check, RunTracker, 3 steps
- sync.sh accepts `conversations` command and maps to sync-freescout-conversations.js
- sync-all.js includes conversations sync as non-critical step within FreeScout credentials check
- All files load without import errors
</success_criteria>

<output>
After completion, create `.planning/phases/46-freescout-conversations-as-activities/46-02-SUMMARY.md`
</output>
