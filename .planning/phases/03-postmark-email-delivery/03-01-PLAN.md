---
phase: 03-postmark-email-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - scripts/send-email.js
  - .env.example
autonomous: true
user_setup:
  - service: postmark
    why: "Transactional email delivery for sync reports"
    env_vars:
      - name: POSTMARK_API_KEY
        source: "Postmark Dashboard -> Servers -> [Your Server] -> API Tokens -> Server API tokens"
      - name: POSTMARK_FROM_EMAIL
        source: "Must be a verified sender signature in Postmark Dashboard -> Sender Signatures"
    dashboard_config:
      - task: "Create sender signature or verify domain"
        location: "Postmark Dashboard -> Sender Signatures -> Add Sender Signature"

must_haves:
  truths:
    - "Node.js script can send email via Postmark API"
    - "Script reads POSTMARK_API_KEY from environment"
    - "Script reads POSTMARK_FROM_EMAIL from environment"
    - "Script reads OPERATOR_EMAIL from environment"
    - "Missing credentials produce clear error message"
    - "Script can be invoked from command line with log file path"
  artifacts:
    - path: "scripts/send-email.js"
      provides: "Standalone email sending script"
      min_lines: 40
    - path: "package.json"
      provides: "postmark dependency"
      contains: "postmark"
    - path: ".env.example"
      provides: "Documentation of required env vars"
      contains: "POSTMARK_API_KEY"
  key_links:
    - from: "scripts/send-email.js"
      to: "process.env.POSTMARK_API_KEY"
      via: "environment variable read"
      pattern: "process\\.env\\.POSTMARK_API_KEY"
    - from: "scripts/send-email.js"
      to: "postmark.ServerClient"
      via: "library initialization"
      pattern: "new postmark\\.ServerClient"
---

<objective>
Create the Postmark email sending script that reads sync logs and sends them via Postmark API.

Purpose: Enable reliable transactional email delivery for sync reports, replacing the unreliable local `mail` command.
Output: Working `scripts/send-email.js` that can be called with a log file path and sends its contents via Postmark.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-postmark-email-delivery/03-RESEARCH.md
@package.json
@scripts/cron-wrapper.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add postmark dependency and create send-email.js script</name>
  <files>package.json, scripts/send-email.js, .env.example</files>
  <action>
1. Run `npm install postmark` to add the dependency

2. Create `scripts/send-email.js` with the following structure:
   - Use `require('varlock/auto-load')` at top (same pattern as other project scripts)
   - Validate required env vars: POSTMARK_API_KEY, POSTMARK_FROM_EMAIL, OPERATOR_EMAIL
   - Exit with code 1 and clear error message if any are missing
   - Accept log file path as command line argument (`process.argv[2]`)
   - Read the log file content using `fs.readFileSync`
   - Initialize Postmark client: `new postmark.ServerClient(process.env.POSTMARK_API_KEY)`
   - Send email with:
     - From: process.env.POSTMARK_FROM_EMAIL
     - To: process.env.OPERATOR_EMAIL
     - Subject: "Sportlink Sync Report - YYYY-MM-DD" (use current date)
     - TextBody: log file content
   - On success: console.log success message, exit 0
   - On failure: console.error the error message, exit 1
   - Do NOT throw or crash on Postmark API errors - log and exit cleanly

3. Update `.env.example` to add:
   ```
   POSTMARK_API_KEY=
   POSTMARK_FROM_EMAIL=
   ```
   (OPERATOR_EMAIL should already exist or be added if missing)

Pattern from research - use promise-based error handling:
```javascript
client.sendEmail({...})
  .then(() => { console.log('Email sent successfully'); process.exit(0); })
  .catch((error) => { console.error('Failed to send email:', error.message); process.exit(1); });
```
  </action>
  <verify>
    Run `node scripts/send-email.js` without arguments - should print usage/error about missing log file.
    Run `node scripts/send-email.js /nonexistent/file` - should print error about missing file.
    Check `grep postmark package.json` shows dependency.
    Check `cat .env.example` shows POSTMARK_API_KEY and POSTMARK_FROM_EMAIL.
  </verify>
  <done>
    - scripts/send-email.js exists and is executable
    - Script validates env vars and prints clear errors when missing
    - Script accepts log file path as CLI argument
    - Script uses postmark library to send email
    - .env.example documents all required Postmark env vars
    - package.json includes postmark dependency
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test log file and verify script behavior</name>
  <files>logs/test-email.log</files>
  <action>
1. Create a test log file at `logs/test-email.log` with sample content:
   ```
   ========================================
   SPORTLINK SYNC SUMMARY
   ========================================

   Completed: 2026-01-25 10:00:00
   Duration: 1m 30s

   This is a test email to verify Postmark integration.
   ========================================
   ```

2. Test the script behavior without credentials (should fail gracefully):
   - Run: `node scripts/send-email.js logs/test-email.log`
   - Expected: Error message about missing POSTMARK_API_KEY
   - Should NOT crash with uncaught exception

3. Test with partial credentials (POSTMARK_API_KEY set but not FROM_EMAIL):
   - Run: `POSTMARK_API_KEY=test node scripts/send-email.js logs/test-email.log`
   - Expected: Error message about missing POSTMARK_FROM_EMAIL

Note: Full end-to-end test requires real Postmark credentials which will be configured during install-cron.sh updates in Plan 03.
  </action>
  <verify>
    Run `node scripts/send-email.js logs/test-email.log` - should show "Missing required environment variables" error.
    Run `POSTMARK_API_KEY=test POSTMARK_FROM_EMAIL=test@example.com node scripts/send-email.js logs/test-email.log` - should show error about missing OPERATOR_EMAIL (or attempt API call and fail with auth error).
    Script should exit cleanly (not crash with unhandled promise rejection).
  </verify>
  <done>
    - Test log file exists at logs/test-email.log
    - Script gracefully handles missing environment variables
    - Script gracefully handles Postmark API errors
    - No unhandled promise rejections or crashes
  </done>
</task>

</tasks>

<verification>
1. `npm ls postmark` - shows postmark package installed
2. `node scripts/send-email.js` - prints usage error (no log file specified)
3. `node scripts/send-email.js logs/test-email.log` - prints env var error (graceful failure)
4. `grep POSTMARK .env.example` - shows both API key and FROM email vars
5. Script file is well-structured with proper error handling
</verification>

<success_criteria>
- postmark dependency added to package.json and installed
- scripts/send-email.js created with proper structure
- Script validates all required env vars before attempting API call
- Script accepts log file path as command line argument
- Script handles all error cases gracefully (no crashes)
- .env.example updated with POSTMARK_API_KEY and POSTMARK_FROM_EMAIL
</success_criteria>

<output>
After completion, create `.planning/phases/03-postmark-email-delivery/03-01-SUMMARY.md`
</output>
