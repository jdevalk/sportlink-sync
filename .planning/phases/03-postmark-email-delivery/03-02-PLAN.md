---
phase: 03-postmark-email-delivery
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - scripts/cron-wrapper.sh
  - scripts/install-cron.sh
autonomous: true

must_haves:
  truths:
    - "cron-wrapper.sh calls send-email.js instead of mail command"
    - "Email failure does not fail the sync (exit code preserved)"
    - "install-cron.sh prompts for Postmark API key"
    - "install-cron.sh prompts for Postmark sender email"
    - "Credentials are stored in .env file"
    - "install-cron.sh no longer requires mail command"
  artifacts:
    - path: "scripts/cron-wrapper.sh"
      provides: "Email integration via Node.js script"
      contains: "send-email.js"
    - path: "scripts/install-cron.sh"
      provides: "Postmark credential prompts"
      contains: "POSTMARK_API_KEY"
  key_links:
    - from: "scripts/cron-wrapper.sh"
      to: "scripts/send-email.js"
      via: "node script invocation"
      pattern: "node.*send-email\\.js"
    - from: "scripts/install-cron.sh"
      to: ".env"
      via: "credential storage"
      pattern: "POSTMARK_API_KEY"
---

<objective>
Integrate send-email.js into cron automation and update installer to prompt for Postmark credentials.

Purpose: Complete the integration of Postmark email delivery into the existing cron automation, replacing the `mail` command entirely.
Output: Updated cron-wrapper.sh that uses send-email.js, and updated install-cron.sh that prompts for Postmark credentials.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-postmark-email-delivery/03-RESEARCH.md
@.planning/phases/03-postmark-email-delivery/03-01-SUMMARY.md
@scripts/cron-wrapper.sh
@scripts/install-cron.sh
@scripts/send-email.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cron-wrapper.sh to use send-email.js</name>
  <files>scripts/cron-wrapper.sh</files>
  <action>
Modify scripts/cron-wrapper.sh to replace the `mail` command with the Node.js send-email.js script.

Changes required:
1. Remove the existing email block (lines 46-50):
   ```bash
   # Send email if MAILTO is set
   if [ -n "$MAILTO" ]; then
       SUBJECT="Sportlink Sync Report - $(date +%Y-%m-%d)"
       cat "$LOG_FILE" | mail -s "$SUBJECT" "$MAILTO"
   fi
   ```

2. Replace with new block that calls send-email.js with graceful failure:
   ```bash
   # Send email via Postmark if credentials are configured
   if [ -n "$POSTMARK_API_KEY" ] && [ -n "$POSTMARK_FROM_EMAIL" ] && [ -n "$OPERATOR_EMAIL" ]; then
       node "$PROJECT_DIR/scripts/send-email.js" "$LOG_FILE" || \
           echo "Warning: Failed to send email notification" >&2
       # Note: || prevents email failure from propagating via set -e
   else
       echo "Skipping email: Postmark credentials not configured" >&2
   fi
   ```

Key requirement (EMAIL-05): Email failure must NOT fail the sync. The `||` pattern catches any non-zero exit from send-email.js and logs a warning instead of failing. The script's `set -e` at the top would otherwise cause any failed command to exit the script.

The sync's exit code (stored in EXIT_CODE variable) should still be returned at the end, unaffected by email success/failure.
  </action>
  <verify>
    Read scripts/cron-wrapper.sh - should contain "send-email.js" and not contain "mail -s"
    Check that `|| echo "Warning"` pattern is used for graceful failure
    Verify EXIT_CODE is still properly set and returned
  </verify>
  <done>
    - cron-wrapper.sh calls send-email.js instead of mail command
    - Email failure is caught with || and logged as warning
    - Sync exit code is preserved and returned regardless of email status
    - Skip message printed when credentials not configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Update install-cron.sh to prompt for Postmark credentials</name>
  <files>scripts/install-cron.sh</files>
  <action>
Modify scripts/install-cron.sh to:

1. Remove the mail command check (lines 8-17):
   ```bash
   # Check if mail command exists
   if ! command -v mail &> /dev/null; then
       ...
   fi
   ```

2. Add prompts for Postmark credentials after the operator email prompt:
   ```bash
   # Prompt for Postmark API key
   echo ""
   echo "Postmark configuration (for email delivery):"
   echo "  Get your Server API Token from: Postmark Dashboard -> Servers -> API Tokens"
   echo ""
   read -p "Enter Postmark API Key: " POSTMARK_API_KEY

   # Validate API key is not empty
   if [ -z "$POSTMARK_API_KEY" ]; then
       echo "Error: Postmark API Key cannot be empty" >&2
       exit 1
   fi

   # Prompt for sender email
   echo ""
   echo "  Sender email must be verified in Postmark Dashboard -> Sender Signatures"
   echo ""
   read -p "Enter verified sender email address: " POSTMARK_FROM_EMAIL

   # Validate sender email is not empty
   if [ -z "$POSTMARK_FROM_EMAIL" ]; then
       echo "Error: Sender email cannot be empty" >&2
       exit 1
   fi
   ```

3. Write credentials to .env file (after prompts, before cron installation):
   ```bash
   # Store credentials in .env file
   ENV_FILE="$PROJECT_DIR/.env"

   # Create .env if it doesn't exist
   touch "$ENV_FILE"

   # Update or add OPERATOR_EMAIL
   if grep -q "^OPERATOR_EMAIL=" "$ENV_FILE"; then
       sed -i.bak "s/^OPERATOR_EMAIL=.*/OPERATOR_EMAIL=$OPERATOR_EMAIL/" "$ENV_FILE" && rm -f "$ENV_FILE.bak"
   else
       echo "OPERATOR_EMAIL=$OPERATOR_EMAIL" >> "$ENV_FILE"
   fi

   # Update or add POSTMARK_API_KEY
   if grep -q "^POSTMARK_API_KEY=" "$ENV_FILE"; then
       sed -i.bak "s/^POSTMARK_API_KEY=.*/POSTMARK_API_KEY=$POSTMARK_API_KEY/" "$ENV_FILE" && rm -f "$ENV_FILE.bak"
   else
       echo "POSTMARK_API_KEY=$POSTMARK_API_KEY" >> "$ENV_FILE"
   fi

   # Update or add POSTMARK_FROM_EMAIL
   if grep -q "^POSTMARK_FROM_EMAIL=" "$ENV_FILE"; then
       sed -i.bak "s/^POSTMARK_FROM_EMAIL=.*/POSTMARK_FROM_EMAIL=$POSTMARK_FROM_EMAIL/" "$ENV_FILE" && rm -f "$ENV_FILE.bak"
   else
       echo "POSTMARK_FROM_EMAIL=$POSTMARK_FROM_EMAIL" >> "$ENV_FILE"
   fi
   ```

4. Remove MAILTO from cron entries (no longer needed):
   - Remove line `MAILTO=$OPERATOR_EMAIL` from CRON_ENTRIES

5. Update success message at the end:
   ```bash
   echo ""
   echo "Cron jobs installed successfully!"
   echo ""
   echo "Configuration stored in .env:"
   echo "  - OPERATOR_EMAIL=$OPERATOR_EMAIL"
   echo "  - POSTMARK_API_KEY=***"
   echo "  - POSTMARK_FROM_EMAIL=$POSTMARK_FROM_EMAIL"
   echo ""
   echo "Email reports will be sent via Postmark to: $OPERATOR_EMAIL"
   echo ""
   ```

Note: Use sed -i.bak pattern for macOS compatibility (BSD sed requires backup extension).
  </action>
  <verify>
    Read scripts/install-cron.sh - should contain prompts for POSTMARK_API_KEY and POSTMARK_FROM_EMAIL
    Should NOT contain "mail" command check
    Should contain logic to write to .env file
    Should NOT contain MAILTO in cron entries
  </verify>
  <done>
    - install-cron.sh prompts for Postmark API key with helpful instructions
    - install-cron.sh prompts for verified sender email with helpful instructions
    - Credentials are written to .env file (update existing or append)
    - mail command check is removed
    - MAILTO removed from cron entries
    - Success message updated to reflect Postmark configuration
  </done>
</task>

<task type="auto">
  <name>Task 3: Test the integration end-to-end</name>
  <files></files>
  <action>
Perform integration testing of the updated scripts:

1. Test cron-wrapper.sh behavior without credentials:
   - Temporarily rename or backup .env if it exists
   - Run: `bash scripts/cron-wrapper.sh 2>&1 | tail -5`
   - Expected: Should see "Skipping email: Postmark credentials not configured"
   - Restore .env

2. Test cron-wrapper.sh with fake credentials (will fail API call but test integration):
   - Create temporary .env with:
     ```
     POSTMARK_API_KEY=test-key
     POSTMARK_FROM_EMAIL=test@example.com
     OPERATOR_EMAIL=operator@example.com
     ```
   - The sync will run and email will fail (expected - fake API key)
   - Should see "Warning: Failed to send email notification"
   - Sync should still complete (exit code from npm run sync-all, not email)

3. Verify install-cron.sh syntax:
   - Run: `bash -n scripts/install-cron.sh` (syntax check only)
   - Expected: No output (no syntax errors)

Note: Full cron testing requires actual Postmark credentials. The checkpoint in the next manual verification step will test actual email delivery.
  </action>
  <verify>
    bash -n scripts/cron-wrapper.sh exits 0 (no syntax errors)
    bash -n scripts/install-cron.sh exits 0 (no syntax errors)
    Without credentials, cron-wrapper.sh prints skip message
    With fake credentials, email failure doesn't crash the wrapper
  </verify>
  <done>
    - Both shell scripts pass bash syntax validation
    - cron-wrapper.sh handles missing credentials gracefully
    - cron-wrapper.sh handles email failure gracefully
    - Sync exit code is preserved regardless of email status
  </done>
</task>

</tasks>

<verification>
1. `grep -c "send-email.js" scripts/cron-wrapper.sh` - returns 1 (script is called)
2. `grep -c "mail -s" scripts/cron-wrapper.sh` - returns 0 (mail command removed)
3. `grep "POSTMARK_API_KEY" scripts/install-cron.sh` - shows prompt code
4. `grep "POSTMARK_FROM_EMAIL" scripts/install-cron.sh` - shows prompt code
5. `grep "MAILTO" scripts/install-cron.sh` - should NOT appear in cron entries
6. `bash -n scripts/cron-wrapper.sh && bash -n scripts/install-cron.sh` - no syntax errors
</verification>

<success_criteria>
- cron-wrapper.sh uses send-email.js instead of mail command
- Email failure is logged but does not fail the sync (EMAIL-05)
- install-cron.sh prompts for POSTMARK_API_KEY and POSTMARK_FROM_EMAIL
- Credentials are stored in .env file
- mail command requirement is removed
- MAILTO is removed from cron configuration
- Both scripts pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/03-postmark-email-delivery/03-02-SUMMARY.md`
</output>
