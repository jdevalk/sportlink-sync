---
phase: 16-freescout-customer-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/freescout-db.js
  - lib/freescout-client.js
autonomous: true
user_setup:
  - service: freescout
    why: "Customer sync API access"
    env_vars:
      - name: FREESCOUT_API_KEY
        source: "FreeScout Settings -> API Keys -> Create new key"
      - name: FREESCOUT_BASE_URL
        source: "FreeScout installation URL (e.g., https://support.yourclub.nl)"

must_haves:
  truths:
    - "FreeScout API client can make authenticated requests"
    - "Database tracks customer sync state with hash-based change detection"
    - "Database stores FreeScout ID to KNVB ID mapping"
  artifacts:
    - path: "lib/freescout-db.js"
      provides: "SQLite database operations for FreeScout sync tracking"
      exports: ["openDb", "upsertCustomers", "getCustomersNeedingSync", "updateSyncState", "getCustomerByKnvbId"]
    - path: "lib/freescout-client.js"
      provides: "HTTP client for FreeScout REST API"
      exports: ["freescoutRequest", "testConnection"]
  key_links:
    - from: "lib/freescout-client.js"
      to: "FreeScout API"
      via: "HTTPS requests with X-FreeScout-API-Key header"
      pattern: "X-FreeScout-API-Key"
    - from: "lib/freescout-db.js"
      to: "freescout-sync.sqlite"
      via: "better-sqlite3 database connection"
      pattern: "freescout-sync\\.sqlite"
---

<objective>
Create foundation for FreeScout customer sync: SQLite tracking database and API client.

Purpose: Establish the infrastructure needed for syncing member data to FreeScout helpdesk customers, following established codebase patterns from Laposta and Stadion syncs.

Output: Two library modules that handle database tracking and API communication.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-freescout-customer-sync/16-RESEARCH.md

# Pattern references - existing implementations to follow
@lib/stadion-db.js
@lib/stadion-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FreeScout database module</name>
  <files>lib/freescout-db.js</files>
  <action>
Create lib/freescout-db.js following the pattern from lib/stadion-db.js:

1. Schema (freescout_customers table):
   - id INTEGER PRIMARY KEY
   - knvb_id TEXT NOT NULL UNIQUE
   - email TEXT NOT NULL
   - freescout_id INTEGER (nullable - populated after first sync)
   - data_json TEXT NOT NULL (stores prepared customer payload)
   - source_hash TEXT NOT NULL
   - last_seen_at TEXT NOT NULL
   - last_synced_at TEXT
   - last_synced_hash TEXT
   - created_at TEXT NOT NULL

2. Create indexes on source_hash/last_synced_hash and email.

3. Export these functions (copy patterns from stadion-db.js):
   - openDb(dbPath) - Open database with DEFAULT_DB_PATH = 'freescout-sync.sqlite'
   - initDb(db) - Initialize schema
   - stableStringify(value) - For deterministic JSON (copy from stadion-db.js)
   - computeSourceHash(knvbId, data) - SHA-256 hash for change detection
   - upsertCustomers(db, customers) - Bulk insert/update, each: { knvb_id, email, data }
   - getCustomersNeedingSync(db, force) - Get customers where hash changed
   - updateSyncState(db, knvbId, sourceHash, freescoutId) - Mark synced
   - getCustomerByKnvbId(db, knvbId) - Get single customer record
   - getCustomerByFreescoutId(db, freescoutId) - Lookup by FreeScout ID
   - getCustomersNotInList(db, knvbIds) - For delete detection
   - deleteCustomer(db, knvbId) - Remove from tracking
   - getAllTrackedCustomers(db) - Get all records

Use require('crypto') for hashing, require('better-sqlite3') for database.
Database file: freescout-sync.sqlite in project root.
  </action>
  <verify>
Run: `node -e "const db = require('./lib/freescout-db'); const d = db.openDb(); console.log('DB opened'); d.close();"` succeeds without error.
  </verify>
  <done>
freescout-db.js exports all listed functions, creates freescout-sync.sqlite with correct schema on first run.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FreeScout API client</name>
  <files>lib/freescout-client.js</files>
  <action>
Create lib/freescout-client.js following the pattern from lib/stadion-client.js:

1. Environment variables:
   - FREESCOUT_API_KEY - API key for authentication
   - FREESCOUT_BASE_URL - Base URL of FreeScout installation (e.g., https://support.club.nl)

2. freescoutRequest(endpoint, method, body, options) function:
   - Use native https module (NOT axios/got)
   - Build URL from FREESCOUT_BASE_URL + endpoint
   - Set headers:
     - 'X-FreeScout-API-Key': apiKey
     - 'Content-Type': 'application/json'
   - Set timeout: 30000 (30 seconds)
   - Handle timeout event by calling req.destroy()
   - Parse JSON response
   - Return { status, body } on 2xx
   - Throw error with details on 4xx/5xx
   - Include logging via options.logger or options.verbose

3. testConnection(options) function:
   - GET /api/users/me to verify credentials
   - Return { success: true, user: ... } or { success: false, error: ... }

4. Add CLI entry point:
   - `node lib/freescout-client.js` runs testConnection
   - `node lib/freescout-client.js --verbose` for verbose output
   - Exit 0 on success, 1 on failure

Use require('varlock/auto-load') at top for env loading.
  </action>
  <verify>
With valid FREESCOUT_API_KEY and FREESCOUT_BASE_URL in .env:
Run: `node lib/freescout-client.js --verbose` outputs "FreeScout connection OK" and exits 0.
  </verify>
  <done>
freescout-client.js exports freescoutRequest and testConnection, CLI works for connection testing.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./lib/freescout-db')"` loads without error
2. `node -e "require('./lib/freescout-client')"` loads without error
3. `ls freescout-sync.sqlite` shows database file created after first db.openDb() call
4. With env vars set: `node lib/freescout-client.js` succeeds
</verification>

<success_criteria>
- lib/freescout-db.js exists with all documented exports
- lib/freescout-client.js exists with freescoutRequest and testConnection exports
- Database schema created correctly with freescout_customers table
- API client can authenticate with FreeScout (with valid credentials)
- Both modules follow established codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/16-freescout-customer-sync/16-01-SUMMARY.md`
</output>
