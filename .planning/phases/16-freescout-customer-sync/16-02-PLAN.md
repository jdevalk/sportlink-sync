---
phase: 16-freescout-customer-sync
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - prepare-freescout-customers.js
  - submit-freescout-sync.js
  - sync-all.js
autonomous: true
user_setup:
  - service: freescout
    why: "Custom field configuration"
    env_vars:
      - name: FREESCOUT_FIELD_UNION_TEAMS
        source: "FreeScout custom field ID for UnionTeams (default: 1)"
      - name: FREESCOUT_FIELD_PUBLIC_PERSON_ID
        source: "FreeScout custom field ID for KNVB ID (default: 4)"
      - name: FREESCOUT_FIELD_MEMBER_SINCE
        source: "FreeScout custom field ID for MemberSince (default: 5)"
      - name: FREESCOUT_FIELD_NIKKI_SALDO
        source: "FreeScout custom field ID for Nikki saldo (default: 7)"
      - name: FREESCOUT_FIELD_NIKKI_STATUS
        source: "FreeScout custom field ID for Nikki status (default: 8)"

must_haves:
  truths:
    - "Members with email can be synced to FreeScout as customers"
    - "Existing FreeScout customers are updated, not duplicated"
    - "Custom fields (KNVB ID, teams, Nikki data) are populated"
    - "FreeScout sync integrates into sync-all.js pipeline"
  artifacts:
    - path: "prepare-freescout-customers.js"
      provides: "Transform Sportlink members to FreeScout customer format"
      exports: ["runPrepare"]
    - path: "submit-freescout-sync.js"
      provides: "Main sync orchestration script"
      exports: ["runSubmit"]
    - path: "sync-all.js"
      provides: "Updated pipeline with FreeScout sync"
      contains: "freescout"
  key_links:
    - from: "prepare-freescout-customers.js"
      to: "stadion-sync.sqlite"
      via: "stadion-db getMembersNeedingSync"
      pattern: "require.*stadion-db"
    - from: "prepare-freescout-customers.js"
      to: "nikki-sync.sqlite"
      via: "nikki-db getContributionsByKnvbId"
      pattern: "require.*nikki-db"
    - from: "submit-freescout-sync.js"
      to: "FreeScout API"
      via: "freescout-client requests"
      pattern: "freescoutRequest"
    - from: "sync-all.js"
      to: "submit-freescout-sync.js"
      via: "require and runSubmit call"
      pattern: "submit-freescout-sync"
---

<objective>
Create FreeScout customer sync: data preparation, sync submission, and pipeline integration.

Purpose: Complete the FreeScout integration by transforming member data, syncing to FreeScout API, and adding to the automated pipeline.

Output: Working FreeScout sync that runs as part of sync-all.js.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-freescout-customer-sync/16-RESEARCH.md
@.planning/phases/16-freescout-customer-sync/16-01-SUMMARY.md

# Pattern references
@prepare-stadion-members.js
@submit-stadion-sync.js
@sync-all.js
@lib/stadion-db.js
@lib/nikki-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create customer data preparation script</name>
  <files>prepare-freescout-customers.js</files>
  <action>
Create prepare-freescout-customers.js following prepare-stadion-members.js pattern:

1. Load data from multiple sources:
   - stadion_members table (lib/stadion-db.js) - member data, photo URL
   - nikki_contributions table (lib/nikki-db.js) - most recent year's saldo/status
   - sportlink_member_free_fields table (lib/stadion-db.js) - existing FreeScout ID

2. Transform each member to FreeScout customer format:
   ```javascript
   {
     knvb_id: member.knvb_id,
     email: member.email,
     freescout_id: freeFields?.freescout_id || null,
     data: {
       firstName: member.data.acf.first_name,
       lastName: member.data.acf.last_name,
       phones: [{ type: 'mobile', value: member.data.acf.mobile_phone }].filter(p => p.value),
       photoUrl: getPhotoUrl(member),  // Only if photo_state === 'synced'
       // Custom fields set in separate API call by submit script
     },
     customFields: {
       union_teams: getUnionTeams(member),  // From team work history
       public_person_id: member.knvb_id,
       member_since: member.data.acf.member_since || null,
       nikki_saldo: getMostRecentNikkiSaldo(member.knvb_id),
       nikki_status: getMostRecentNikkiStatus(member.knvb_id)
     }
   }
   ```

3. Helper functions:
   - getPhotoUrl(member): Return Stadion photo URL only if photo_state === 'synced', else null
   - getUnionTeams(member): Build comma-separated team list from work_history
   - getMostRecentNikkiSaldo(knvbId): Query nikki_contributions for most recent year
   - getMostRecentNikkiStatus(knvbId): Query nikki_contributions for most recent year

4. Filter: Only include members with valid email addresses.

5. Export runPrepare(options) returning { success: true, customers: [...] } or { success: false, error: '...' }

6. CLI entry point:
   - `node prepare-freescout-customers.js` outputs customer count
   - `node prepare-freescout-customers.js --verbose` outputs details
   - `node prepare-freescout-customers.js --json` outputs JSON for debugging
  </action>
  <verify>
Run: `node prepare-freescout-customers.js` outputs "Prepared X customers for FreeScout" with X > 0.
  </verify>
  <done>
prepare-freescout-customers.js transforms member data to FreeScout format, including custom fields from multiple data sources.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FreeScout sync submission script</name>
  <files>submit-freescout-sync.js</files>
  <action>
Create submit-freescout-sync.js following submit-stadion-sync.js pattern:

1. Main sync flow:
   - Load prepared customers from prepare-freescout-customers.js
   - Upsert to freescout_customers tracking table
   - Get customers needing sync (hash changed)
   - For each customer:
     a. If freescout_id exists: PUT /api/customers/{id}
     b. If no freescout_id: GET /api/customers?email=... to search
     c. If found by email: Update existing customer
     d. If not found: POST /api/customers to create
     e. After success: PUT /api/customers/{id}/customer_fields for custom fields
     f. Update tracking database with new freescout_id and hash

2. Custom fields format (per FreeScout API):
   ```javascript
   const customFields = [
     { id: parseInt(process.env.FREESCOUT_FIELD_UNION_TEAMS || '1'), value: customer.customFields.union_teams || '' },
     { id: parseInt(process.env.FREESCOUT_FIELD_PUBLIC_PERSON_ID || '4'), value: customer.customFields.public_person_id },
     { id: parseInt(process.env.FREESCOUT_FIELD_MEMBER_SINCE || '5'), value: customer.customFields.member_since || '' },
     { id: parseInt(process.env.FREESCOUT_FIELD_NIKKI_SALDO || '7'), value: String(customer.customFields.nikki_saldo || '') },
     { id: parseInt(process.env.FREESCOUT_FIELD_NIKKI_STATUS || '8'), value: customer.customFields.nikki_status || '' }
   ];
   ```

3. Error handling:
   - Handle 404 on update (customer deleted): clear freescout_id, create new
   - Handle 409 conflict (email exists): search by email and link
   - Log errors but continue with other customers
   - Track errors in result object

4. Export runSubmit(options) returning:
   ```javascript
   {
     success: boolean,
     total: number,
     synced: number,
     created: number,
     updated: number,
     skipped: number,
     errors: [{ knvb_id, email, message }]
   }
   ```

5. CLI entry point:
   - `node submit-freescout-sync.js` runs sync
   - `node submit-freescout-sync.js --verbose` with logging
   - `node submit-freescout-sync.js --force` forces all customers
   - `node submit-freescout-sync.js --dry-run` shows what would sync without API calls
  </action>
  <verify>
Run: `node submit-freescout-sync.js --dry-run --verbose` shows customers that would be synced without making API calls.
  </verify>
  <done>
submit-freescout-sync.js syncs customers to FreeScout with hash-based change detection, search-before-create logic, and custom field updates.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate FreeScout sync into pipeline</name>
  <files>sync-all.js</files>
  <action>
Update sync-all.js to include FreeScout sync:

1. Add require for submit-freescout-sync.js:
   ```javascript
   const { runSubmit: runFreescoutSubmit } = require('./submit-freescout-sync');
   ```

2. Add FreeScout sync after Stadion sync (near end of pipeline, after photos and teams):
   ```javascript
   // FreeScout sync
   if (FREESCOUT_API_KEY) {
     log('Syncing to FreeScout...');
     const freescoutResult = await runFreescoutSubmit({ logger, verbose });
     results.freescout = freescoutResult;
     if (freescoutResult.errors.length > 0) {
       log(`FreeScout: ${freescoutResult.synced}/${freescoutResult.total} synced (${freescoutResult.errors.length} errors)`);
     } else {
       log(`FreeScout: ${freescoutResult.synced}/${freescoutResult.total} synced`);
     }
   }
   ```

3. Add FreeScout results to email summary (if enabled):
   - Include synced/created/updated/skipped counts
   - Include error count if any

4. Check for FREESCOUT_API_KEY before attempting sync (skip gracefully if not configured).

5. Ensure FreeScout sync runs AFTER:
   - Member sync (needs stadion_members populated)
   - Photo sync (needs photo URLs)
   - Team sync (needs work_history populated)
   - Nikki sync (needs nikki_contributions populated)
  </action>
  <verify>
Run: `node sync-all.js --verbose 2>&1 | grep -i freescout` shows FreeScout sync output in pipeline.
  </verify>
  <done>
sync-all.js includes FreeScout sync as final step after all dependencies (members, photos, teams, Nikki data) are synced.
  </done>
</task>

</tasks>

<verification>
1. `node prepare-freescout-customers.js` outputs customer count > 0
2. `node submit-freescout-sync.js --dry-run` shows pending sync without errors
3. With valid FreeScout credentials: `node submit-freescout-sync.js --verbose` syncs at least one customer
4. `node sync-all.js --verbose` includes FreeScout in output
5. Check FreeScout UI: Customer has correct name, email, KNVB ID, team info
</verification>

<success_criteria>
- prepare-freescout-customers.js transforms member data from all sources
- submit-freescout-sync.js syncs to FreeScout with hash-based change detection
- Custom fields populated: KNVB ID, teams, member_since, Nikki saldo/status
- sync-all.js includes FreeScout sync (conditional on API key being set)
- No duplicate customers created (search-by-email working)
- Sync is idempotent (running twice doesn't create duplicates or errors)
</success_criteria>

<output>
After completion, create `.planning/phases/16-freescout-customer-sync/16-02-SUMMARY.md`
</output>
