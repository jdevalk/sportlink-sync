---
phase: 07-parent-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/parent-dedupe.js
  - prepare-laposta-members.js
autonomous: true

must_haves:
  truths:
    - "normalizeEmail() is importable from shared module"
    - "isValidEmail() is importable from shared module"
    - "Laposta preparation still works after refactor"
  artifacts:
    - path: "lib/parent-dedupe.js"
      provides: "Email normalization and parent deduplication utilities"
      exports: ["normalizeEmail", "isValidEmail", "buildChildFullName"]
    - path: "prepare-laposta-members.js"
      provides: "Updated to use shared module"
      contains: "require('./lib/parent-dedupe')"
  key_links:
    - from: "prepare-laposta-members.js"
      to: "lib/parent-dedupe.js"
      via: "require statement"
      pattern: "require\\('./lib/parent-dedupe'\\)"
---

<objective>
Extract email normalization and parent deduplication utilities from prepare-laposta-members.js into a shared module for reuse by Stadion parent sync.

Purpose: Both Laposta and Stadion parent sync need identical email normalization and deduplication logic. A shared module ensures consistency and prevents duplicate code.

Output: lib/parent-dedupe.js with normalizeEmail(), isValidEmail(), buildChildFullName() functions, and prepare-laposta-members.js updated to import from shared module.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-parent-sync/07-RESEARCH.md

Source code to extract from:
@prepare-laposta-members.js (lines 51-59, 132-137)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared parent deduplication module</name>
  <files>lib/parent-dedupe.js</files>
  <action>
Create lib/parent-dedupe.js with the following functions extracted from prepare-laposta-members.js:

```javascript
/**
 * Normalize email for deduplication (lowercase, trimmed)
 * @param {*} value - Email value (may be null/undefined)
 * @returns {string} - Normalized email or empty string
 */
function normalizeEmail(value) {
  if (!value) return '';
  return String(value).trim().toLowerCase();
}

/**
 * Check if value is a valid email address
 * @param {*} value - Email value to check
 * @returns {boolean}
 */
function isValidEmail(value) {
  const email = normalizeEmail(value);
  return email.includes('@');
}

/**
 * Build full name string from member fields
 * @param {Object} member - Sportlink member with FirstName, Infix, LastName
 * @returns {string} - Full name or empty string
 */
function buildChildFullName(member) {
  const firstName = hasValue(member.FirstName) ? String(member.FirstName).trim() : '';
  const infix = hasValue(member.Infix) ? String(member.Infix).trim() : '';
  const lastName = hasValue(member.LastName) ? String(member.LastName).trim() : '';
  return [firstName, infix, lastName].filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();
}

// Include hasValue helper since buildChildFullName needs it
function hasValue(value) {
  return value !== undefined && value !== null && String(value).trim() !== '';
}
```

Export all functions: normalizeEmail, isValidEmail, buildChildFullName, hasValue
  </action>
  <verify>
Run: `node -e "const m = require('./lib/parent-dedupe'); console.log(Object.keys(m))"`
Expected output includes: normalizeEmail, isValidEmail, buildChildFullName, hasValue
  </verify>
  <done>
lib/parent-dedupe.js exists and exports all four functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update prepare-laposta-members.js to use shared module</name>
  <files>prepare-laposta-members.js</files>
  <action>
1. Add require statement at top of file:
   ```javascript
   const { normalizeEmail, isValidEmail, buildChildFullName, hasValue } = require('./lib/parent-dedupe');
   ```

2. Remove the local definitions of these functions (lines ~51-59 and ~132-137):
   - Remove local normalizeEmail function
   - Remove local isValidEmail function
   - Remove local buildChildFullName function
   - Note: hasValue may be used elsewhere in the file, check if it can be removed or keep local copy

3. Verify all usages still work:
   - normalizeEmail is called multiple times for email deduplication
   - isValidEmail is called to validate emails
   - buildChildFullName is called to build child name strings

Important: Only remove function definitions that are now imported. If hasValue is used in other contexts with different semantics, keep the local copy.
  </action>
  <verify>
Run: `npm run prepare-laposta -- --verbose 2>&1 | head -20`
Should not error on startup. Look for normal output like "Found X Sportlink members"
  </verify>
  <done>
prepare-laposta-members.js imports from lib/parent-dedupe.js and executes without error
  </done>
</task>

</tasks>

<verification>
1. Shared module loads: `node -e "require('./lib/parent-dedupe')"`
2. Laposta preparation still works: `npm run prepare-laposta`
3. Functions behave correctly:
   ```bash
   node -e "const {normalizeEmail, isValidEmail} = require('./lib/parent-dedupe'); console.log(normalizeEmail('  TEST@Example.COM  ')); console.log(isValidEmail('test@example.com')); console.log(isValidEmail('not-email'));"
   ```
   Expected: "test@example.com", true, false
</verification>

<success_criteria>
- lib/parent-dedupe.js exists with normalizeEmail, isValidEmail, buildChildFullName, hasValue exports
- prepare-laposta-members.js imports from shared module
- `npm run prepare-laposta` executes without errors
- Email normalization returns lowercase, trimmed values
</success_criteria>

<output>
After completion, create `.planning/phases/07-parent-sync/07-01-SUMMARY.md`
</output>
