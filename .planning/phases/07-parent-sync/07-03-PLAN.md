---
phase: 07-parent-sync
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - submit-stadion-sync.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Parents sync to Stadion as separate person records"
    - "Parent is matched by email in Stadion (no KNVB ID)"
    - "Parent record has children relationship linked"
    - "Unchanged parents are skipped (hash-based)"
    - "Orphan parents are deleted from Stadion"
  artifacts:
    - path: "submit-stadion-sync.js"
      provides: "Parent sync execution with relationship linking"
      exports: ["runSync"]
      contains: "syncParents"
    - path: "package.json"
      provides: "npm scripts for parent sync"
      contains: "sync-stadion-parents"
  key_links:
    - from: "submit-stadion-sync.js"
      to: "prepare-stadion-parents.js"
      via: "require statement"
      pattern: "require\\('./prepare-stadion-parents'\\)"
    - from: "submit-stadion-sync.js"
      to: "lib/stadion-db.js"
      via: "parent tracking functions"
      pattern: "upsertParents|getParentsNeedingSync"
---

<objective>
Extend submit-stadion-sync.js to sync parents to Stadion with email matching, relationship linking to children, hash-based change detection, and orphan deletion.

Purpose: Complete the parent sync pipeline by executing the prepared parent data to Stadion, creating/updating person records, linking to children via relationships field, and cleaning up orphaned parents.

Output: Extended submit-stadion-sync.js that syncs both members and parents, with npm scripts for parent-only sync.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-parent-sync/07-RESEARCH.md
@.planning/phases/07-parent-sync/07-02-SUMMARY.md

Reference:
@submit-stadion-sync.js (current member sync implementation)
@lib/stadion-db.js (parent tracking functions from 07-02)
@prepare-stadion-parents.js (parent preparation from 07-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parent sync functions to submit-stadion-sync.js</name>
  <files>submit-stadion-sync.js</files>
  <action>
Extend submit-stadion-sync.js with parent sync capabilities:

1. Add new imports:
```javascript
const { runPrepare: runPrepareParents } = require('./prepare-stadion-parents');
const {
  upsertParents,
  getParentsNeedingSync,
  updateParentSyncState,
  deleteParent,
  getParentsNotInList
} = require('./lib/stadion-db');
```

2. Add parent matching function (email only, no KNVB ID):
```javascript
/**
 * Find existing parent in Stadion by email
 * Uses same email matching approach as member fallback
 * @param {string} email - Parent email address
 * @param {Object} options - Logger and verbose options
 * @returns {Promise<Object|null>} - WordPress person object or null
 */
async function findExistingParent(email, options) {
  const { logger, verbose } = options;
  const logVerbose = logger ? logger.verbose.bind(logger) : (verbose ? console.log : () => {});

  if (!email) return null;

  try {
    // Search by email
    const response = await stadionRequest(
      `wp/v2/${PERSON_TYPE}?search=${encodeURIComponent(email)}&per_page=20`,
      'GET',
      null,
      options
    );

    if (response.body && response.body.length > 0) {
      // Client-side filter for exact ACF email match
      for (const person of response.body) {
        const contactInfo = person.acf?.contact_info || [];
        const hasEmail = contactInfo.some(c =>
          c.type === 'email' && c.value?.toLowerCase() === email.toLowerCase()
        );
        if (hasEmail) {
          logVerbose(`Parent matched by email: ${email}`);
          return person;
        }
      }
    }

    // Fallback: check recent persons
    logVerbose(`Parent email not in search results, checking recent persons...`);
    const recentResponse = await stadionRequest(
      `wp/v2/${PERSON_TYPE}?per_page=100&orderby=modified&order=desc`,
      'GET',
      null,
      options
    );

    if (recentResponse.body && recentResponse.body.length > 0) {
      for (const person of recentResponse.body) {
        const contactInfo = person.acf?.contact_info || [];
        const hasEmail = contactInfo.some(c =>
          c.type === 'email' && c.value?.toLowerCase() === email.toLowerCase()
        );
        if (hasEmail) {
          logVerbose(`Parent matched by email (recent scan): ${email}`);
          return person;
        }
      }
    }
  } catch (error) {
    logVerbose(`Parent email search failed: ${error.message}`);
  }

  return null;
}
```

3. Add parent sync function with relationship linking:
```javascript
/**
 * Sync a single parent to Stadion (create or update)
 * Also links parent to children via relationships field
 * @param {Object} parent - Parent record from preparation
 * @param {Object} db - SQLite database connection
 * @param {Map} knvbIdToStadionId - Map of KNVB ID to Stadion post ID for children
 * @param {Object} options - Logger and verbose options
 * @returns {Promise<{action: string, id: number}>}
 */
async function syncParent(parent, db, knvbIdToStadionId, options) {
  const { email, childKnvbIds, data, source_hash } = parent;
  const logVerbose = options.logger?.verbose.bind(options.logger) || (options.verbose ? console.log : () => {});

  // Resolve child KNVB IDs to Stadion post IDs
  const childStadionIds = childKnvbIds
    .map(knvbId => knvbIdToStadionId.get(knvbId))
    .filter(Boolean);

  const existing = await findExistingParent(email, options);

  if (existing) {
    // UPDATE existing parent
    // Merge existing children relationships with new ones (preserve manual links)
    const existingChildren = existing.acf?.children || [];
    const mergedChildren = Array.from(new Set([...existingChildren, ...childStadionIds]));

    // Add children to ACF data
    const updateData = {
      ...data,
      acf: {
        ...data.acf,
        children: mergedChildren
      }
    };

    const response = await stadionRequest(
      `wp/v2/${PERSON_TYPE}/${existing.id}`,
      'POST',
      updateData,
      options
    );
    updateParentSyncState(db, email, source_hash, existing.id);

    // Update children's parent relationship (bidirectional)
    await updateChildrenParentLinks(existing.id, childStadionIds, options);

    return { action: 'updated', id: existing.id };
  } else {
    // CREATE new parent
    const createData = {
      ...data,
      acf: {
        ...data.acf,
        children: childStadionIds
      }
    };

    const response = await stadionRequest(
      `wp/v2/${PERSON_TYPE}`,
      'POST',
      createData,
      options
    );
    const newId = response.body.id;
    updateParentSyncState(db, email, source_hash, newId);

    // Update children's parent relationship (bidirectional)
    await updateChildrenParentLinks(newId, childStadionIds, options);

    return { action: 'created', id: newId };
  }
}

/**
 * Update children's parents relationship field (bidirectional linking)
 * Preserves existing parent links, adds new one
 */
async function updateChildrenParentLinks(parentId, childStadionIds, options) {
  const logVerbose = options.logger?.verbose.bind(options.logger) || (options.verbose ? console.log : () => {});

  for (const childId of childStadionIds) {
    try {
      // Get existing child record
      const childResponse = await stadionRequest(
        `wp/v2/${PERSON_TYPE}/${childId}`,
        'GET',
        null,
        options
      );

      const existingParents = childResponse.body.acf?.parents || [];
      if (!existingParents.includes(parentId)) {
        const mergedParents = [...existingParents, parentId];
        await stadionRequest(
          `wp/v2/${PERSON_TYPE}/${childId}`,
          'POST',
          { acf: { parents: mergedParents } },
          options
        );
        logVerbose(`Linked parent ${parentId} to child ${childId}`);
      }
    } catch (error) {
      logVerbose(`Failed to link parent to child ${childId}: ${error.message}`);
      // Continue with other children
    }

    await sleep(1000); // Rate limit
  }
}
```

4. Add orphan parent deletion:
```javascript
/**
 * Delete parents that no longer have children in Sportlink
 */
async function deleteOrphanParents(db, currentParentEmails, options) {
  const logVerbose = options.logger?.verbose.bind(options.logger) || (options.verbose ? console.log : () => {});
  const deleted = [];
  const errors = [];

  const toDelete = getParentsNotInList(db, currentParentEmails);

  for (const parent of toDelete) {
    if (!parent.stadion_id) {
      deleteParent(db, parent.email);
      continue;
    }

    logVerbose(`Deleting orphan parent: ${parent.email}`);
    try {
      await stadionRequest(
        `wp/v2/${PERSON_TYPE}/${parent.stadion_id}`,
        'DELETE',
        null,
        options
      );
      deleteParent(db, parent.email);
      deleted.push({ email: parent.email, stadion_id: parent.stadion_id });
    } catch (error) {
      errors.push({ email: parent.email, message: error.message });
    }

    await sleep(2000);
  }

  return { deleted, errors };
}
```

5. Add parent sync orchestration:
```javascript
/**
 * Sync parents to Stadion
 * @param {Object} db - SQLite database connection
 * @param {Map} knvbIdToStadionId - Map of member KNVB ID to Stadion post ID
 * @param {Object} options - Logger, verbose, force options
 * @returns {Promise<Object>} - Parent sync result
 */
async function syncParents(db, knvbIdToStadionId, options = {}) {
  const { logger, verbose = false, force = false } = options;
  const logVerbose = logger?.verbose.bind(logger) || (verbose ? console.log : () => {});

  const result = {
    total: 0,
    synced: 0,
    created: 0,
    updated: 0,
    skipped: 0,
    deleted: 0,
    errors: []
  };

  // Prepare parents from Sportlink
  const prepared = await runPrepareParents({ logger, verbose });
  if (!prepared.success) {
    result.errors.push({ message: prepared.error });
    return result;
  }

  const parents = prepared.parents;
  result.total = parents.length;

  // Upsert to tracking database
  upsertParents(db, parents);

  // Get parents needing sync
  const needsSync = getParentsNeedingSync(db, force);
  result.skipped = result.total - needsSync.length;

  logVerbose(`${needsSync.length} parents need sync (${result.skipped} unchanged)`);

  // Sync each parent
  for (let i = 0; i < needsSync.length; i++) {
    const parent = needsSync[i];
    logVerbose(`Syncing parent ${i + 1}/${needsSync.length}: ${parent.email}`);

    try {
      const syncResult = await syncParent(parent, db, knvbIdToStadionId, options);
      result.synced++;
      if (syncResult.action === 'created') result.created++;
      if (syncResult.action === 'updated') result.updated++;
    } catch (error) {
      result.errors.push({ email: parent.email, message: error.message });
    }

    if (i < needsSync.length - 1) {
      await sleep(2000);
    }
  }

  // Delete orphan parents
  const currentEmails = parents.map(p => p.email);
  const deleteResult = await deleteOrphanParents(db, currentEmails, options);
  result.deleted = deleteResult.deleted.length;
  result.errors.push(...deleteResult.errors);

  return result;
}
```

6. Update runSync to include parent sync after members:
```javascript
async function runSync(options = {}) {
  // ... existing member sync code ...

  // After member sync, track KNVB ID to Stadion ID mapping
  const knvbIdToStadionId = new Map();
  // Build map from database after member sync
  const allMembers = getMembersNeedingSync(db, true); // Get all
  allMembers.forEach(m => {
    if (m.knvb_id && m.stadion_id) {
      knvbIdToStadionId.set(m.knvb_id, m.stadion_id);
    }
  });

  // Sync parents (if enabled)
  if (options.includeParents !== false) {
    logVerbose('Starting parent sync...');
    const parentResult = await syncParents(db, knvbIdToStadionId, options);
    result.parents = parentResult;
  }

  // ... rest of existing code ...
}
```

7. Export new functions and add CLI options for parent-only sync
  </action>
  <verify>
Run: `node -e "const {runSync} = require('./submit-stadion-sync'); console.log('runSync available')"`
Should not error
  </verify>
  <done>
submit-stadion-sync.js has syncParent, syncParents, findExistingParent, deleteOrphanParents, updateChildrenParentLinks functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add npm scripts for parent sync</name>
  <files>package.json</files>
  <action>
Add new npm scripts for parent sync operations:

```json
{
  "scripts": {
    "sync-stadion-parents": "node submit-stadion-sync.js --parents-only",
    "sync-stadion-parents-verbose": "node submit-stadion-sync.js --parents-only --verbose"
  }
}
```

Also update CLI entry point in submit-stadion-sync.js to handle --parents-only flag:

```javascript
if (require.main === module) {
  const verbose = process.argv.includes('--verbose');
  const force = process.argv.includes('--force');
  const parentsOnly = process.argv.includes('--parents-only');
  const skipParents = process.argv.includes('--skip-parents');

  const options = {
    verbose,
    force,
    includeMembers: !parentsOnly,
    includeParents: !skipParents
  };

  runSync(options)
    .then(result => {
      // ... existing output ...
      if (result.parents) {
        console.log(`Parents: ${result.parents.synced}/${result.parents.total} synced`);
        console.log(`  Created: ${result.parents.created}`);
        console.log(`  Updated: ${result.parents.updated}`);
        console.log(`  Skipped: ${result.parents.skipped}`);
        console.log(`  Deleted: ${result.parents.deleted}`);
      }
    });
}
```
  </action>
  <verify>
Run: `npm run sync-stadion-parents-verbose -- --help 2>&1 | head -5`
Or: `node submit-stadion-sync.js --parents-only --verbose 2>&1 | head -10`
Should show parent sync output
  </verify>
  <done>
npm run sync-stadion-parents and sync-stadion-parents-verbose scripts available
  </done>
</task>

</tasks>

<verification>
1. Parent sync functions exist:
   ```bash
   node -e "const m = require('./submit-stadion-sync'); console.log('Module loaded')"
   ```

2. npm scripts available:
   ```bash
   npm run | grep parents
   ```
   Should show sync-stadion-parents scripts

3. Full sync includes parents (dry run check):
   ```bash
   node submit-stadion-sync.js --verbose 2>&1 | head -50
   ```
   Should show both member and parent sync output
</verification>

<success_criteria>
- submit-stadion-sync.js has parent sync functions (syncParent, findExistingParent, syncParents, etc.)
- Parents matched by email in Stadion
- Children relationship field populated with Stadion post IDs
- Bidirectional linking updates children's parents field
- Hash-based change detection skips unchanged parents
- Orphan parents deleted from Stadion
- npm scripts sync-stadion-parents and sync-stadion-parents-verbose available
</success_criteria>

<output>
After completion, create `.planning/phases/07-parent-sync/07-03-SUMMARY.md`
</output>
