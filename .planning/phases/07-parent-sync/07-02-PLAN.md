---
phase: 07-parent-sync
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - prepare-stadion-parents.js
  - lib/stadion-db.js
autonomous: true

must_haves:
  truths:
    - "Parents are extracted from Sportlink member records"
    - "Same parent email across children produces single parent record"
    - "Parent record includes merged phone numbers from all children"
    - "Parents without email AND without phone are skipped"
  artifacts:
    - path: "prepare-stadion-parents.js"
      provides: "Parent extraction, deduplication, and transformation"
      exports: ["runPrepare"]
    - path: "lib/stadion-db.js"
      provides: "Parent tracking table and functions"
      contains: "stadion_parents"
  key_links:
    - from: "prepare-stadion-parents.js"
      to: "lib/parent-dedupe.js"
      via: "require statement"
      pattern: "require\\('./lib/parent-dedupe'\\)"
    - from: "prepare-stadion-parents.js"
      to: "lib/stadion-db.js"
      via: "require statement for hash functions"
      pattern: "require\\('./lib/stadion-db'\\)"
---

<objective>
Create parent preparation script that extracts parents from Sportlink member data, deduplicates by email, and transforms to Stadion person format.

Purpose: Parents need to be synced as separate person records in Stadion. This plan handles extraction from child records, deduplication (same parent with multiple children = one record), and field mapping.

Output: prepare-stadion-parents.js that produces parent records ready for Stadion sync, and stadion-db.js extended with parent tracking functions.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-parent-sync/07-RESEARCH.md
@.planning/phases/07-parent-sync/07-01-SUMMARY.md

Reference implementations:
@prepare-stadion-members.js (for transformation patterns)
@lib/stadion-db.js (for hash tracking patterns)
@lib/parent-dedupe.js (for email normalization)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend stadion-db.js with parent tracking</name>
  <files>lib/stadion-db.js</files>
  <action>
Add parent tracking table and functions to lib/stadion-db.js:

1. Add to initDb() function - new table for parents:
```sql
CREATE TABLE IF NOT EXISTS stadion_parents (
  id INTEGER PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  stadion_id INTEGER,
  data_json TEXT NOT NULL,
  source_hash TEXT NOT NULL,
  last_seen_at TEXT NOT NULL,
  last_synced_at TEXT,
  last_synced_hash TEXT,
  created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_stadion_parents_hash
  ON stadion_parents (source_hash, last_synced_hash);
```

2. Add new functions (similar to member functions but keyed by email):

```javascript
/**
 * Compute SHA-256 hash of parent data for change detection.
 * Uses email as stable identifier (parents have no KNVB ID).
 */
function computeParentHash(email, data) {
  const payload = stableStringify({ email: email, data: data || {} });
  return crypto.createHash('sha256').update(payload).digest('hex');
}

/**
 * Insert or update parent records in bulk.
 * Each parent: { email, data }
 */
function upsertParents(db, parents) {
  // Similar to upsertMembers but uses email as key
}

/**
 * Get parents needing sync (source_hash != last_synced_hash).
 */
function getParentsNeedingSync(db, force = false) {
  // Similar to getMembersNeedingSync
}

/**
 * Update sync state after successful parent sync to Stadion.
 */
function updateParentSyncState(db, email, sourceHash, stadionId) {
  // Similar to updateSyncState but uses email
}

/**
 * Delete parent from tracking table.
 */
function deleteParent(db, email) {
  // Similar to deleteMember but uses email
}

/**
 * Find tracked parents not in provided list (for orphan detection).
 */
function getParentsNotInList(db, emails) {
  // Similar to getMembersNotInList but uses email
}
```

3. Export all new functions in module.exports
  </action>
  <verify>
Run: `node -e "const db = require('./lib/stadion-db'); console.log(Object.keys(db).filter(k => k.includes('Parent')))"`
Expected: Array containing computeParentHash, upsertParents, getParentsNeedingSync, updateParentSyncState, deleteParent, getParentsNotInList
  </verify>
  <done>
stadion-db.js has parent tracking table and all parent-related functions exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create parent preparation script</name>
  <files>prepare-stadion-parents.js</files>
  <action>
Create prepare-stadion-parents.js following prepare-stadion-members.js patterns:

1. Required imports:
```javascript
require('varlock/auto-load');
const { openDb, getLatestSportlinkResults } = require('./laposta-db');
const { normalizeEmail, isValidEmail, buildChildFullName, hasValue } = require('./lib/parent-dedupe');
```

2. Parent field names from Sportlink:
- EmailAddressParent1, EmailAddressParent2 (email)
- TelephoneParent1, TelephoneParent2 (phone)
- NameParent1, NameParent2 (name)

3. Build parent name with fallback:
```javascript
function buildParentName(member, parentIndex) {
  const nameField = parentIndex === 1 ? 'NameParent1' : 'NameParent2';
  const parentName = member[nameField];

  if (hasValue(parentName)) {
    return { first_name: String(parentName).trim(), last_name: '' };
  }

  // Fallback: "Ouder/verzorger van {child first name}"
  const childFirstName = hasValue(member.FirstName) ? String(member.FirstName).trim() : '';
  const childInfix = hasValue(member.Infix) ? String(member.Infix).trim() : '';
  const childLastName = hasValue(member.LastName) ? String(member.LastName).trim() : '';
  const fullChildLastName = [childInfix, childLastName].filter(Boolean).join(' ');

  return {
    first_name: `Ouder/verzorger van ${childFirstName}`.trim(),
    last_name: fullChildLastName
  };
}
```

4. Extract and deduplicate parents using Maps:
```javascript
async function runPrepare(options = {}) {
  // Load Sportlink data (same as prepare-stadion-members.js)

  const parentDataMap = new Map();  // email -> { name, phones: Set, addresses: [], childKnvbIds: [] }

  members.forEach((member) => {
    [1, 2].forEach((parentIndex) => {
      const emailField = `EmailAddressParent${parentIndex}`;
      const phoneField = `TelephoneParent${parentIndex}`;
      const emailValue = member[emailField];

      // Skip if no email (can't dedupe without email)
      if (!isValidEmail(emailValue)) return;

      const normalized = normalizeEmail(emailValue);
      const phone = member[phoneField];

      // Skip if no email AND no phone
      if (!normalized && !hasValue(phone)) return;

      if (!parentDataMap.has(normalized)) {
        // First time seeing this parent - capture name and address
        parentDataMap.set(normalized, {
          name: buildParentName(member, parentIndex),
          phones: new Set(),
          address: buildParentAddress(member), // Copy from child
          childKnvbIds: []
        });
      }

      const parentData = parentDataMap.get(normalized);

      // Collect phone numbers (may have multiple from different children)
      if (hasValue(phone)) {
        parentData.phones.add(String(phone).trim());
      }

      // Track child KNVB ID for relationship linking
      if (member.PublicPersonId) {
        parentData.childKnvbIds.push(member.PublicPersonId);
      }
    });
  });

  // Convert Map to parent records
  const parents = [];
  parentDataMap.forEach((data, email) => {
    parents.push(prepareParent(email, data));
  });

  return { success: true, parents, skipped: 0 };
}
```

5. Transform to Stadion format:
```javascript
function prepareParent(email, data) {
  const title = [data.name.first_name, data.name.last_name].filter(Boolean).join(' ');

  return {
    email: email,
    childKnvbIds: data.childKnvbIds,  // For relationship linking in sync phase
    data: {
      title: title || 'Parent',
      status: 'publish',
      meta: {
        knvb_id: '',  // Empty - parents are not members
        first_name: data.name.first_name,
        last_name: data.name.last_name,
        gender: '',   // Not available for parents
        is_parent: true  // Custom field to identify parents
      },
      acf: {
        contact_info: buildParentContactInfo(email, data.phones),
        addresses: data.address ? [data.address] : []
      }
    }
  };
}

function buildParentContactInfo(email, phones) {
  const contacts = [];
  if (email) contacts.push({ type: 'email', value: email });
  phones.forEach(phone => {
    if (phone) contacts.push({ type: 'phone', value: phone });
  });
  return contacts;
}

function buildParentAddress(member) {
  const street = (member.StreetName || '').trim();
  const city = (member.City || '').trim();
  if (!street && !city) return null;
  return {
    street: street,
    number: (member.AddressNumber || '').toString().trim(),
    addition: (member.AddressNumberAppendix || '').trim(),
    postal_code: (member.ZipCode || '').trim(),
    city: city
  };
}
```

6. Add CLI entry point and module.exports (same pattern as prepare-stadion-members.js)
  </action>
  <verify>
Run: `node prepare-stadion-parents.js --verbose 2>&1 | head -30`
Should show parent count and sample parent data without errors
  </verify>
  <done>
prepare-stadion-parents.js extracts, deduplicates, and transforms parents from Sportlink data
  </done>
</task>

</tasks>

<verification>
1. Database module loads with parent functions:
   ```bash
   node -e "const db = require('./lib/stadion-db'); console.log('Parent functions:', Object.keys(db).filter(k => k.includes('Parent')))"
   ```

2. Parent preparation runs:
   ```bash
   node prepare-stadion-parents.js --verbose
   ```

3. Deduplication works (same parent email = one record):
   ```bash
   node -e "
     const {runPrepare} = require('./prepare-stadion-parents');
     runPrepare({verbose: true}).then(r => {
       console.log('Total parents:', r.parents.length);
       const emails = r.parents.map(p => p.email);
       console.log('Unique emails:', new Set(emails).size);
     });
   "
   ```
   Total parents should equal unique emails count
</verification>

<success_criteria>
- lib/stadion-db.js has stadion_parents table and all parent functions
- prepare-stadion-parents.js exists with runPrepare() export
- Parents are deduplicated by email (no duplicate email addresses)
- Each parent has childKnvbIds array for relationship linking
- Parents with merged phone numbers from multiple children
- Parents without email are skipped
</success_criteria>

<output>
After completion, create `.planning/phases/07-parent-sync/07-02-SUMMARY.md`
</output>
