---
phase: 11-photo-upload-deletion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - upload-photos-to-stadion.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Photos with state 'downloaded' get uploaded to Stadion"
    - "Photos with state 'pending_delete' get deleted from local storage and Stadion"
    - "Member must have stadion_id before photo upload can proceed"
    - "Upload/delete failures are logged but don't stop batch processing"
  artifacts:
    - path: "upload-photos-to-stadion.js"
      provides: "Photo upload and deletion orchestration"
      exports: ["runPhotoSync"]
      min_lines: 150
  key_links:
    - from: "upload-photos-to-stadion.js"
      to: "lib/stadion-db.js"
      via: "getMembersByPhotoState, updatePhotoState, clearPhotoState"
      pattern: "getMembersByPhotoState.*downloaded|pending_delete"
    - from: "upload-photos-to-stadion.js"
      to: "Stadion API"
      via: "multipart/form-data POST to /stadion/v1/people/{id}/photo"
      pattern: "stadion/v1/people.*photo"
---

<objective>
Create photo sync script that uploads downloaded photos to Stadion and handles photo deletion when photos are removed in Sportlink.

Purpose: Complete the photo sync pipeline by syncing local photos to WordPress and cleaning up removed photos.
Output: `upload-photos-to-stadion.js` with runPhotoSync function handling both upload and delete operations.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-photo-upload-deletion/11-RESEARCH.md

# Key source files for patterns
@lib/stadion-db.js (getMembersByPhotoState, updatePhotoState, clearPhotoState)
@lib/stadion-client.js (stadionRequest pattern, auth headers)
@submit-stadion-sync.js (sequential processing, rate limiting, error handling patterns)
@download-photos-from-sportlink.js (MIME type mapping, file operations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Photo Upload Script</name>
  <files>upload-photos-to-stadion.js</files>
  <action>
Create `upload-photos-to-stadion.js` with `runPhotoSync(options)` function. Handle two phases:

1. **Upload phase**: Query members with photo_state='downloaded' via getMembersByPhotoState. For each member: check stadion_id exists (skip with error if not), find photo file in photos/ directory by checking extensions [jpg, jpeg, png, webp, gif], upload via form-data multipart POST to `/wp-json/stadion/v1/people/{stadion_id}/photo`, update state to 'synced' on success.

2. **Delete phase**: Query members with photo_state='pending_delete'. For each member: delete local file from photos/ directory, DELETE to Stadion endpoint if stadion_id exists (log but continue on Stadion failure), call clearPhotoState on success.

Follow submit-stadion-sync.js pattern: sequential processing with 2s rate limiting between API calls, use createSyncLogger from lib/logger.js, require varlock/auto-load at top. Use form-data package for multipart uploads with https module (not fetch). Log failures and continue (don't fail fast). Return structured result object with upload/delete counts and errors for pipeline integration. Module/CLI hybrid pattern with verbose flag support.
  </action>
  <verify>
Run `node upload-photos-to-stadion.js --verbose` (will report "0 photos pending upload/delete" if no pending photos, which is expected after initial setup).

Check syntax: `node -c upload-photos-to-stadion.js` should show no errors.

Verify module export: `node -e "const { runPhotoSync } = require('./upload-photos-to-stadion'); console.log(typeof runPhotoSync)"` should output "function".
  </verify>
  <done>
Script exists and exports runPhotoSync function. Handles both upload (downloaded -> synced) and delete (pending_delete -> cleared) state transitions. Uses multipart/form-data for uploads, sequential processing with rate limiting, and graceful error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add npm script and explicit dependency</name>
  <files>package.json</files>
  <action>
In package.json:

1. Add form-data as explicit dependency (currently transitive via postmark->axios): `"form-data": "^4.0.0"`

2. Add npm scripts for running photo sync:
   - `"sync-photos": "node upload-photos-to-stadion.js"`
   - `"sync-photos-verbose": "node upload-photos-to-stadion.js --verbose"`

Run `npm install` after adding dependency to update package-lock.json.
  </action>
  <verify>
Run `npm run sync-photos` - should execute without syntax errors and report photo sync status (likely "0 photos pending upload/delete" on fresh run).

Verify form-data is in package.json dependencies: `grep form-data package.json`
  </verify>
  <done>
npm scripts added for `sync-photos` and `sync-photos-verbose`. form-data explicitly declared in dependencies. Users can run `npm run sync-photos` to sync photos to Stadion.
  </done>
</task>

</tasks>

<verification>
1. `node -c upload-photos-to-stadion.js` - No syntax errors
2. `npm run sync-photos` - Executes and reports status
3. Module exports runPhotoSync function for pipeline integration
4. Script handles both upload and delete operations
5. Rate limiting (2s delays) matches existing patterns
6. Error handling logs failures but continues processing
7. form-data is explicit dependency in package.json
</verification>

<success_criteria>
- upload-photos-to-stadion.js exists with runPhotoSync export
- Script processes 'downloaded' photos for upload to Stadion
- Script processes 'pending_delete' photos for local and Stadion deletion
- npm run sync-photos works
- form-data declared as explicit dependency
- Follows existing codebase patterns (module/CLI hybrid, rate limiting, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/11-photo-upload-deletion/11-01-SUMMARY.md`
</output>
