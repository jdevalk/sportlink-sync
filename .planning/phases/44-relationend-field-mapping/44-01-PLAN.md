---
phase: 44-relationend-field-mapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/utils.js
  - steps/prepare-freescout-customers.js
  - steps/submit-freescout-sync.js
autonomous: true

must_haves:
  truths:
    - "RelationEnd date from Sportlink appears in FreeScout custom field ID 9 as YYYY-MM-DD"
    - "Null or invalid RelationEnd dates result in empty string sent to FreeScout (no API errors)"
    - "Date normalization handles YYYYMMDD, YYYY-MM-DD, and ISO 8601 formats correctly"
  artifacts:
    - path: "lib/utils.js"
      provides: "normalizeDateToYYYYMMDD function"
      contains: "normalizeDateToYYYYMMDD"
    - path: "steps/prepare-freescout-customers.js"
      provides: "RelationEnd extraction and normalization in customFields"
      contains: "relation_end"
    - path: "steps/submit-freescout-sync.js"
      provides: "relation_end field ID mapping and payload builder entry"
      contains: "relation_end"
  key_links:
    - from: "steps/prepare-freescout-customers.js"
      to: "lib/utils.js"
      via: "require normalizeDateToYYYYMMDD"
      pattern: "normalizeDateToYYYYMMDD"
    - from: "steps/submit-freescout-sync.js"
      to: "FreeScout API"
      via: "buildCustomFieldsPayload includes relation_end field ID 9"
      pattern: "relation_end.*FREESCOUT_FIELD_RELATION_END"
    - from: "steps/prepare-freescout-customers.js"
      to: "steps/submit-freescout-sync.js"
      via: "customFields.relation_end passed from prepare to submit"
      pattern: "relation_end"
---

<objective>
Add RelationEnd date synchronization to the FreeScout customer sync pipeline.

Purpose: Support agents need membership expiration dates visible in FreeScout without switching to Sportlink. The `lid-tot` ACF field from Rondo Club contains this data but is not yet included in FreeScout custom field submissions.

Output: Three modified files that together extract, normalize, and submit RelationEnd dates as FreeScout custom field ID 9 ("Lid tot").
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-relationend-field-mapping/44-RESEARCH.md
@lib/utils.js
@steps/prepare-freescout-customers.js
@steps/submit-freescout-sync.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add date normalization utility and wire into prepare step</name>
  <files>lib/utils.js, steps/prepare-freescout-customers.js</files>
  <action>
1. In `lib/utils.js`, add a `normalizeDateToYYYYMMDD(dateValue)` function before the `module.exports` block:
   - Accept a string or null/undefined input
   - Return null for falsy, non-string, or empty-after-trim input
   - Handle `YYYYMMDD` format (8 digits): insert hyphens to produce `YYYY-MM-DD`
   - Handle ISO 8601 with `T` separator: split on `T` and return the date part
   - Handle already-correct `YYYY-MM-DD` format: return as-is
   - Return null for any unrecognized format
   - Add it to `module.exports`

2. In `steps/prepare-freescout-customers.js`:
   - Add `normalizeDateToYYYYMMDD` to the destructured import from `../lib/utils` (line 8, alongside `readEnv`)
   - In `prepareCustomer()` function, after the `nikkiData` line (line 193), add:
     ```
     const relationEndRaw = acf['lid-tot'] || null;
     const relationEnd = normalizeDateToYYYYMMDD(relationEndRaw);
     ```
   - Add `relation_end: relationEnd` to the `customFields` object in the return statement (after the `nikki_status` line, around line 227)
  </action>
  <verify>
Run `node -e "const {normalizeDateToYYYYMMDD} = require('./lib/utils'); console.log(normalizeDateToYYYYMMDD('20261231')); console.log(normalizeDateToYYYYMMDD('2026-12-31')); console.log(normalizeDateToYYYYMMDD('2026-12-31T00:00:00Z')); console.log(normalizeDateToYYYYMMDD(null)); console.log(normalizeDateToYYYYMMDD(''));"` should output: `2026-12-31` (three times), then `null` (twice).

Run `node -e "require('./steps/prepare-freescout-customers')"` should not throw (module loads without errors).
  </verify>
  <done>normalizeDateToYYYYMMDD exported from utils.js, handles all documented formats, prepare step extracts acf['lid-tot'] and includes normalized relation_end in customFields</done>
</task>

<task type="auto">
  <name>Task 2: Extend FreeScout submit step with relation_end field mapping</name>
  <files>steps/submit-freescout-sync.js</files>
  <action>
1. In `getCustomFieldIds()` (line 18-26), add a new entry after `nikki_status`:
   ```
   relation_end: parseInt(process.env.FREESCOUT_FIELD_RELATION_END || '9', 10)
   ```

2. In `buildCustomFieldsPayload()` (line 33-42), add a new entry to the return array after the `nikki_status` line:
   ```
   { id: fieldIds.relation_end, value: customFields.relation_end || '' }
   ```
   This follows the existing pattern: null/undefined becomes empty string (FreeScout API expects string values).
  </action>
  <verify>
Run `node -e "require('./steps/submit-freescout-sync')"` should not throw (module loads without errors).

Verify the field mapping is complete by running:
`node -e "const m = require('fs').readFileSync('steps/submit-freescout-sync.js','utf8'); console.log(m.includes('relation_end') && m.includes('FREESCOUT_FIELD_RELATION_END'));"` should output `true`.
  </verify>
  <done>getCustomFieldIds returns relation_end mapped to env var FREESCOUT_FIELD_RELATION_END (default 9), buildCustomFieldsPayload includes relation_end with empty string fallback for null values</done>
</task>

</tasks>

<verification>
1. All three files modified: `lib/utils.js`, `steps/prepare-freescout-customers.js`, `steps/submit-freescout-sync.js`
2. `normalizeDateToYYYYMMDD` correctly normalizes YYYYMMDD, YYYY-MM-DD, and ISO 8601 formats
3. `normalizeDateToYYYYMMDD` returns null for invalid/empty/null input
4. `prepareCustomer()` extracts `acf['lid-tot']` and adds normalized `relation_end` to customFields
5. `getCustomFieldIds()` includes `relation_end` with env var + default 9
6. `buildCustomFieldsPayload()` includes `relation_end` with empty string fallback
7. No new dependencies added â€” all changes use existing patterns and libraries
</verification>

<success_criteria>
- `normalizeDateToYYYYMMDD('20261231')` returns `'2026-12-31'`
- `normalizeDateToYYYYMMDD(null)` returns `null`
- Prepare step output includes `customFields.relation_end` for members with `lid-tot` ACF data
- Submit step sends field ID 9 with YYYY-MM-DD value to FreeScout API
- Members without RelationEnd get empty string for field ID 9 (no API errors)
</success_criteria>

<output>
After completion, create `.planning/phases/44-relationend-field-mapping/44-01-SUMMARY.md`
</output>
