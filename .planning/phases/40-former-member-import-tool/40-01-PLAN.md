---
phase: 40-former-member-import-tool
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/import-former-members.js
  - steps/download-inactive-members.js
autonomous: true

must_haves:
  truths:
    - "Tool authenticates to Sportlink and downloads INACTIVE members via status filter toggle"
    - "Former members sync to Rondo Club with acf.former_member = true"
    - "Active members already in stadion_members are skipped (no duplicates created)"
    - "Dry-run mode shows what would be synced without making changes"
    - "Tool outputs progress counts (downloaded, synced, skipped, failed)"
  artifacts:
    - path: "steps/download-inactive-members.js"
      provides: "Playwright-based download of inactive members from Sportlink"
      contains: "scStatus"
    - path: "tools/import-former-members.js"
      provides: "Main orchestrator: download, prepare, sync with dry-run support"
      contains: "--import"
  key_links:
    - from: "tools/import-former-members.js"
      to: "steps/download-inactive-members.js"
      via: "require and function call"
      pattern: "require.*download-inactive-members"
    - from: "tools/import-former-members.js"
      to: "lib/rondo-club-client.js"
      via: "rondoClubRequest for person create/update"
      pattern: "rondoClubRequest"
    - from: "tools/import-former-members.js"
      to: "lib/rondo-club-db.js"
      via: "openDb for duplicate checking"
      pattern: "openDb|stadion_members"
---

<objective>
Create the former member import tool: a Playwright-based download step that toggles Sportlink status filters to INACTIVE, and an orchestrator tool that downloads, prepares, and syncs former members to Rondo Club with `acf.former_member = true`.

Purpose: Enable one-time import of former members for tracking outstanding payments/equipment.
Output: `tools/import-former-members.js` (orchestrator with dry-run) and `steps/download-inactive-members.js` (Sportlink download).
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/40-former-member-import-tool/40-RESEARCH.md

Key source files to reference:
@steps/download-data-from-sportlink.js — Active member download pattern (login, status filters, SearchMembers API capture)
@steps/prepare-rondo-club-members.js — preparePerson() function for Sportlink-to-Rondo-Club data transformation
@steps/submit-rondo-club-sync.js — syncPerson() and markFormerMembers() patterns, rondoClubRequest usage
@lib/rondo-club-db.js — openDb(), stadion_members table schema, upsertMembers()
@lib/rondo-club-client.js — rondoClubRequest({status, body} return format)
@lib/sportlink-login.js — loginToSportlink() function
@tools/merge-duplicate-parents.js — Tool pattern with dry-run support (--merge flag)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create download-inactive-members step</name>
  <files>steps/download-inactive-members.js</files>
  <action>
Create `steps/download-inactive-members.js` following the exact pattern of `steps/download-data-from-sportlink.js`.

**Core logic:**
1. Launch Playwright browser, create context and page
2. Call `loginToSportlink(page, { logger })` from `lib/sportlink-login.js`
3. Navigate to `https://club.sportlink.com/member/search`, wait for `networkidle`
4. Click `#btnShowMore` to reveal filter options
5. **Toggle status filter to show INACTIVE members.** The Sportlink search page has status filter chips. The exact UI needs discovery, but likely patterns are:
   - Look for status-related checkboxes/chips near the search filters. The active member download does NOT toggle any status (defaults to active). For inactive members, uncheck the "Actief" (active) status and check "Niet-actief" (inactive) status.
   - Try selector strategies in order: `[id*="scStatus"]` elements, text-based `getByText('Niet-actief')` or `getByText('Inactief')`, role-based `getByRole('checkbox', { name: /niet.?actief|inactief/i })`.
   - Use `page.waitForSelector` with 20s timeout. If the first strategy fails, try the next.
   - Add verbose logging of which selector strategy succeeded for operator debugging.
6. Also check the `#scFetchUnionTeams_input` checkbox (same as active download)
7. Set up response listener for SearchMembers POST before clicking search: `page.waitForResponse(resp => resp.url().includes('/navajo/entity/common/clubweb/member/search/SearchMembers') && resp.request().method() === 'POST', { timeout: 60000 })`
8. Click `#btnSearch`, await response
9. Parse response JSON, extract `jsonData.Members` array
10. Return `{ success: boolean, members: Array, memberCount: number }`

**Important differences from active download:**
- Do NOT store results in sportlink_runs table (this is a one-time tool, not a recurring pipeline)
- Return the raw members array directly (not just count) so the orchestrator can process them
- Export `runDownloadInactive(options)` function following module/CLI hybrid pattern
- Include `--verbose` CLI flag support

**Error handling:**
- Return `{ success: false, members: [], memberCount: 0, error: errorMsg }` on failure
- Log status filter discovery steps verbosely for debugging
- Use try/finally to ensure browser closure
  </action>
  <verify>
Run `node steps/download-inactive-members.js --verbose` on the production server. It should:
1. Log in to Sportlink successfully
2. Toggle status filter (logged verbosely)
3. Return inactive member count > 0
4. Exit cleanly

Note: This MUST be run on the server (46.202.155.16), never locally.
  </verify>
  <done>
`steps/download-inactive-members.js` exists, exports `runDownloadInactive()`, can authenticate to Sportlink, toggle inactive status filter, and return an array of inactive member records from SearchMembers API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create import-former-members orchestrator tool</name>
  <files>tools/import-former-members.js</files>
  <action>
Create `tools/import-former-members.js` as the main orchestrator following the `tools/merge-duplicate-parents.js` pattern.

**CLI interface:**
- `node tools/import-former-members.js` — Dry run (default, shows what would happen)
- `node tools/import-former-members.js --import` — Actually syncs former members
- `node tools/import-former-members.js --verbose` — Verbose output
- `node tools/import-former-members.js --import --verbose` — Verbose actual import
- `node tools/import-former-members.js --skip-download` — Skip Sportlink download, use cached data from previous run (for resuming after partial failure)

**Main function `runImport(options)`:**

```javascript
async function runImport(options = {}) {
  const { dryRun = true, verbose = false, skipDownload = false } = options;
```

**Step 1: Download inactive members** (unless `--skip-download`)
- Call `runDownloadInactive({ verbose })` from `steps/download-inactive-members.js`
- Store raw members JSON to `data/former-members.json` for caching/resume
- If `skipDownload`, read from `data/former-members.json` instead
- Log: `Downloaded ${count} inactive members from Sportlink`

**Step 2: Prepare and filter members**
- Reuse `preparePerson()` from `steps/prepare-rondo-club-members.js` for data transformation. Import it directly. This transforms Sportlink format to Rondo Club ACF format.
- After calling preparePerson(), override `data.acf.former_member = true` (preparePerson sets it to false for active members)
- Check `stadion_members` table by `knvb_id` for each member:
  - If member exists with a `stadion_id` AND `last_synced_hash` is not null: skip (already synced as active or former)
  - If member does not exist in database: mark for sync (new former member)
- Use `isValidMember()` from prepare-rondo-club-members.js for validation
- Log counts: `${toSync.length} former members to sync, ${skipped.length} already exist`

**Step 3: Sync to Rondo Club** (skip if dry-run)
- For each member to sync:
  - POST to `wp/v2/people` via `rondoClubRequest()` from `lib/rondo-club-client.js` (note: returns `{status, body}`)
  - The body should include `status: 'publish'` and all ACF fields with `former_member: true`
  - On success: track in `stadion_members` table via `upsertMembers()` from `lib/rondo-club-db.js` so the member is tracked and won't be re-imported
  - After upsert, update `stadion_id` in the database with the returned WordPress post ID using `updateSyncState(db, knvb_id, stadion_id, source_hash)`
  - Rate limit: 2 second delay between requests (same as existing sync patterns)
  - On error: increment failed count, log error, continue to next member
  - Progress: log every 10 members: `Progress: ${i}/${total} (${synced} synced, ${skipped} skipped, ${failed} failed)`

**Step 4: Summary output**
```
=== SUMMARY ===
Downloaded: 150
To sync: 120
Skipped (active): 25
Skipped (already former): 5
Synced: 118
Failed: 2
Errors:
  - KNVB123: 500 Internal Server Error
  - KNVB456: Timeout
```

If dry-run: `Run with --import to actually sync these members.`

**Stats return object:**
```javascript
return {
  downloaded: number,
  toSync: number,
  synced: number,
  skippedActive: number,
  skippedFormer: number,
  failed: number,
  errors: Array
};
```

**Key implementation notes:**
- Use `require('varlock/auto-load')` at top for .env loading
- Import `rondoClubRequest` from `lib/rondo-club-client.js` (NOT the inline version from merge-duplicate-parents.js). Note: shared client returns `{status, body}`.
- Import `openDb`, `getAllTrackedMembers`, `upsertMembers`, `updateSyncState`, `computeSourceHash` from `lib/rondo-club-db.js`
- Import `preparePerson`, `isValidMember` from `steps/prepare-rondo-club-members.js`
- Import `runDownloadInactive` from `steps/download-inactive-members.js`
- The `stadion_members` table does NOT have a `former_member` column — former status is stored in WordPress ACF. Check if member exists by querying `stadion_members WHERE knvb_id = ?`. If a row exists with a non-null `stadion_id`, the member is already tracked.
- For creating new persons, the POST body needs: `{ status: 'publish', acf: { ...all fields, former_member: true } }`
- WordPress PUT requires `first_name` and `last_name` — but we're only doing POST (create), so this gotcha doesn't apply.
  </action>
  <verify>
1. Run `node tools/import-former-members.js --verbose` on server to verify dry-run works (shows download + counts without syncing)
2. If dry-run output looks correct, run `node tools/import-former-members.js --import --verbose` on server to actually sync
3. Verify in Rondo Club that former member records exist with `acf.former_member = true`
4. Run again to verify it skips already-synced members

Note: All runs MUST happen on server (46.202.155.16), never locally.
  </verify>
  <done>
`tools/import-former-members.js` exists, can download inactive members from Sportlink, prepare them for Rondo Club, skip existing active/former members, sync new former members with `acf.former_member = true`, and provides dry-run mode with progress output. The tool uses the `--import` flag to execute (safe by default), handles errors gracefully, and outputs summary counts.
  </done>
</task>

</tasks>

<verification>
Requirements coverage:
- DL-01: download-inactive-members.js toggles status filter to INACTIVE (Task 1)
- DL-02: download-inactive-members.js captures SearchMembers API response (Task 1)
- SYNC-01: import-former-members.js syncs person records with name, contact, address, KNVB ID (Task 2, via preparePerson)
- SYNC-02: import-former-members.js sets acf.former_member = true (Task 2)
- SYNC-04: import-former-members.js checks stadion_members table before syncing (Task 2)
- TOOL-01: One-time tool in tools/ directory (Task 2)
- TOOL-02: Dry-run mode via --import flag absence (Task 2)
- TOOL-03: Progress output with counts (Task 2)

Deferred to Plan 02:
- DL-03: Photo download via MemberHeader API
- SYNC-03: Photo upload to Rondo Club
</verification>

<success_criteria>
1. `node tools/import-former-members.js` (dry-run) downloads inactive members and shows counts without syncing
2. `node tools/import-former-members.js --import` syncs former members to Rondo Club with former_member = true
3. Running the tool a second time skips already-synced members
4. Active members in stadion_members are never duplicated
</success_criteria>

<output>
After completion, create `.planning/phases/40-former-member-import-tool/40-01-SUMMARY.md`
</output>
