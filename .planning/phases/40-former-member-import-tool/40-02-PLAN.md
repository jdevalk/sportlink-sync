---
phase: 40-former-member-import-tool
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - tools/import-former-members.js
autonomous: true

must_haves:
  truths:
    - "Tool downloads photos for former members via MemberHeader API"
    - "Photos upload to their Rondo Club person records"
    - "Photo download/upload integrates into the existing import tool flow"
  artifacts:
    - path: "tools/import-former-members.js"
      provides: "Photo download and upload steps for former members"
      contains: "photo"
  key_links:
    - from: "tools/import-former-members.js"
      to: "lib/photo-utils.js"
      via: "parseMemberHeaderResponse and downloadPhotoFromUrl"
      pattern: "require.*photo-utils"
    - from: "tools/import-former-members.js"
      to: "steps/upload-photos-to-rondo-club.js"
      via: "Photo upload function or inline upload logic"
      pattern: "upload.*photo|multipart"
---

<objective>
Add photo download and upload support to the former member import tool. After syncing former members to Rondo Club, the tool downloads their photos from Sportlink (via MemberHeader API) and uploads them to their Rondo Club person records.

Purpose: Complete the former member import by including profile photos for visual identification.
Output: Updated `tools/import-former-members.js` with photo download/upload steps.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/40-former-member-import-tool/40-RESEARCH.md
@.planning/phases/40-former-member-import-tool/40-01-SUMMARY.md

Key source files to reference:
@steps/download-photos-from-api.js — Photo download pattern: login to Sportlink, visit /other page, capture MemberHeader API response, download photo from signed URL
@steps/upload-photos-to-rondo-club.js — Photo upload pattern: multipart form-data upload to WordPress, findPhotoFile(), validateCredentials()
@lib/photo-utils.js — parseMemberHeaderResponse(), downloadPhotoFromUrl(), mimeToExtension()
@lib/rondo-club-db.js — getMembersNeedingPhotoDownload(), updatePhotoState(), getMembersByPhotoState()
@lib/sportlink-login.js — loginToSportlink()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add photo download and upload to import-former-members tool</name>
  <files>tools/import-former-members.js</files>
  <action>
Extend `tools/import-former-members.js` (created in Plan 01) with two new steps after the member sync step.

**Add CLI flag:** `--skip-photos` to skip photo steps (useful for quick member-only import).

**Step 4 (new): Download photos for former members**

This step requires Playwright because photos come from the MemberHeader API which returns signed URLs during a browser session. Follow the pattern from `steps/download-photos-from-api.js`:

1. Launch Playwright browser, login to Sportlink via `loginToSportlink(page, { logger })`
2. Query the database for former members that were just synced (have `stadion_id`, need photos)
   - After Plan 01 sync, former members are in `stadion_members` table. Query for members whose `knvb_id` is in the set of just-synced members.
   - Alternatively, query members with `photo_state = 'pending_download'` or where `photo_url` is null but they were just imported.
3. For each former member needing a photo:
   - Navigate to the member's /other page: `https://club.sportlink.com/member/${knvbId}/other`
   - Set up response listener BEFORE navigation: `page.waitForResponse(resp => resp.url().includes('/navajo/entity/common/clubweb/member/header/MemberHeader'))`
   - Parse the MemberHeader response using `parseMemberHeaderResponse(data, knvbId)` from `lib/photo-utils.js`
   - If `photo_url` exists, download immediately using `downloadPhotoFromUrl(photoUrl, knvbId, photosDir, logger)` from `lib/photo-utils.js`
   - Update `photo_state` in database using `updatePhotoState(db, knvbId, 'downloaded')` after successful download
   - Wait 500-1500ms between members (random delay, matching existing pattern)
   - On error: log warning, increment photo failed count, continue to next member
4. Close browser
5. Log: `Downloaded ${photoDownloaded} photos for ${total} former members (${photoFailed} failed)`

**Step 5 (new): Upload photos to Rondo Club**

Follow the upload pattern from `steps/upload-photos-to-rondo-club.js`:

1. For each former member with a downloaded photo (photo_state = 'downloaded'):
   - Find the photo file using the extension search pattern from upload-photos-to-rondo-club.js: try `photos/${knvb_id}.{jpg,jpeg,png,webp,gif}`
   - Upload via multipart form-data to WordPress REST API: `POST /wp-json/wp/v2/media` with the photo as attachment, then set as featured image on the person post
   - Actually, the simpler approach: reuse the upload logic from `steps/upload-photos-to-rondo-club.js`. Import `runPhotoUpload()` from that module if it can be called with a filtered member list, OR implement inline using the same `FormData` + `https` pattern.
   - The upload pattern from `upload-photos-to-rondo-club.js` is:
     a. Read photo file from disk
     b. Create FormData with file, title set to member name
     c. POST to `/wp-json/wp/v2/media` with Basic auth
     d. Get media ID from response
     e. PUT to `/wp-json/wp/v2/people/${stadion_id}` with `{ featured_media: mediaId }`
   - Update `photo_state` to 'synced' after successful upload
   - Rate limit: 2 second delay between uploads
   - On error: log warning, increment upload failed count, continue
2. Log: `Uploaded ${uploaded} photos (${uploadFailed} failed)`

**Update summary output** to include photo stats:
```
=== SUMMARY ===
Downloaded: 150
To sync: 120
Skipped (active): 25
Skipped (already former): 5
Synced: 118
Failed: 2

Photos:
  Downloaded: 95
  Uploaded: 93
  No photo: 23
  Failed: 2
```

**Implementation notes:**
- Import `parseMemberHeaderResponse`, `downloadPhotoFromUrl` from `lib/photo-utils.js`
- Import `loginToSportlink` from `lib/sportlink-login.js` (for photo download session)
- Import `chromium` from `playwright` (for photo download)
- Import `FormData` from `form-data` and `https` from node built-in (for photo upload)
- Import `fs` from `fs/promises` and `path` from `path` (for photo file operations)
- Ensure `photos/` directory exists: `await fs.mkdir(photosDir, { recursive: true })`
- The photo download needs its own Sportlink browser session (separate from the member download session which already closed)
- In dry-run mode, skip photo download/upload entirely but report how many members have PersonImageDate set (potential photos)
- Photo steps are non-critical: if they fail, the member sync is still valid. Track photo errors separately.
  </action>
  <verify>
1. Run `node tools/import-former-members.js --import --verbose` on server after Plan 01 has synced members
2. Verify photos are downloaded to `photos/` directory for former members
3. Verify photos appear on former member person records in Rondo Club
4. Run with `--skip-photos` to confirm photos are skipped
5. Run dry-run to confirm photo count estimates are shown

Note: All runs MUST happen on server (46.202.155.16), never locally.
  </verify>
  <done>
`tools/import-former-members.js` includes photo download via MemberHeader API and photo upload to Rondo Club. Former members have profile photos on their person records. The tool reports photo statistics in its summary output. Photo steps can be skipped with `--skip-photos` flag.
  </done>
</task>

</tasks>

<verification>
Requirements coverage:
- DL-03: Photo download via MemberHeader API (Task 1, Step 4)
- SYNC-03: Photo upload to Rondo Club person records (Task 1, Step 5)

All Phase 40 requirements now covered across Plans 01 and 02.
</verification>

<success_criteria>
1. Former member photos download from Sportlink via MemberHeader API
2. Photos upload to corresponding Rondo Club person records
3. Photo statistics appear in tool summary output
4. `--skip-photos` flag allows member-only import without photos
5. Photo failures don't prevent member sync from completing
</success_criteria>

<output>
After completion, create `.planning/phases/40-former-member-import-tool/40-02-SUMMARY.md`
</output>
