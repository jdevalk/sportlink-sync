---
phase: 02-cron-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/cron-wrapper.sh
  - scripts/install-cron.sh
  - package.json
autonomous: true

must_haves:
  truths:
    - "Crontab entry exists that runs sync daily at 6:00 AM Amsterdam time"
    - "Email with custom subject sent after each sync run"
    - "Overlapping executions are prevented by lockfile"
    - "Failed sync triggers retry 2 hours later"
  artifacts:
    - path: "scripts/cron-wrapper.sh"
      provides: "Environment setup, locking, execution"
      executable: true
    - path: "scripts/install-cron.sh"
      provides: "Automated crontab installation"
      executable: true
  key_links:
    - from: "crontab"
      to: "scripts/cron-wrapper.sh"
      via: "cron execution at 6:00 AM"
    - from: "scripts/cron-wrapper.sh"
      to: "npm run sync-all"
      via: "exec after environment setup"
    - from: "scripts/cron-wrapper.sh"
      to: "mail command"
      via: "piped output with custom subject"
---

<objective>
Configure cron to run daily sync at 6:00 AM Amsterdam time with email reports.

Purpose: Automate the sync pipeline so it runs without manual intervention, sending operator an email summary after each run.

Output: Shell wrapper script, install script, and npm command to set up cron automation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cron-automation/02-CONTEXT.md
@.planning/phases/02-cron-automation/02-RESEARCH.md
@.planning/phases/01-summary-output/01-02-SUMMARY.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cron wrapper script</name>
  <files>scripts/cron-wrapper.sh</files>
  <action>
Create scripts/ directory and scripts/cron-wrapper.sh with:

1. Shebang and set -e for error exit
2. Resolve SCRIPT_DIR and PROJECT_DIR using dirname/pwd pattern
3. Create logs/cron directory if needed
4. Flock-based locking using file descriptor pattern:
   - LOCKFILE="$PROJECT_DIR/.cron.lock"
   - exec 200>"$LOCKFILE"
   - flock -n 200 || exit 1
5. Set PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
6. cd to PROJECT_DIR
7. Source .env with set -a / set +a pattern if file exists
8. Generate DATE and LOG_FILE for logging
9. Run npm run sync-all with tee to log file, capture exit code via PIPESTATUS[0]
10. On failure (non-zero exit): touch /tmp/sportlink-sync-retry
11. Pipe output to mail command with custom subject: "Sportlink Sync Report - $(date +%Y-%m-%d)"
12. Exit with captured exit code

Handle email delivery in the wrapper (not crontab MAILTO) to enable custom subject.
Accept optional MAILTO environment variable, defaulting to $MAILTO from .env or empty.

Make script executable: chmod +x scripts/cron-wrapper.sh
  </action>
  <verify>
    bash -n scripts/cron-wrapper.sh  # Syntax check
    ls -la scripts/cron-wrapper.sh | grep -q "^-rwx"  # Executable
  </verify>
  <done>Wrapper script exists, is executable, has locking/environment/email logic</done>
</task>

<task type="auto">
  <name>Task 2: Create cron install script</name>
  <files>scripts/install-cron.sh</files>
  <action>
Create scripts/install-cron.sh with:

1. Shebang and set -e
2. Resolve PROJECT_DIR using dirname/pwd pattern
3. Check if mail command exists, exit with helpful error if not:
   - "Error: 'mail' command not found"
   - "Ubuntu/Debian: sudo apt-get install mailutils"
   - "RHEL/CentOS: sudo yum install mailx"
4. Prompt for operator email: read -p "Enter operator email address: " OPERATOR_EMAIL
5. Validate email is not empty
6. Build CRON_ENTRIES variable with:
   - Comment header with install date
   - CRON_TZ=Europe/Amsterdam
   - TZ=Europe/Amsterdam
   - Main job: 0 6 * * * using flock -w 0 with absolute path to wrapper
   - Retry job: 0 8 * * * checking for /tmp/sportlink-sync-retry flag file
7. Append to crontab using: (crontab -l 2>/dev/null || true; echo "$CRON_ENTRIES") | crontab -
8. Print success message and helpful commands (crontab -l to view, crontab -r to remove)

Use proper escaping for cron special characters (% becomes \%).
Pass MAILTO=$OPERATOR_EMAIL as environment in the cron entry.

Make script executable: chmod +x scripts/install-cron.sh
  </action>
  <verify>
    bash -n scripts/install-cron.sh  # Syntax check
    ls -la scripts/install-cron.sh | grep -q "^-rwx"  # Executable
  </verify>
  <done>Install script exists, is executable, prompts for email, installs crontab</done>
</task>

<task type="auto">
  <name>Task 3: Add npm script for cron installation</name>
  <files>package.json</files>
  <action>
Add to package.json scripts:
  "install-cron": "bash scripts/install-cron.sh"

Keep existing scripts unchanged.
  </action>
  <verify>
    node -e "const p = require('./package.json'); if (!p.scripts['install-cron']) throw 'missing'"
  </verify>
  <done>npm run install-cron command available</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `bash -n scripts/cron-wrapper.sh && bash -n scripts/install-cron.sh` - both pass syntax check
2. Run `ls -la scripts/*.sh` - both scripts are executable
3. Run `npm run install-cron --help 2>&1 || true` - command is recognized
4. Verify scripts reference correct paths and have proper locking logic
</verification>

<success_criteria>
- scripts/cron-wrapper.sh exists and is executable
- scripts/install-cron.sh exists and is executable
- npm run install-cron command available
- Wrapper handles: PATH, .env, locking, logging, retry flag, email
- Installer handles: mail check, email prompt, crontab installation
- Both scripts use proper shell patterns from RESEARCH.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-cron-automation/02-01-SUMMARY.md`
</output>
