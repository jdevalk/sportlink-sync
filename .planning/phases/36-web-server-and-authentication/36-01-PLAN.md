---
phase: 36-web-server-and-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .gitignore
  - lib/web-server.js
  - lib/auth.js
  - lib/user-config.js
  - views/login.ejs
  - public/style.css
  - scripts/hash-password.js
  - config/users.example.json
  - systemd/rondo-sync-web.service
  - nginx/sync.rondo.club.conf
autonomous: true

must_haves:
  truths:
    - "Fastify server starts on localhost:3000, serves login page at /login"
    - "Unauthenticated requests to / redirect to /login"
    - "Valid credentials (from users.json) create session, redirect to /"
    - "Invalid credentials show generic error on login page"
    - "Session persists across requests (cookie-based, SQLite-backed)"
    - "Logout destroys session and redirects to /login"
    - "Login endpoint is rate-limited (5/min per IP)"
    - "hash-password.js utility generates Argon2id hashes"
  artifacts:
    - path: "lib/web-server.js"
      provides: "Fastify server setup, plugin registration, route definitions, listen"
      min_lines: 80
    - path: "lib/auth.js"
      provides: "requireAuth preHandler hook, login/logout handlers"
      exports: ["requireAuth", "loginHandler", "logoutHandler"]
    - path: "lib/user-config.js"
      provides: "Load and validate users.json config file"
      exports: ["loadUsers"]
    - path: "views/login.ejs"
      provides: "Minimal login form with error display"
      contains: "form method"
    - path: "scripts/hash-password.js"
      provides: "CLI utility to hash passwords for users.json"
    - path: "systemd/rondo-sync-web.service"
      provides: "Systemd unit file for non-root web server"
      contains: "User=sportlink"
    - path: "nginx/sync.rondo.club.conf"
      provides: "Nginx reverse proxy config with TLS placeholders"
      contains: "proxy_pass http://127.0.0.1:3000"
  key_links:
    - from: "lib/web-server.js"
      to: "lib/auth.js"
      via: "imports requireAuth, loginHandler, logoutHandler"
      pattern: "require.*auth"
    - from: "lib/auth.js"
      to: "lib/user-config.js"
      via: "imports loadUsers for credential verification"
      pattern: "require.*user-config"
    - from: "lib/web-server.js"
      to: "@fastify/session"
      via: "plugin registration with SQLite store"
      pattern: "fastify.register.*session"
    - from: "lib/auth.js"
      to: "argon2"
      via: "password verification"
      pattern: "argon2.verify"
---

<objective>
Create the complete Fastify web server application with session-based authentication, login UI, password hashing utility, and deployment configuration files (systemd + nginx).

Purpose: Builds all application code and config files for Phase 36. After this plan, the web server can be started locally for testing and is ready for server deployment.

Output: Working Fastify server with login/logout, session persistence, rate limiting, plus systemd and nginx config files ready for production deployment.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-web-server-and-authentication/36-CONTEXT.md
@.planning/phases/36-web-server-and-authentication/36-RESEARCH.md
@.planning/phases/35-run-tracking/35-01-SUMMARY.md

Key existing files:
@lib/dashboard-db.js
@package.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Fastify web server with authentication</name>
  <files>
    package.json
    lib/web-server.js
    lib/auth.js
    lib/user-config.js
    views/login.ejs
    public/style.css
    scripts/hash-password.js
    config/users.example.json
  </files>
  <action>
    **Step 1: Install npm dependencies**

    ```bash
    npm install fastify @fastify/session @fastify/cookie @fastify/static @fastify/rate-limit @fastify/formbody @fastify/view argon2 ejs fastify-session-better-sqlite3-store
    ```

    Note: @fastify/formbody is needed to parse POST form data from the login form.

    **Step 2: Create `lib/user-config.js`** — Load and validate users from config/users.json

    - Export `loadUsers(configPath)` function
    - Default path: `path.join(process.cwd(), 'config', 'users.json')`
    - Validate: each user has `username` (string), `passwordHash` (string starting with `$argon2id$`), `displayName` (string)
    - Validate: no duplicate usernames
    - Throw descriptive errors on invalid config
    - Return array of user objects
    - Module/CLI hybrid: when run directly, load and print user count

    **Step 3: Create `lib/auth.js`** — Authentication logic

    - Import `loadUsers` from `./user-config`
    - Import `argon2`
    - Export `requireAuth(request, reply)` — preHandler hook that redirects to `/login` if `!request.session.user`
    - Export `loginHandler(request, reply)` — POST /login handler:
      1. Extract `username` and `password` from `request.body`
      2. Find user by username from `loadUsers()`
      3. If not found, render login with error "Invalid username or password" (status 401)
      4. Verify password with `argon2.verify(user.passwordHash, password)`
      5. If invalid, render login with error "Invalid username or password" (status 401)
      6. Call `request.session.regenerate()` for session fixation prevention
      7. Set `request.session.user = { username: user.username, displayName: user.displayName }`
      8. Redirect to `/`
    - Export `logoutHandler(request, reply)` — POST /logout handler:
      1. Call `request.session.destroy()`
      2. Redirect to `/login`

    **Step 4: Create `lib/web-server.js`** — Fastify server setup and lifecycle

    - `require('varlock/auto-load')` at top (loads .env)
    - Import fastify, all plugins, SqliteStore, Database (better-sqlite3), path, fs
    - Import `requireAuth`, `loginHandler`, `logoutHandler` from `./auth`
    - Create and export `buildServer()` function that:
      1. Creates fastify instance with `{ logger: true, trustProxy: true }`
      2. Registers @fastify/cookie
      3. Registers @fastify/formbody
      4. Registers @fastify/session with:
         - `secret`: from `process.env.SESSION_SECRET` (validate >= 32 chars, throw if missing)
         - `cookie`: `{ httpOnly: true, secure: process.env.NODE_ENV === 'production', sameSite: 'lax', maxAge: 1000 * 60 * 60 * 24 * 7 }` (7 days)
         - `store`: new SqliteStore with db at `data/sessions.sqlite` (create data/ dir if needed)
      5. Registers @fastify/rate-limit with `{ global: false }`
      6. Registers @fastify/static with `{ root: path.join(__dirname, '..', 'public'), prefix: '/public/' }`
      7. Registers @fastify/view with `{ engine: { ejs: require('ejs') }, root: path.join(__dirname, '..', 'views') }`
      8. Defines routes:
         - `GET /login` — render `login.ejs` with `{ error: null }` (skip auth check; if already logged in, redirect to `/`)
         - `POST /login` — rate limited (`{ config: { rateLimit: { max: 5, timeWindow: '1 minute' } } }`), calls `loginHandler`
         - `POST /logout` — preHandler: requireAuth, calls `logoutHandler`
         - `GET /health` — unauthenticated, returns `{ status: 'ok', timestamp: new Date().toISOString() }`
         - `GET /` — preHandler: requireAuth, returns simple "Dashboard placeholder" page (will be replaced in Phase 37) with user's displayName and a logout button
      9. Returns the fastify instance
    - Module/CLI hybrid at bottom:
      ```javascript
      if (require.main === module) {
        const HOST = process.env.WEB_HOST || '127.0.0.1';
        const PORT = parseInt(process.env.WEB_PORT || '3000', 10);
        buildServer().then(server => {
          server.listen({ port: PORT, host: HOST }, (err) => {
            if (err) { server.log.error(err); process.exit(1); }
          });
        });
      }
      module.exports = { buildServer };
      ```

    **Step 5: Create `views/login.ejs`** — Minimal login page (from CONTEXT.md: centered form, no branding)

    - DOCTYPE html, meta charset utf-8, meta viewport
    - Title: "Login - Rondo Sync"
    - Link to `/public/style.css`
    - Centered form with:
      - `<h1>Rondo Sync</h1>`
      - Error paragraph (shown only when `error` is truthy): `<p class="error"><%= error %></p>`
      - Username input: type text, name username, placeholder "Username", required, autofocus
      - Password input: type password, name password, placeholder "Password", required
      - Submit button: "Log In"
    - Form action: POST /login

    **Step 6: Create `public/style.css`** — Minimal functional styles

    - Body: sans-serif font, flex center, 100vh, light gray background (#f5f5f5)
    - Form / .card: white background, 2rem padding, 8px border-radius, subtle shadow, 320px max-width
    - h1: 1.5rem, no top margin, 1.5rem bottom margin
    - input: full width, 0.5rem padding, 1rem bottom margin, 1px solid #ddd border, 4px radius, box-sizing border-box
    - button: full width, 0.75rem padding, #007bff background, white text, no border, 4px radius, pointer cursor, hover darken
    - .error: red text, margin-bottom 1rem
    - .dashboard: simple layout with header bar containing user name and logout button

    **Step 7: Create `scripts/hash-password.js`** — CLI utility for generating Argon2id hashes

    - Read password from command line argument: `process.argv[2]`
    - If no argument, print usage: "Usage: node scripts/hash-password.js <password>"
    - Hash with `argon2.hash(password)` (default settings = Argon2id, secure defaults)
    - Print hash to stdout
    - Exit

    **Step 8: Create `config/users.example.json`** — Example user config (committed to git)

    ```json
    [
      {
        "username": "admin",
        "passwordHash": "$argon2id$v=19$m=65536,t=3,p=4$REPLACE_WITH_REAL_HASH",
        "displayName": "Administrator"
      }
    ]
    ```

    **Step 9: Update `.gitignore`** — Add users.json (not the example)

    Add these lines:
    ```
    # User config (contains password hashes)
    config/users.json
    ```

    **Step 10: Add SESSION_SECRET to .env documentation**

    The .env file is not in git, but add a note to the example entries. No .env.example file exists in this project, so just ensure CLAUDE.md references SESSION_SECRET, WEB_HOST, WEB_PORT.
  </action>
  <verify>
    1. `node scripts/hash-password.js testpass123` outputs an Argon2id hash starting with `$argon2id$`
    2. Create a temporary `config/users.json` with a test user using the generated hash
    3. Set `SESSION_SECRET` env var (32+ chars) and run `node lib/web-server.js` — server starts on port 3000
    4. `curl http://127.0.0.1:3000/health` returns `{"status":"ok","timestamp":"..."}`
    5. `curl -L http://127.0.0.1:3000/` redirects to /login (302)
    6. `curl http://127.0.0.1:3000/login` returns HTML with login form
    7. Remove temporary config/users.json after testing
  </verify>
  <done>
    Fastify server starts and serves login page. Unauthenticated requests redirect to /login. Health check endpoint responds. Hash password utility generates valid Argon2id hashes. All source files exist and pass basic smoke test.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create systemd and nginx deployment configs</name>
  <files>
    systemd/rondo-sync-web.service
    nginx/sync.rondo.club.conf
  </files>
  <action>
    **Step 1: Create `systemd/rondo-sync-web.service`**

    ```ini
    [Unit]
    Description=Rondo Sync Dashboard Web Server
    After=network.target

    [Service]
    Type=simple
    User=sportlink
    Group=sportlink
    WorkingDirectory=/home/sportlink
    ExecStart=/usr/bin/node /home/sportlink/lib/web-server.js
    Restart=on-failure
    RestartSec=10
    StartLimitBurst=5
    StartLimitIntervalSec=300
    StandardOutput=journal
    StandardError=journal
    SyslogIdentifier=rondo-sync-web

    # Security hardening (INFRA-04: non-root, minimal permissions)
    NoNewPrivileges=true
    PrivateTmp=true

    # Environment
    Environment=NODE_ENV=production

    [Install]
    WantedBy=multi-user.target
    ```

    Key decisions per CONTEXT.md/RESEARCH.md:
    - User=sportlink (existing user on server, non-root per INFRA-04)
    - Restart=on-failure with 10s delay and burst limit (prevents restart loops)
    - NoNewPrivileges + PrivateTmp for security hardening
    - NODE_ENV=production ensures secure cookies
    - The .env file in /home/sportlink provides SESSION_SECRET and other vars (varlock loads it)

    **Step 2: Create `nginx/sync.rondo.club.conf`**

    ```nginx
    # Rondo Sync Dashboard - nginx reverse proxy
    # Copy to /etc/nginx/sites-available/ and symlink to sites-enabled/
    # Then run: sudo certbot --nginx -d sync.rondo.club

    server {
        listen 80;
        server_name sync.rondo.club;

        # Let's Encrypt will add HTTPS redirect and TLS config via certbot
        # For initial setup, proxy to Fastify directly over HTTP
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
    ```

    Note: certbot will automatically modify this file to add TLS config, the 443 listener, and HTTP-to-HTTPS redirect. We provide only the base HTTP config. This is the standard certbot workflow: create HTTP config first, then `certbot --nginx` adds TLS.
  </action>
  <verify>
    1. `cat systemd/rondo-sync-web.service` contains User=sportlink, NoNewPrivileges=true, Restart=on-failure
    2. `cat nginx/sync.rondo.club.conf` contains proxy_pass to 127.0.0.1:3000 and X-Forwarded-For header
    3. Both files are syntactically correct (no typos, proper INI/nginx format)
  </verify>
  <done>
    Systemd unit file runs web server as non-root sportlink user with automatic restart. Nginx config proxies to localhost:3000 with proper headers for IP forwarding. Both ready to copy to server.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Server starts:** `SESSION_SECRET=test-secret-that-is-at-least-32-chars node lib/web-server.js` starts without errors
2. **Login flow:** GET /login shows form, POST /login with valid credentials creates session, GET / shows dashboard placeholder
3. **Auth enforcement:** GET / without session redirects to /login
4. **Rate limiting:** 6th POST to /login within 1 minute returns 429
5. **Logout:** POST /logout destroys session
6. **Health check:** GET /health returns JSON without auth
7. **Hash utility:** `node scripts/hash-password.js` generates valid Argon2id hash
8. **Config files:** systemd and nginx configs exist with correct content
9. **No secrets committed:** config/users.json is gitignored, SESSION_SECRET is in .env only
</verification>

<success_criteria>
- Fastify server starts on localhost:3000 with all plugins registered
- Login page renders at /login with centered form
- Authentication works: valid credentials create session, invalid show error
- All dashboard routes (/) require authentication
- Sessions persist via SQLite store (not in-memory)
- Rate limiting active on POST /login (5/min)
- hash-password.js utility generates Argon2id hashes
- systemd unit file ready for production deployment
- nginx config ready for production deployment
- No passwords or secrets in committed code
</success_criteria>

<output>
After completion, create `.planning/phases/36-web-server-and-authentication/36-01-SUMMARY.md`
</output>
