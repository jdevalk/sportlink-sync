---
phase: 36-web-server-and-authentication
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified: []
autonomous: false

user_setup:
  - service: DNS
    why: "sync.rondo.club must point to server IP for TLS certificate"
    dashboard_config:
      - task: "Create DNS A record: sync.rondo.club -> 46.202.155.16"
        location: "Domain registrar DNS management panel"

must_haves:
  truths:
    - "A user can navigate to https://sync.rondo.club and see the login page"
    - "A user can log in with their credentials and their session persists across browser refreshes"
    - "All dashboard routes redirect unauthenticated visitors to /login"
    - "The web server process restarts automatically after a crash (systemd)"
    - "The web server runs as the sportlink user, not root"
  artifacts:
    - path: "/home/sportlink/config/users.json"
      provides: "Production user credentials on server"
    - path: "/etc/systemd/system/rondo-sync-web.service"
      provides: "Systemd unit managing the web server"
    - path: "/etc/nginx/sites-enabled/sync.rondo.club.conf"
      provides: "Nginx reverse proxy with TLS"
  key_links:
    - from: "https://sync.rondo.club"
      to: "nginx on port 443"
      via: "DNS A record + TLS certificate"
    - from: "nginx"
      to: "Fastify on 127.0.0.1:3000"
      via: "proxy_pass"
    - from: "systemd"
      to: "node lib/web-server.js"
      via: "ExecStart"
---

<objective>
Deploy the web server to the production server: create user accounts, configure nginx with TLS, enable systemd service, and verify the full HTTPS login flow works in a real browser.

Purpose: Makes the authenticated web server live and accessible at https://sync.rondo.club.

Output: Running web server on production, accessible via HTTPS, with working login/session.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-web-server-and-authentication/36-CONTEXT.md
@.planning/phases/36-web-server-and-authentication/36-RESEARCH.md
@.planning/phases/36-web-server-and-authentication/36-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Set up DNS for sync.rondo.club</name>
  <action>Create a DNS A record pointing sync.rondo.club to 46.202.155.16</action>
  <instructions>
    1. Go to your domain registrar's DNS management panel for rondo.club
    2. Create an A record:
       - Name/Host: `sync`
       - Type: A
       - Value: `46.202.155.16`
       - TTL: 300 (5 minutes, or default)
    3. Wait for DNS propagation (usually 1-5 minutes with low TTL)
    4. Verify: `dig sync.rondo.club` should return 46.202.155.16
  </instructions>
  <resume-signal>Type "dns done" when the A record is created and propagated</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Deploy web server to production</name>
  <files>(server-side files only, no repo changes)</files>
  <action>
    All operations via SSH to root@46.202.155.16.

    **Step 1: Push and pull latest code**
    ```bash
    # Local: git push (should already be done from Plan 01)
    # Remote:
    ssh root@46.202.155.16 "cd /home/sportlink && git pull"
    ```

    **Step 2: Install new npm dependencies on server**
    ```bash
    ssh root@46.202.155.16 "cd /home/sportlink && npm install"
    ```

    **Step 3: Generate SESSION_SECRET and add to .env**
    ```bash
    ssh root@46.202.155.16 "openssl rand -base64 32"
    # Take the output and add to .env:
    ssh root@46.202.155.16 "echo 'SESSION_SECRET=<generated-value>' >> /home/sportlink/.env"
    ```

    **Step 4: Create production users.json**

    Ask the user what username and password they want for the first account. Then:
    1. SSH to server
    2. Run `node scripts/hash-password.js <password>` to get the Argon2id hash
    3. Create `/home/sportlink/config/users.json` with the hash:
    ```json
    [
      {
        "username": "<chosen-username>",
        "passwordHash": "<generated-hash>",
        "displayName": "<display-name>"
      }
    ]
    ```
    4. Set ownership: `chown sportlink:sportlink /home/sportlink/config/users.json`
    5. Set permissions: `chmod 600 /home/sportlink/config/users.json`

    **Step 5: Install and configure nginx**
    ```bash
    # Check if nginx is installed
    ssh root@46.202.155.16 "nginx -v"
    # If not installed: apt install nginx -y

    # Copy config
    ssh root@46.202.155.16 "cp /home/sportlink/nginx/sync.rondo.club.conf /etc/nginx/sites-available/"
    ssh root@46.202.155.16 "ln -sf /etc/nginx/sites-available/sync.rondo.club.conf /etc/nginx/sites-enabled/"
    ssh root@46.202.155.16 "nginx -t && systemctl reload nginx"
    ```

    **Step 6: Set up TLS with Let's Encrypt**
    ```bash
    # Check if certbot is installed
    ssh root@46.202.155.16 "certbot --version"
    # If not installed: apt install certbot python3-certbot-nginx -y

    # Get certificate (certbot will modify nginx config automatically)
    ssh root@46.202.155.16 "certbot --nginx -d sync.rondo.club --non-interactive --agree-tos --email <operator-email>"
    ```

    **Step 7: Install and enable systemd service**
    ```bash
    ssh root@46.202.155.16 "cp /home/sportlink/systemd/rondo-sync-web.service /etc/systemd/system/"
    ssh root@46.202.155.16 "systemctl daemon-reload"
    ssh root@46.202.155.16 "systemctl enable rondo-sync-web.service"
    ssh root@46.202.155.16 "systemctl start rondo-sync-web.service"
    ssh root@46.202.155.16 "systemctl status rondo-sync-web.service"
    ```

    **Step 8: Verify from server**
    ```bash
    # Check service is running
    ssh root@46.202.155.16 "systemctl is-active rondo-sync-web.service"
    # Check health endpoint
    ssh root@46.202.155.16 "curl -s http://127.0.0.1:3000/health"
    # Check nginx proxying
    ssh root@46.202.155.16 "curl -s -o /dev/null -w '%{http_code}' https://sync.rondo.club/health"
    ```

    **Step 9: Test crash recovery**
    ```bash
    # Kill the process and verify systemd restarts it
    ssh root@46.202.155.16 "systemctl kill rondo-sync-web.service"
    sleep 15
    ssh root@46.202.155.16 "systemctl is-active rondo-sync-web.service"
    # Should be "active" after RestartSec=10
    ```
  </action>
  <verify>
    1. `systemctl is-active rondo-sync-web.service` returns "active"
    2. `curl -s http://127.0.0.1:3000/health` returns `{"status":"ok",...}`
    3. `curl -s -o /dev/null -w '%{http_code}' https://sync.rondo.club/health` returns 200
    4. `curl -s -o /dev/null -w '%{http_code}' https://sync.rondo.club/` returns 302 (redirect to /login)
    5. After `systemctl kill`, service restarts within 15 seconds
    6. users.json is owned by sportlink with 600 permissions
  </verify>
  <done>
    Web server running on production server, accessible via HTTPS at sync.rondo.club, managed by systemd with automatic restart. Nginx handles TLS termination and proxies to Fastify. User account created.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify login flow in browser</name>
  <what-built>
    Complete authenticated web server deployed at https://sync.rondo.club with:
    - HTTPS via Let's Encrypt
    - Login page with username/password form
    - Session persistence via secure cookies
    - Systemd-managed process with crash recovery
  </what-built>
  <how-to-verify>
    1. Open https://sync.rondo.club in your browser — you should see the login page
    2. Try logging in with wrong credentials — you should see "Invalid username or password"
    3. Log in with the correct credentials — you should see the dashboard placeholder page with your display name
    4. Refresh the page — you should still be logged in (session persists)
    5. Open a new tab to https://sync.rondo.club — you should still be logged in
    6. Click "Log Out" — you should be redirected to /login
    7. Try accessing https://sync.rondo.club/ directly — you should be redirected to /login
    8. Verify the URL shows HTTPS with a valid certificate (lock icon)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 36 success criteria (from ROADMAP.md):
1. A user can navigate to the dashboard URL in a browser and see a login page over HTTPS
2. A user can log in with their individual username and password, and their session persists across browser refreshes
3. All dashboard routes redirect unauthenticated visitors to the login page
4. The web server process restarts automatically after a crash or server reboot (systemd)
5. The web server runs as a non-root user that cannot read Sportlink/Laposta API credentials
</verification>

<success_criteria>
- https://sync.rondo.club shows login page (TLS, nginx, Fastify all working)
- Login works with configured credentials
- Session persists across browser refresh
- Unauthenticated access redirects to /login
- systemd restarts the server after crash
- Server runs as sportlink user
</success_criteria>

<output>
After completion, create `.planning/phases/36-web-server-and-authentication/36-02-SUMMARY.md`
</output>
