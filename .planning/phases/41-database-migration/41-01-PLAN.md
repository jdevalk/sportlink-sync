---
phase: 41-database-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rondo-club-db.js
  - lib/discipline-db.js
  - lib/sync-origin.js
  - lib/conflict-resolver.js
autonomous: true

must_haves:
  truths:
    - "All stadion_* tables in rondo-sync.sqlite are renamed to rondo_club_* via CREATE+INSERT+DROP migration"
    - "All stadion_id columns are renamed to rondo_club_id across all tables"
    - "All *_stadion_modified columns are renamed to *_rondo_club_modified"
    - "The stadion_id column in discipline_cases (discipline-sync.sqlite) is renamed to rondo_club_id"
    - "Migration runs safely inside a transaction without breaking concurrent sync processes"
    - "All SQL queries throughout rondo-club-db.js reference the new table and column names"
    - "sync_origin values are renamed from *_stadion* to *_rondo_club*"
  artifacts:
    - path: "lib/rondo-club-db.js"
      provides: "Schema with rondo_club_* table names and rondo_club_id columns, plus migration function"
      contains: "rondo_club_members"
    - path: "lib/discipline-db.js"
      provides: "Schema with rondo_club_id column in discipline_cases, plus migration"
      contains: "rondo_club_id"
    - path: "lib/sync-origin.js"
      provides: "Updated sync origin constants using rondo_club instead of stadion"
      contains: "sync_sportlink_to_rondo_club"
    - path: "lib/conflict-resolver.js"
      provides: "Updated conflict resolver using rondo_club column/variable names"
      contains: "rondo_club_value"
  key_links:
    - from: "lib/rondo-club-db.js"
      to: "data/rondo-sync.sqlite"
      via: "openDb() with migration check"
      pattern: "migrateStadionToRondoClub|rondo_club_members"
    - from: "lib/discipline-db.js"
      to: "data/discipline-sync.sqlite"
      via: "openDb() with migration check"
      pattern: "rondo_club_id"
    - from: "lib/sync-origin.js"
      to: "lib/rondo-club-db.js"
      via: "SYNC_FORWARD/SYNC_REVERSE constants used in timestamp column names"
      pattern: "sync_sportlink_to_rondo_club"
---

<objective>
Rename all `stadion_*` table names, `stadion_id` columns, and `*_stadion_modified` columns to `rondo_club_*` equivalents across all database modules, with a safe CREATE+INSERT+DROP migration that works on a live production server.

Purpose: Reflect the product rename from Stadion to Rondo Club in the database layer, which is the foundation for the broader codebase rename in Phase 42.
Output: Updated `lib/rondo-club-db.js`, `lib/discipline-db.js`, `lib/sync-origin.js`, and `lib/conflict-resolver.js` with all stadion references replaced by rondo_club equivalents.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md

Key source files:
@lib/rondo-club-db.js — Main database module with ALL stadion references (2,899 lines, 8 stadion_* tables, stadion_id/stadion_modified columns, 80+ SQL queries)
@lib/discipline-db.js — Discipline database with stadion_id column in discipline_cases (361 lines)
@lib/sync-origin.js — Sync origin constants: SYNC_FORWARD='sync_sportlink_to_stadion', SYNC_REVERSE='sync_stadion_to_sportlink'
@lib/conflict-resolver.js — Conflict resolution with stadion_value, stadion_modified, stadion column references
@lib/detect-rondo-club-changes.js — Change detection querying stadion_members table (will be updated in Phase 42 but must be aware of table name change)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate rondo-club-db.js and sync-origin.js to rondo_club naming</name>
  <files>lib/rondo-club-db.js, lib/sync-origin.js</files>
  <action>
This is the core database migration task. It involves three distinct changes to `lib/rondo-club-db.js`:

**A. Add migration function `migrateStadionToRondoClub(db)`**

Add a new function that checks if old `stadion_*` tables exist and migrates them to `rondo_club_*`. This function must be called inside `openDb()` BEFORE `initDb()` runs.

The migration function must:
1. Check if `stadion_members` table exists: `SELECT name FROM sqlite_master WHERE type='table' AND name='stadion_members'`
2. If it exists, run the full migration inside a single transaction using `db.transaction(() => { ... })()`
3. Use the CREATE+INSERT+DROP pattern (NOT ALTER TABLE RENAME) per the critical project decision in STATE.md
4. Disable foreign keys before migration: `db.pragma('foreign_keys = OFF')`
5. Re-enable after: `db.pragma('foreign_keys = ON')`

For each table, the migration pattern is:
```sql
CREATE TABLE rondo_club_members AS SELECT
  id, knvb_id, [rondo_club_id AS rondo_club_id from stadion_id], email, data_json, ...
FROM stadion_members;
DROP TABLE stadion_members;
```

However, `CREATE TABLE AS SELECT` does not preserve PRIMARY KEY, UNIQUE, CHECK constraints, or indexes. So the correct pattern is:
1. Create the new table with full schema (including constraints): `CREATE TABLE IF NOT EXISTS rondo_club_members (...)`
2. Copy data with column renames: `INSERT INTO rondo_club_members (..., rondo_club_id, ...) SELECT ..., stadion_id, ... FROM stadion_members`
3. Drop old table: `DROP TABLE stadion_members`
4. Recreate all indexes on the new table

**Tables to migrate (8 tables in rondo-sync.sqlite):**

| Old Table | New Table | Column Renames |
|-----------|-----------|----------------|
| `stadion_members` | `rondo_club_members` | `stadion_id` -> `rondo_club_id`, `email_stadion_modified` -> `email_rondo_club_modified`, `email2_stadion_modified` -> `email2_rondo_club_modified`, `mobile_stadion_modified` -> `mobile_rondo_club_modified`, `phone_stadion_modified` -> `phone_rondo_club_modified`, `datum_vog_stadion_modified` -> `datum_vog_rondo_club_modified`, `freescout_id_stadion_modified` -> `freescout_id_rondo_club_modified`, `financiele_blokkade_stadion_modified` -> `financiele_blokkade_rondo_club_modified` |
| `stadion_parents` | `rondo_club_parents` | `stadion_id` -> `rondo_club_id` |
| `stadion_important_dates` | `rondo_club_important_dates` | `stadion_date_id` -> `rondo_club_date_id` |
| `stadion_teams` | `rondo_club_teams` | `stadion_id` -> `rondo_club_id` |
| `stadion_work_history` | `rondo_club_work_history` | `stadion_work_history_id` -> `rondo_club_work_history_id` |
| `stadion_commissies` | `rondo_club_commissies` | `stadion_id` -> `rondo_club_id` |
| `stadion_commissie_work_history` | `rondo_club_commissie_work_history` | `stadion_work_history_id` -> `rondo_club_work_history_id` |
| `stadion_change_detections` | `rondo_club_change_detections` | `stadion_modified_gmt` -> `rondo_club_modified_gmt` |

Also rename columns in `conflict_resolutions` table (NOT prefixed with stadion_ but contains stadion columns):
- `stadion_value` -> `rondo_club_value`
- `stadion_modified` -> `rondo_club_modified`
- `winning_system` values: 'stadion' -> 'rondo_club' (data migration: `UPDATE conflict_resolutions SET winning_system = 'rondo_club' WHERE winning_system = 'stadion'`)

Also update `sync_origin` data values in `rondo_club_members`:
- `UPDATE rondo_club_members SET sync_origin = 'sync_sportlink_to_rondo_club' WHERE sync_origin = 'sync_sportlink_to_stadion'`
- `UPDATE rondo_club_members SET sync_origin = 'sync_rondo_club_to_sportlink' WHERE sync_origin = 'sync_stadion_to_sportlink'`

**Important:** The migration must handle the case where the database has already been migrated (idempotent). Check if `stadion_members` exists; if not, skip migration.

**B. Update initDb() schema to use new names**

Replace ALL `stadion_*` references in the `initDb()` function with `rondo_club_*`. This includes:
- All `CREATE TABLE IF NOT EXISTS stadion_*` -> `CREATE TABLE IF NOT EXISTS rondo_club_*`
- All `CREATE INDEX IF NOT EXISTS idx_stadion_*` -> `CREATE INDEX IF NOT EXISTS idx_rondo_club_*`
- All `ON stadion_*` -> `ON rondo_club_*`
- All column name changes: `stadion_id` -> `rondo_club_id`, etc.
- All `PRAGMA table_info(stadion_*)` -> `PRAGMA table_info(rondo_club_*)`
- All `ALTER TABLE stadion_*` -> `ALTER TABLE rondo_club_*`
- All `sqlite_master` queries referencing `stadion_*` -> `rondo_club_*`
- The photo_state migration block that creates `stadion_members_new` -> `rondo_club_members_new`
- The teams migration block that creates `stadion_teams_new` -> `rondo_club_teams_new`
- Column references in `conflict_resolutions` table: `stadion_value` -> `rondo_club_value`, `stadion_modified` -> `rondo_club_modified`
- Column references in `stadion_change_detections` -> `rondo_club_change_detections`: `stadion_modified_gmt` -> `rondo_club_modified_gmt`

**C. Update ALL SQL queries in functions (the bulk of the work)**

There are ~80 functions with SQL queries. Every reference to `stadion_*` table names, `stadion_id` column, `*_stadion_modified` columns, and related names must be updated. This is a systematic find-and-replace across the entire file:

1. Table name replacements (in all SQL strings):
   - `stadion_members` -> `rondo_club_members`
   - `stadion_parents` -> `rondo_club_parents`
   - `stadion_important_dates` -> `rondo_club_important_dates`
   - `stadion_teams` -> `rondo_club_teams`
   - `stadion_work_history` -> `rondo_club_work_history`
   - `stadion_commissies` -> `rondo_club_commissies`
   - `stadion_commissie_work_history` -> `rondo_club_commissie_work_history`
   - `stadion_change_detections` -> `rondo_club_change_detections`

2. Column name replacements (in SQL strings AND JSDoc/comments):
   - `stadion_id` -> `rondo_club_id` (as column name in queries, return values, and function parameters)
   - `stadion_date_id` -> `rondo_club_date_id`
   - `stadion_work_history_id` -> `rondo_club_work_history_id`
   - `email_stadion_modified` -> `email_rondo_club_modified`
   - `email2_stadion_modified` -> `email2_rondo_club_modified`
   - `mobile_stadion_modified` -> `mobile_rondo_club_modified`
   - `phone_stadion_modified` -> `phone_rondo_club_modified`
   - `datum_vog_stadion_modified` -> `datum_vog_rondo_club_modified`
   - `freescout_id_stadion_modified` -> `freescout_id_rondo_club_modified`
   - `financiele_blokkade_stadion_modified` -> `financiele_blokkade_rondo_club_modified`
   - `stadion_modified_gmt` -> `rondo_club_modified_gmt`
   - `stadion_value` -> `rondo_club_value` (in conflict_resolutions)
   - `stadion_modified` -> `rondo_club_modified` (in conflict_resolutions)

3. Function/export renames:
   - `resetParentStadionIds` -> `resetParentRondoClubIds` (both function name and export)

4. Return value property renames (JavaScript objects):
   - Where functions return `{ ..., stadion_id: row.stadion_id }` -> `{ ..., rondo_club_id: row.rondo_club_id }`
   - Where functions use parameter `rondoClubId` — keep this name as-is (it's already correct)
   - Where function parameters reference `stadionDateId` -> `rondoClubDateId`
   - Where function parameters reference `stadionWorkHistoryId` -> `rondoClubWorkHistoryId`

5. Comments/JSDoc updates:
   - All references to "stadion_id" or "stadion_*" in comments -> "rondo_club_id" or "rondo_club_*"
   - Comment about `sync_origin` values: update `sync_sportlink_to_stadion` -> `sync_sportlink_to_rondo_club`, `sync_stadion_to_sportlink` -> `sync_rondo_club_to_sportlink`

**D. Update lib/sync-origin.js**

Update the sync origin constants:
- `SYNC_FORWARD: 'sync_sportlink_to_stadion'` -> `SYNC_FORWARD: 'sync_sportlink_to_rondo_club'`
- `SYNC_REVERSE: 'sync_stadion_to_sportlink'` -> `SYNC_REVERSE: 'sync_rondo_club_to_sportlink'`
- Update the `getTimestampColumns()` function: `stadion: \`${field}_stadion_modified\`` -> `rondo_club: \`${field}_rondo_club_modified\``
- Update all JSDoc references from "stadion" to "rondo_club"

**E. Integration in openDb()**

Modify `openDb()` so migration runs before schema init:
```javascript
function openDb(dbPath = DEFAULT_DB_PATH) {
  const db = new Database(dbPath);
  db.pragma('journal_mode = WAL');
  db.pragma('busy_timeout = 5000');
  migrateStadionToRondoClub(db);  // NEW: migrate old tables if they exist
  initDb(db);
  return db;
}
```

**CRITICAL: The migration function MUST be idempotent.** If `stadion_members` does not exist (already migrated or fresh install), the migration should silently skip. The `initDb()` with `CREATE TABLE IF NOT EXISTS rondo_club_*` will handle fresh installs.
  </action>
  <verify>
1. Run `node -e "const db = require('./lib/rondo-club-db.js'); const d = db.openDb(); console.log('OK'); d.close()"` on the production server after deploying — should output "OK" without errors.
2. After migration, verify tables exist: `node -e "const Database = require('better-sqlite3'); const db = new Database('data/rondo-sync.sqlite'); console.log(db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\").all().map(r=>r.name).join('\\n')); db.close()"` — should show `rondo_club_members`, `rondo_club_parents`, etc. and NO `stadion_*` tables.
3. Run `node -e "const db = require('./lib/rondo-club-db.js'); const d = db.openDb(); const m = d.prepare('SELECT COUNT(*) as c FROM rondo_club_members').get(); console.log('Members:', m.c); d.close()"` — should show member count > 0.
4. Verify the sync-origin module: `node -e "const o = require('./lib/sync-origin.js'); console.log(o.SYNC_ORIGINS)"` — should show `sync_sportlink_to_rondo_club` and `sync_rondo_club_to_sportlink`.

Note: ALL verification MUST happen on the production server (46.202.155.16), never locally.
  </verify>
  <done>
`lib/rondo-club-db.js` creates tables as `rondo_club_*` instead of `stadion_*`, all columns renamed (`rondo_club_id`, `*_rondo_club_modified`, etc.), migration function safely converts existing databases, all 80+ SQL queries use new names, `resetParentStadionIds` renamed to `resetParentRondoClubIds`, and `lib/sync-origin.js` uses `rondo_club` in constant values and column helpers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate discipline-db.js and conflict-resolver.js to rondo_club naming</name>
  <files>lib/discipline-db.js, lib/conflict-resolver.js</files>
  <action>
**A. Update lib/discipline-db.js**

1. Add a migration function `migrateStadionToRondoClub(db)` that:
   - Checks if `discipline_cases` table has a `stadion_id` column: `PRAGMA table_info(discipline_cases)` and check if any column is named `stadion_id`
   - If yes, uses ALTER TABLE RENAME COLUMN (safe here since discipline-db is only opened by one process at a time — the discipline pipeline runs weekly):
     ```sql
     ALTER TABLE discipline_cases RENAME COLUMN stadion_id TO rondo_club_id
     ```
   - Note: Unlike rondo-club-db.js, we do NOT need CREATE+INSERT+DROP here because:
     - The table name `discipline_cases` is NOT being renamed (it doesn't have a `stadion_` prefix)
     - Only one column (`stadion_id`) needs renaming
     - ALTER TABLE RENAME COLUMN is safe for single-column renames in SQLite 3.25+

2. Call migration in `openDb()` after pragmas, before `initDb()`.

3. Update `initDb()`:
   - Change the migration check: `if (!columns.some(col => col.name === 'stadion_id'))` -> `if (!columns.some(col => col.name === 'rondo_club_id'))`
   - Change the ALTER TABLE: `ALTER TABLE discipline_cases ADD COLUMN stadion_id INTEGER` -> `ALTER TABLE discipline_cases ADD COLUMN rondo_club_id INTEGER`

4. Update `updateCaseSyncState()`:
   - SQL: `SET stadion_id = ?` -> `SET rondo_club_id = ?`

5. Update `getCasesNeedingSync()`:
   - SELECT list: `stadion_id` -> `rondo_club_id`

6. Update `getCaseByDossierId()`:
   - SELECT list: `stadion_id` -> `rondo_club_id`

7. Update all JSDoc comments referencing `stadion_id` to `rondo_club_id`.

**B. Update lib/conflict-resolver.js**

This file has extensive stadion references in its conflict resolution logic. Update:

1. Variable names in `resolveFieldConflicts()`:
   - `const stadionTs = member[cols.stadion]` -> `const rondoClubTs = member[cols.rondo_club]`
   - `const stadionValue = stadionData[field]` -> `const rondoClubValue = rondoClubData[field]`
   - All references to `stadionTs` -> `rondoClubTs`
   - All references to `stadionValue` -> `rondoClubValue`

2. Function parameter names:
   - `stadionData` -> `rondoClubData` in `resolveFieldConflicts()` function signature and JSDoc

3. Return/result values:
   - `winner: 'stadion'` -> `winner: 'rondo_club'`
   - `reason: 'only_stadion_has_history'` -> `reason: 'only_rondo_club_has_history'`
   - `reason: 'stadion_newer'` -> `reason: 'rondo_club_newer'`
   - `stadion_value: String(stadionValue || '')` -> `rondo_club_value: String(rondoClubValue || '')`
   - `stadion_modified: stadionTs` -> `rondo_club_modified: rondoClubTs`

4. Inline tests (if they exist in the file):
   - Update all test data using `stadion_modified`, `stadion_value`, and `*_stadion_modified` column names to their rondo_club equivalents
   - Update test variable names: `stadion1`, `stadion2`, `stadion3` -> `rondoClub1`, `rondoClub2`, `rondoClub3`

5. JSDoc and comments:
   - `@param {Object} stadionData` -> `@param {Object} rondoClubData`
   - All references to "stadion" in comments -> "Rondo Club" or "rondo_club" as appropriate
  </action>
  <verify>
1. Run `node -e "const db = require('./lib/discipline-db.js'); const d = db.openDb(); console.log('OK'); d.close()"` on the production server — should output "OK".
2. Run `node -e "const Database = require('better-sqlite3'); const db = new Database('data/discipline-sync.sqlite'); const cols = db.prepare('PRAGMA table_info(discipline_cases)').all(); console.log(cols.map(c=>c.name).join(', ')); db.close()"` — should include `rondo_club_id` and NOT include `stadion_id`.
3. Run `node -e "const cr = require('./lib/conflict-resolver.js'); console.log(typeof cr.resolveFieldConflicts)"` — should output "function" without errors.
4. Grep to confirm no remaining stadion references: `grep -n 'stadion' lib/discipline-db.js lib/conflict-resolver.js` — should return 0 results.

Note: ALL verification MUST happen on the production server (46.202.155.16), never locally.
  </verify>
  <done>
`lib/discipline-db.js` uses `rondo_club_id` instead of `stadion_id` with safe column rename migration. `lib/conflict-resolver.js` uses `rondoClubData`/`rondoClubValue`/`rondoClubTs` variable names, `rondo_club_value`/`rondo_club_modified` result properties, and `rondo_club` as winner/reason values. No `stadion` references remain in either file.
  </done>
</task>

</tasks>

<verification>
Requirements coverage:
- DB-01: All `stadion_*` tables renamed to `rondo_club_*` in rondo-sync.sqlite (Task 1, 8 tables)
- DB-02: All `stadion_id` columns renamed to `rondo_club_id` (Task 1 for rondo-sync.sqlite, Task 2 for discipline-sync.sqlite)
- DB-03: All `*_stadion_modified` columns renamed to `*_rondo_club_modified` (Task 1, 7 timestamp columns)
- DB-04: Migration runs safely on live server without breaking running syncs (Task 1 uses CREATE+INSERT+DROP in transaction with foreign_keys OFF, Task 2 uses ALTER TABLE RENAME COLUMN)

Additional coverage:
- `conflict_resolutions` table columns renamed (stadion_value -> rondo_club_value, stadion_modified -> rondo_club_modified)
- `sync_origin` values migrated (sync_sportlink_to_stadion -> sync_sportlink_to_rondo_club)
- `lib/sync-origin.js` constants and helpers updated
- `lib/conflict-resolver.js` variable names and return values updated

**What is NOT in this plan (deferred to Phase 42):**
- Updating `steps/`, `pipelines/`, `tools/` code that references `stadion_id` as JavaScript property names — those files consume the return values from these database functions. Phase 42 will update all consumers to use `rondo_club_id` instead of `stadion_id` in their JavaScript code.
- Updating `lib/detect-rondo-club-changes.js` which queries `stadion_members` — this is a code reference change, not a database schema change.
</verification>

<success_criteria>
1. `openDb()` on rondo-sync.sqlite automatically migrates `stadion_*` tables to `rondo_club_*` on first run
2. `openDb()` on discipline-sync.sqlite automatically renames `stadion_id` to `rondo_club_id` on first run
3. Fresh databases (no existing data) create tables with `rondo_club_*` names directly
4. All data is preserved during migration (member count, parent count, team count all match pre-migration)
5. `grep -rn 'stadion' lib/rondo-club-db.js lib/discipline-db.js lib/sync-origin.js lib/conflict-resolver.js` returns 0 matches
6. Migration is idempotent — running openDb() twice does not error
</success_criteria>

<output>
After completion, create `.planning/phases/41-database-migration/41-01-SUMMARY.md`
</output>
