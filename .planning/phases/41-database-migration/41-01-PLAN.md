---
phase: 41-database-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rondo-club-db.js
  - lib/sync-origin.js
autonomous: true

must_haves:
  truths:
    - "All stadion_* tables in rondo-sync.sqlite are renamed to rondo_club_* via CREATE+INSERT+DROP migration"
    - "All stadion_id columns are renamed to rondo_club_id across all tables"
    - "All *_stadion_modified columns are renamed to *_rondo_club_modified"
    - "Migration is idempotent — running openDb() multiple times does not error or corrupt data"
    - "Migration runs safely inside a transaction without breaking concurrent sync processes"
    - "initDb() creates tables with rondo_club_* names for fresh databases"
    - "sync_origin values are renamed from *_stadion* to *_rondo_club*"
  artifacts:
    - path: "lib/rondo-club-db.js"
      provides: "migrateStadionToRondoClub() function and updated initDb() schema with rondo_club_* table names"
      contains: "migrateStadionToRondoClub"
    - path: "lib/sync-origin.js"
      provides: "Updated sync origin constants using rondo_club instead of stadion"
      contains: "sync_sportlink_to_rondo_club"
  key_links:
    - from: "lib/rondo-club-db.js"
      to: "data/rondo-sync.sqlite"
      via: "openDb() calls migrateStadionToRondoClub(db) AFTER pragma statements and BEFORE initDb(db)"
      pattern: "migrateStadionToRondoClub\\(db\\);\\s*initDb\\(db\\)"
    - from: "lib/sync-origin.js"
      to: "lib/rondo-club-db.js"
      via: "SYNC_FORWARD/SYNC_REVERSE constants used in timestamp column names"
      pattern: "sync_sportlink_to_rondo_club"
---

<objective>
Add the stadion-to-rondo_club migration function to `lib/rondo-club-db.js`, update the `initDb()` schema to use `rondo_club_*` names, wire the migration into `openDb()`, and update `lib/sync-origin.js` constants.

Purpose: Create the migration infrastructure and schema foundation. SQL query updates across the 80+ functions are handled in plan 41-02 (depends on this plan).
Output: `lib/rondo-club-db.js` with working migration + updated schema, `lib/sync-origin.js` with rondo_club constants.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md

Key source files:
@lib/rondo-club-db.js — Main database module (2,899 lines). Focus on openDb() (line 19-25), initDb() (line 30 onwards), and module.exports at the end.
@lib/sync-origin.js — Sync origin constants: SYNC_FORWARD='sync_sportlink_to_stadion', SYNC_REVERSE='sync_stadion_to_sportlink', getTimestampColumnNames()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration function, update initDb() schema, wire into openDb(), and update sync-origin.js</name>
  <files>lib/rondo-club-db.js, lib/sync-origin.js</files>
  <action>
This task modifies two specific regions of `lib/rondo-club-db.js` (migration function + initDb + openDb) plus `lib/sync-origin.js`. It does NOT touch the 80+ query functions — those are handled in plan 41-02.

**A. Add migration function `migrateStadionToRondoClub(db)` to lib/rondo-club-db.js**

Add a new function BEFORE the `openDb()` function (i.e., after `computeSourceHash`, before `openDb`). This function checks if old `stadion_*` tables exist and migrates them to `rondo_club_*`.

The migration function must:
1. Check if `stadion_members` table exists: `SELECT name FROM sqlite_master WHERE type='table' AND name='stadion_members'`
2. If it does NOT exist, return immediately (already migrated or fresh install — this is the idempotency check)
3. If it exists, run the full migration inside a single transaction using `db.transaction(() => { ... })()`
4. Disable foreign keys before migration: `db.pragma('foreign_keys = OFF')`
5. Re-enable after: `db.pragma('foreign_keys = ON')`

Use the CREATE+INSERT+DROP pattern (NOT ALTER TABLE RENAME) per the critical project decision. The correct pattern for each table is:
1. Create the new table with full schema (including constraints): `CREATE TABLE IF NOT EXISTS rondo_club_members (...)`
2. Copy data with column renames: `INSERT INTO rondo_club_members (..., rondo_club_id, ...) SELECT ..., stadion_id, ... FROM stadion_members`
3. Drop old table: `DROP TABLE stadion_members`
4. Recreate all indexes on the new table

**Tables to migrate (8 tables in rondo-sync.sqlite):**

| Old Table | New Table | Column Renames |
|-----------|-----------|----------------|
| `stadion_members` | `rondo_club_members` | `stadion_id` -> `rondo_club_id`, `email_stadion_modified` -> `email_rondo_club_modified`, `email2_stadion_modified` -> `email2_rondo_club_modified`, `mobile_stadion_modified` -> `mobile_rondo_club_modified`, `phone_stadion_modified` -> `phone_rondo_club_modified`, `datum_vog_stadion_modified` -> `datum_vog_rondo_club_modified`, `freescout_id_stadion_modified` -> `freescout_id_rondo_club_modified`, `financiele_blokkade_stadion_modified` -> `financiele_blokkade_rondo_club_modified` |
| `stadion_parents` | `rondo_club_parents` | `stadion_id` -> `rondo_club_id` |
| `stadion_important_dates` | `rondo_club_important_dates` | `stadion_date_id` -> `rondo_club_date_id` |
| `stadion_teams` | `rondo_club_teams` | `stadion_id` -> `rondo_club_id` |
| `stadion_work_history` | `rondo_club_work_history` | `stadion_work_history_id` -> `rondo_club_work_history_id` |
| `stadion_commissies` | `rondo_club_commissies` | `stadion_id` -> `rondo_club_id` |
| `stadion_commissie_work_history` | `rondo_club_commissie_work_history` | `stadion_work_history_id` -> `rondo_club_work_history_id` |
| `stadion_change_detections` | `rondo_club_change_detections` | `stadion_modified_gmt` -> `rondo_club_modified_gmt` |

Also rename columns in `conflict_resolutions` table (NOT prefixed with stadion_ but contains stadion columns):
- `stadion_value` -> `rondo_club_value`
- `stadion_modified` -> `rondo_club_modified`
- `winning_system` values: 'stadion' -> 'rondo_club' (data migration: `UPDATE conflict_resolutions SET winning_system = 'rondo_club' WHERE winning_system = 'stadion'`)

Also update `sync_origin` data values in `rondo_club_members`:
- `UPDATE rondo_club_members SET sync_origin = 'sync_sportlink_to_rondo_club' WHERE sync_origin = 'sync_sportlink_to_stadion'`
- `UPDATE rondo_club_members SET sync_origin = 'sync_rondo_club_to_sportlink' WHERE sync_origin = 'sync_stadion_to_sportlink'`

**IMPORTANT:** To get the full CREATE TABLE schema for each table (including all columns from migrations that added columns via ALTER TABLE), read the current `initDb()` function carefully. The `stadion_members` table has many columns added over time. Copy the EXACT schema from `initDb()` but with new names.

**B. Update initDb() schema to use new names**

Replace ALL `stadion_*` references in the `initDb()` function with `rondo_club_*`. This includes:
- All `CREATE TABLE IF NOT EXISTS stadion_*` -> `CREATE TABLE IF NOT EXISTS rondo_club_*`
- All `CREATE INDEX IF NOT EXISTS idx_stadion_*` -> `CREATE INDEX IF NOT EXISTS idx_rondo_club_*`
- All `ON stadion_*` -> `ON rondo_club_*`
- All column name changes: `stadion_id` -> `rondo_club_id`, etc.
- All `PRAGMA table_info(stadion_*)` -> `PRAGMA table_info(rondo_club_*)`
- All `ALTER TABLE stadion_*` -> `ALTER TABLE rondo_club_*`
- All `sqlite_master` queries referencing `stadion_*` -> `rondo_club_*`
- The photo_state migration block that creates `stadion_members_new` -> `rondo_club_members_new`
- The teams migration block that creates `stadion_teams_new` -> `rondo_club_teams_new`
- Column references in `conflict_resolutions` table: `stadion_value` -> `rondo_club_value`, `stadion_modified` -> `rondo_club_modified`
- Column references in `stadion_change_detections` -> `rondo_club_change_detections`: `stadion_modified_gmt` -> `rondo_club_modified_gmt`

**C. Wire migration into openDb()**

Modify `openDb()` so the migration call is inserted AFTER the pragma statements and BEFORE the `initDb(db)` call:
```javascript
function openDb(dbPath = DEFAULT_DB_PATH) {
  const db = new Database(dbPath);
  db.pragma('journal_mode = WAL');
  db.pragma('busy_timeout = 5000');
  migrateStadionToRondoClub(db);  // NEW: after pragmas, before initDb
  initDb(db);
  return db;
}
```

**D. Update lib/sync-origin.js**

Update the sync origin constants:
- `SYNC_FORWARD: 'sync_sportlink_to_stadion'` -> `SYNC_FORWARD: 'sync_sportlink_to_rondo_club'`
- `SYNC_REVERSE: 'sync_stadion_to_sportlink'` -> `SYNC_REVERSE: 'sync_rondo_club_to_sportlink'`
- Update the `getTimestampColumnNames()` function: `stadion: \`${field}_stadion_modified\`` -> `rondo_club: \`${field}_rondo_club_modified\``
- Update all JSDoc references from "stadion" to "rondo_club"
- Update JSDoc `@returns` from `{stadion: string, sportlink: string}` to `{rondo_club: string, sportlink: string}`

**CRITICAL: Do NOT modify any of the 80+ query functions in rondo-club-db.js.** Those are handled by plan 41-02 which depends on this plan. Only touch: the new migration function, `initDb()`, `openDb()`, and the `module.exports` if the migration function needs exporting (it does not — it's internal).
  </action>
  <verify>
1. Verify syntax: `node -e "require('./lib/rondo-club-db.js')"` should not throw (on production server).
2. Verify sync-origin: `node -e "const o = require('./lib/sync-origin.js'); console.log(o.SYNC_ORIGIN)"` — should show `sync_sportlink_to_rondo_club` and `sync_rondo_club_to_sportlink`.
3. Verify getTimestampColumnNames: `node -e "const o = require('./lib/sync-origin.js'); console.log(o.getTimestampColumnNames('email'))"` — should show `{ rondo_club: 'email_rondo_club_modified', sportlink: 'email_sportlink_modified' }`.

Note: Full migration verification (opening production database) happens after plan 41-02 completes, since query functions still reference old names until then. The `require` test above uses fresh in-memory paths that bypass the migration path.

Note: ALL verification MUST happen on the production server (46.202.155.16), never locally.
  </verify>
  <done>
`lib/rondo-club-db.js` has a `migrateStadionToRondoClub(db)` function that safely migrates 8 tables + conflict_resolutions + sync_origin data. `openDb()` calls migration AFTER pragmas and BEFORE `initDb()`. `initDb()` creates all tables with `rondo_club_*` names. `lib/sync-origin.js` uses `rondo_club` in all constants and helpers. Migration is idempotent — skips if `stadion_members` table does not exist.
  </done>
</task>

</tasks>

<verification>
Requirements coverage (partial — schema layer only):
- DB-01: All `stadion_*` table schemas renamed to `rondo_club_*` in initDb() and migration function
- DB-02: All `stadion_id` columns renamed to `rondo_club_id` in schema and migration
- DB-03: All `*_stadion_modified` columns renamed to `*_rondo_club_modified` in schema and migration
- DB-04: Migration runs safely on live server (CREATE+INSERT+DROP in transaction, foreign_keys OFF)

What remains for plan 41-02: All 80+ SQL query functions still reference `stadion_*` names.
What remains for plan 41-03: discipline-db.js and conflict-resolver.js updates.
</verification>

<success_criteria>
1. `migrateStadionToRondoClub(db)` exists and handles CREATE+INSERT+DROP for all 8 tables
2. Migration is idempotent — calling `openDb()` when no `stadion_members` table exists does not error
3. `initDb()` uses `rondo_club_*` for all table and column names
4. `openDb()` calls migration after pragmas, before initDb
5. `lib/sync-origin.js` exports `sync_sportlink_to_rondo_club` and `sync_rondo_club_to_sportlink`
6. `getTimestampColumnNames()` returns `rondo_club` key (not `stadion`)
7. `grep -n 'stadion' lib/sync-origin.js` returns 0 matches
</success_criteria>

<output>
After completion, create `.planning/phases/41-database-migration/41-01-SUMMARY.md`
</output>
