---
phase: 41-database-migration
plan: 03
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - lib/discipline-db.js
  - lib/conflict-resolver.js
autonomous: true

must_haves:
  truths:
    - "The stadion_id column in discipline_cases (discipline-sync.sqlite) is renamed to rondo_club_id"
    - "discipline-db.js migration uses ALTER TABLE RENAME COLUMN (safe — no concurrent access)"
    - "conflict-resolver.js uses rondo_club variable names, return values, and winner/reason strings"
    - "Migration is idempotent — running openDb() multiple times does not error or corrupt data"
    - "No stadion references remain in either file"
  artifacts:
    - path: "lib/discipline-db.js"
      provides: "Schema with rondo_club_id column in discipline_cases, plus migration"
      contains: "rondo_club_id"
    - path: "lib/conflict-resolver.js"
      provides: "Updated conflict resolver using rondo_club column/variable names"
      contains: "rondo_club_value"
  key_links:
    - from: "lib/discipline-db.js"
      to: "data/discipline-sync.sqlite"
      via: "openDb() with migration check for stadion_id column"
      pattern: "rondo_club_id"
    - from: "lib/conflict-resolver.js"
      to: "lib/sync-origin.js"
      via: "getTimestampColumnNames returns rondo_club key (updated in plan 41-01)"
      pattern: "cols\\.rondo_club"
---

<objective>
Update `lib/discipline-db.js` and `lib/conflict-resolver.js` to use `rondo_club` naming throughout, including a column rename migration in discipline-db.js.

Purpose: Complete the database layer rename for the two remaining files. These are independent of the rondo-club-db.js query updates (plan 41-02) and can run in parallel.
Output: Updated `lib/discipline-db.js` with `rondo_club_id` column and migration, updated `lib/conflict-resolver.js` with all stadion references replaced.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-database-migration/41-01-SUMMARY.md

Key source files:
@lib/discipline-db.js — Discipline database with stadion_id column in discipline_cases (361 lines)
@lib/conflict-resolver.js — Conflict resolution with stadion_value, stadion_modified, stadion column references (275 lines)
@lib/sync-origin.js — Already updated in plan 41-01 (getTimestampColumnNames now returns `rondo_club` key)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate discipline-db.js and conflict-resolver.js to rondo_club naming</name>
  <files>lib/discipline-db.js, lib/conflict-resolver.js</files>
  <action>
**A. Update lib/discipline-db.js**

1. Add a migration function `migrateStadionToRondoClub(db)` that:
   - Checks if `discipline_cases` table has a `stadion_id` column: `PRAGMA table_info(discipline_cases)` and check if any column is named `stadion_id`
   - If yes, uses ALTER TABLE RENAME COLUMN (safe here since discipline-db is only opened by one process at a time — the discipline pipeline runs weekly):
     ```sql
     ALTER TABLE discipline_cases RENAME COLUMN stadion_id TO rondo_club_id
     ```
   - If no `stadion_id` column exists, return immediately (already migrated or fresh install — idempotency)
   - Note: Unlike rondo-club-db.js, we do NOT need CREATE+INSERT+DROP here because:
     - The table name `discipline_cases` is NOT being renamed (it doesn't have a `stadion_` prefix)
     - Only one column (`stadion_id`) needs renaming
     - ALTER TABLE RENAME COLUMN is safe for single-column renames in SQLite 3.25+

2. Call migration in `openDb()` AFTER pragma statements and BEFORE `initDb()`:
   ```javascript
   function openDb(dbPath = DEFAULT_DB_PATH) {
     const db = new Database(dbPath);
     db.pragma('journal_mode = WAL');
     db.pragma('busy_timeout = 5000');
     migrateStadionToRondoClub(db);  // NEW: after pragmas, before initDb
     initDb(db);
     return db;
   }
   ```

3. Update `initDb()`:
   - Change the migration check: `if (!columns.some(col => col.name === 'stadion_id'))` -> `if (!columns.some(col => col.name === 'rondo_club_id'))`
   - Change the ALTER TABLE: `ALTER TABLE discipline_cases ADD COLUMN stadion_id INTEGER` -> `ALTER TABLE discipline_cases ADD COLUMN rondo_club_id INTEGER`

4. Update `updateCaseSyncState()`:
   - SQL: `SET stadion_id = ?` -> `SET rondo_club_id = ?`

5. Update `getCasesNeedingSync()`:
   - SELECT list: `stadion_id` -> `rondo_club_id`

6. Update `getCaseByDossierId()`:
   - SELECT list: `stadion_id` -> `rondo_club_id`

7. Update all JSDoc comments referencing `stadion_id` to `rondo_club_id`.

**B. Update lib/conflict-resolver.js**

This file has extensive stadion references in its conflict resolution logic. Update:

1. Variable names in `resolveFieldConflicts()`:
   - `const stadionTs = member[cols.stadion]` -> `const rondoClubTs = member[cols.rondo_club]`
   - `const stadionValue = stadionData[field]` -> `const rondoClubValue = rondoClubData[field]`
   - All references to `stadionTs` -> `rondoClubTs`
   - All references to `stadionValue` -> `rondoClubValue`

2. Function parameter names:
   - `stadionData` -> `rondoClubData` in `resolveFieldConflicts()` function signature and JSDoc

3. Return/result values:
   - `winner: 'stadion'` -> `winner: 'rondo_club'`
   - `reason: 'only_stadion_has_history'` -> `reason: 'only_rondo_club_has_history'`
   - `reason: 'stadion_newer'` -> `reason: 'rondo_club_newer'`
   - `stadion_value: String(stadionValue || '')` -> `rondo_club_value: String(rondoClubValue || '')`
   - `stadion_modified: stadionTs` -> `rondo_club_modified: rondoClubTs`

4. Inline self-tests (the `if (require.main === module)` block at the bottom):
   - Update all test data using `*_stadion_modified` column names to `*_rondo_club_modified`
   - Update test variable names: `stadion1`, `stadion2`, `stadion3` -> `rondoClub1`, `rondoClub2`, `rondoClub3`
   - Update comments: "Rondo Club" references are already correct; change "stadion" references

5. JSDoc and comments:
   - `@param {Object} stadionData` -> `@param {Object} rondoClubData`
   - `Member row from stadion_members` -> `Member row from rondo_club_members`
   - All references to "stadion" in comments -> "Rondo Club" or "rondo_club" as appropriate
  </action>
  <verify>
1. Run `node -e "const db = require('./lib/discipline-db.js'); const d = db.openDb(); console.log('OK'); d.close()"` on the production server — should output "OK".
2. Run `node -e "const Database = require('better-sqlite3'); const db = new Database('data/discipline-sync.sqlite'); const cols = db.prepare('PRAGMA table_info(discipline_cases)').all(); console.log(cols.map(c=>c.name).join(', ')); db.close()"` — should include `rondo_club_id` and NOT include `stadion_id`.
3. Run `node -e "const cr = require('./lib/conflict-resolver.js'); console.log(typeof cr.resolveFieldConflicts)"` — should output "function" without errors.
4. Run `node -e "const cr = require('./lib/conflict-resolver.js'); cr"` (the self-test in the module) — should pass.
5. Run `grep -c 'stadion' lib/discipline-db.js lib/conflict-resolver.js` — should return 0 for both files.

Note: ALL verification MUST happen on the production server (46.202.155.16), never locally.
  </verify>
  <done>
`lib/discipline-db.js` uses `rondo_club_id` instead of `stadion_id` with safe ALTER TABLE RENAME COLUMN migration, wired into openDb() after pragmas and before initDb(). `lib/conflict-resolver.js` uses `rondoClubData`/`rondoClubValue`/`rondoClubTs` variable names, `rondo_club_value`/`rondo_club_modified` result properties, and `rondo_club` as winner/reason values. Self-tests updated. No `stadion` references remain in either file.
  </done>
</task>

</tasks>

<verification>
Requirements coverage:
- DB-02: `stadion_id` renamed to `rondo_club_id` in discipline_cases table
- DB-04: Migration uses ALTER TABLE RENAME COLUMN (safe for single-process discipline pipeline)

Additional coverage:
- `conflict_resolutions` column references updated in conflict-resolver.js
- Self-tests pass with new naming

**What is NOT in this plan (deferred to Phase 42):**
- Updating `steps/submit-discipline-cases.js` and other consumers that use `stadion_id` as JavaScript property name
</verification>

<success_criteria>
1. `grep -c 'stadion' lib/discipline-db.js` returns 0
2. `grep -c 'stadion' lib/conflict-resolver.js` returns 0
3. `openDb()` on discipline-sync.sqlite migrates `stadion_id` column to `rondo_club_id`
4. Migration is idempotent — calling `openDb()` twice does not error
5. `resolveFieldConflicts()` returns `rondo_club` as winner (not `stadion`)
6. Self-test block in conflict-resolver.js runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/41-database-migration/41-03-SUMMARY.md`
</output>
