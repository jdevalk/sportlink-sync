---
phase: 41-database-migration
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - lib/rondo-club-db.js
  - lib/detect-rondo-club-changes.js
autonomous: true

must_haves:
  truths:
    - "All SQL queries throughout rondo-club-db.js reference the new rondo_club_* table and column names"
    - "All function return values use rondo_club_id instead of stadion_id as property names"
    - "All function parameters referencing stadion are renamed to rondo_club equivalents"
    - "resetParentStadionIds is renamed to resetParentRondoClubIds (function + export)"
    - "No stadion references remain in rondo-club-db.js"
    - "No stadion references remain in detect-rondo-club-changes.js"
    - "Migration is idempotent — running openDb() multiple times does not error or corrupt data"
  artifacts:
    - path: "lib/rondo-club-db.js"
      provides: "All 80+ query functions updated to use rondo_club_* table and column names"
      contains: "rondo_club_members"
    - path: "lib/detect-rondo-club-changes.js"
      provides: "Change detection queries updated to use rondo_club_members table and rondo_club_modified_gmt column"
      contains: "rondo_club_members"
  key_links:
    - from: "lib/rondo-club-db.js"
      to: "data/rondo-sync.sqlite"
      via: "All SQL queries use rondo_club_* table names matching the migrated schema from plan 41-01"
      pattern: "FROM rondo_club_members|INTO rondo_club_members|UPDATE rondo_club_members"
---

<objective>
Update all 80+ SQL query functions in `lib/rondo-club-db.js` to use `rondo_club_*` table names, `rondo_club_id` columns, and `*_rondo_club_modified` timestamp columns instead of their `stadion_*` predecessors.

Purpose: Complete the rondo-club-db.js rename that was started in plan 41-01 (which handled migration + schema). This plan handles the bulk find-and-replace across all query functions, plus the SQL queries in `lib/detect-rondo-club-changes.js`.
Output: Fully updated `lib/rondo-club-db.js` and `lib/detect-rondo-club-changes.js` with zero `stadion` references remaining.

CRITICAL DEPLOYMENT NOTE: Do NOT deploy Phase 41 to production until Phase 42 (Code References) is also complete. The migration in openDb() runs automatically and will rename tables, but steps/ and tools/ files still reference old table names until Phase 42 is deployed. Deploy Phase 41 + Phase 42 atomically.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-database-migration/41-01-SUMMARY.md

Key source files:
@lib/rondo-club-db.js — Main database module (2,899 lines). Plan 41-01 already updated initDb(), openDb(), migration function, and sync-origin.js. This plan updates everything AFTER initDb() — all query functions.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all SQL query functions in rondo-club-db.js and detect-rondo-club-changes.js to use rondo_club naming</name>
  <files>lib/rondo-club-db.js, lib/detect-rondo-club-changes.js</files>
  <action>
This is a systematic find-and-replace across all functions in `lib/rondo-club-db.js` AFTER the `initDb()` function. Plan 41-01 already updated `migrateStadionToRondoClub()`, `initDb()`, `openDb()`. This task handles the remaining ~80 functions.

**Strategy:** Use the Edit tool with `replace_all: true` for each replacement pattern. Process replacements in order from most-specific to least-specific to avoid partial matches.

**1. Table name replacements (in all SQL strings, replace_all for each):**
   - `stadion_commissie_work_history` -> `rondo_club_commissie_work_history` (longest first to avoid partial match)
   - `stadion_change_detections` -> `rondo_club_change_detections`
   - `stadion_important_dates` -> `rondo_club_important_dates`
   - `stadion_work_history` -> `rondo_club_work_history`
   - `stadion_commissies` -> `rondo_club_commissies`
   - `stadion_parents` -> `rondo_club_parents`
   - `stadion_members` -> `rondo_club_members`
   - `stadion_teams` -> `rondo_club_teams`

**2. Column name replacements (replace_all for each):**
   - `financiele_blokkade_stadion_modified` -> `financiele_blokkade_rondo_club_modified`
   - `freescout_id_stadion_modified` -> `freescout_id_rondo_club_modified`
   - `datum_vog_stadion_modified` -> `datum_vog_rondo_club_modified`
   - `mobile_stadion_modified` -> `mobile_rondo_club_modified`
   - `email2_stadion_modified` -> `email2_rondo_club_modified`
   - `email_stadion_modified` -> `email_rondo_club_modified`
   - `phone_stadion_modified` -> `phone_rondo_club_modified`
   - `stadion_modified_gmt` -> `rondo_club_modified_gmt`
   - `stadion_work_history_id` -> `rondo_club_work_history_id`
   - `stadion_date_id` -> `rondo_club_date_id`
   - `stadion_value` -> `rondo_club_value`
   - `stadion_modified` -> `rondo_club_modified` (in conflict_resolutions context)
   - `stadion_id` -> `rondo_club_id` (as column name — this is the most common, do last)

**3. Function/export renames:**
   - `resetParentStadionIds` -> `resetParentRondoClubIds` (both function name and in module.exports)

**4. JavaScript variable/parameter renames in function signatures and bodies:**
   - `stadionDateId` -> `rondoClubDateId` (function parameter)
   - `stadionWorkHistoryId` -> `rondoClubWorkHistoryId` (function parameter)

**5. Return value property renames (JavaScript objects):**
   - Where functions return objects with `stadion_id` as a key (e.g., `stadion_id: row.stadion_id`), update to `rondo_club_id: row.rondo_club_id`
   - Note: Some functions already use `rondoClubId` as a JS variable name (camelCase) — those are ALREADY correct and should NOT change

**6. Comments/JSDoc updates:**
   - All references to "stadion_id" or "stadion_*" in comments -> "rondo_club_id" or "rondo_club_*"
   - Comment about `sync_origin` values: update `sync_sportlink_to_stadion` -> `sync_sportlink_to_rondo_club`, `sync_stadion_to_sportlink` -> `sync_rondo_club_to_sportlink`

**IMPORTANT:** After all replacements, verify with grep that NO `stadion` references remain anywhere in the file. If any remain, identify and fix them individually.

**Approach note:** Because the file is 2,899 lines and the replacements are systematic, prefer using `replace_all: true` on the Edit tool to handle each pattern in one operation. Start with the longest/most-specific patterns to avoid partial replacement issues.

**7. Update lib/detect-rondo-club-changes.js (383 lines, 2 SQL queries + variable names):**

This file has direct SQL queries against the database and variable names using `stadion`. Update:

- SQL query at ~line 181: `FROM stadion_members` -> `FROM rondo_club_members`
- SQL query at ~line 212: `FROM stadion_members` -> `FROM rondo_club_members`
- Column reference at ~line 232: `stadion_modified_gmt: member.modified_gmt` -> `rondo_club_modified_gmt: member.modified_gmt`
- Function parameter `stadionData` -> `rondoClubData` in `extractFieldValue()` and `computeTrackedFieldsHash()` (and all internal usages)
- JSDoc: `@param {Object} stadionData` -> `@param {Object} rondoClubData`
- Self-test data at ~line 327: `stadion_modified_gmt` -> `rondo_club_modified_gmt`

After replacements, verify `grep -c 'stadion' lib/detect-rondo-club-changes.js` returns 0.
  </action>
  <verify>
1. Run `grep -c 'stadion' lib/rondo-club-db.js` on the production server — should return 0.
2. Run `grep -c 'stadion' lib/detect-rondo-club-changes.js` on the production server — should return 0.
3. Run `node -e "require('./lib/rondo-club-db.js')"` — should not throw.
4. Run `node -e "require('./lib/detect-rondo-club-changes.js')"` — should not throw.
5. Run `node -e "const db = require('./lib/rondo-club-db.js'); const d = db.openDb(); console.log('OK'); d.close()"` on production server — should output "OK" without errors.
6. After migration, verify tables exist: `node -e "const Database = require('better-sqlite3'); const db = new Database('data/rondo-sync.sqlite'); console.log(db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\").all().map(r=>r.name).join('\\n')); db.close()"` — should show `rondo_club_members`, `rondo_club_parents`, etc. and NO `stadion_*` tables.
7. Run `node -e "const db = require('./lib/rondo-club-db.js'); const d = db.openDb(); const m = d.prepare('SELECT COUNT(*) as c FROM rondo_club_members').get(); console.log('Members:', m.c); d.close()"` — should show member count > 0.
8. Verify `resetParentRondoClubIds` export: `node -e "const db = require('./lib/rondo-club-db.js'); console.log(typeof db.resetParentRondoClubIds)"` — should output "function".

Note: ALL verification MUST happen on the production server (46.202.155.16), never locally.
  </verify>
  <done>
All 80+ SQL query functions in `lib/rondo-club-db.js` use `rondo_club_*` table names, `rondo_club_id` column names, and `*_rondo_club_modified` timestamp columns. `resetParentStadionIds` renamed to `resetParentRondoClubIds`. `lib/detect-rondo-club-changes.js` queries use `rondo_club_members` table and `rondo_club_modified_gmt` column with updated variable names. No `stadion` references remain in either file. `grep -c 'stadion' lib/rondo-club-db.js lib/detect-rondo-club-changes.js` returns 0 for both.
  </done>
</task>

</tasks>

<verification>
Requirements coverage (completes rondo-club-db.js and detect-rondo-club-changes.js):
- DB-01: All query functions now use `rondo_club_*` table names
- DB-02: All query functions use `rondo_club_id` column
- DB-03: All query functions use `*_rondo_club_modified` columns
- CODE-01: `lib/detect-rondo-club-changes.js` SQL queries and variable names updated
- Combined with plan 41-01: rondo-club-db.js is fully migrated

What remains for plan 41-03: discipline-db.js and conflict-resolver.js updates.

**What is NOT in this plan (deferred to Phase 42):**
- Updating `steps/`, `pipelines/`, `tools/` code that references `stadion_id` as JavaScript property names
</verification>

<success_criteria>
1. `grep -c 'stadion' lib/rondo-club-db.js` returns 0
2. `grep -c 'stadion' lib/detect-rondo-club-changes.js` returns 0
3. `node -e "require('./lib/rondo-club-db.js')"` does not throw
4. `node -e "require('./lib/detect-rondo-club-changes.js')"` does not throw
5. `openDb()` on production database succeeds and migrates tables
6. Member count query against `rondo_club_members` returns >0 rows
7. `resetParentRondoClubIds` is exported (old name `resetParentStadionIds` is gone)
8. All data is preserved during migration (member count, parent count, team count match pre-migration)
</success_criteria>

<output>
After completion, create `.planning/phases/41-database-migration/41-02-SUMMARY.md`
</output>
