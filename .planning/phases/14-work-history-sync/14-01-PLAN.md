---
phase: 14-work-history-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stadion-db.js
  - submit-stadion-work-history.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Person in Stadion has work_history entry linking to their team"
    - "Work history shows job_title as Speler and is_current as true"
    - "When member's team changes, old entry gets end_date and new entry created"
    - "Backfilled entries have no start_date (historical)"
    - "Manually created work_history entries in WordPress are preserved"
  artifacts:
    - path: "lib/stadion-db.js"
      provides: "stadion_work_history table and tracking functions"
      exports: ["upsertWorkHistory", "getWorkHistoryNeedingSync", "updateWorkHistorySyncState", "getMemberWorkHistory"]
    - path: "submit-stadion-work-history.js"
      provides: "Work history sync to Stadion"
      exports: ["runSync"]
  key_links:
    - from: "submit-stadion-work-history.js"
      to: "lib/stadion-db.js"
      via: "getAllTeams for team name to stadion_id mapping"
      pattern: "getAllTeams\\(db\\)"
    - from: "submit-stadion-work-history.js"
      to: "/api/wp/v2/people/{id}"
      via: "PUT with acf.work_history array"
      pattern: "stadionRequest.*people.*PUT"
---

<objective>
Create work history sync system that links persons to their teams via ACF repeater field entries

Purpose: Enable tracking of member team assignments with proper history when teams change
Output: SQLite tracking table + sync script that creates/updates work_history entries in Stadion
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-work-history-sync/14-CONTEXT.md
@.planning/phases/14-work-history-sync/14-RESEARCH.md
@.planning/phases/13-team-extraction-and-management/13-01-SUMMARY.md
@lib/stadion-db.js
@submit-stadion-sync.js
@lib/stadion-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add work history tracking to SQLite</name>
  <files>lib/stadion-db.js</files>
  <action>
Add stadion_work_history junction table and supporting functions to lib/stadion-db.js:

**Schema (add to initDb):**
```sql
CREATE TABLE IF NOT EXISTS stadion_work_history (
  id INTEGER PRIMARY KEY,
  knvb_id TEXT NOT NULL,
  team_name TEXT NOT NULL,
  is_backfill INTEGER DEFAULT 0,
  source_hash TEXT NOT NULL,
  last_synced_hash TEXT,
  last_synced_at TEXT,
  created_at TEXT NOT NULL,
  UNIQUE(knvb_id, team_name)
);

CREATE INDEX IF NOT EXISTS idx_stadion_work_history_member
  ON stadion_work_history (knvb_id);
```

**Functions to add:**

1. `computeWorkHistoryHash(knvbId, teamName)` - SHA-256 hash for change detection

2. `upsertWorkHistory(db, workHistoryRecords)` - Bulk insert/update work history records
   - Each record: { knvb_id, team_name, is_backfill }
   - ON CONFLICT updates source_hash
   - Use stableStringify for hash computation

3. `getWorkHistoryNeedingSync(db, force)` - Get records where hash changed
   - Join with stadion_members to get stadion_id for each member
   - Filter by hash mismatch (or all if force=true)
   - Return: [{ knvb_id, team_name, is_backfill, source_hash, stadion_id }]

4. `getMemberWorkHistory(db, knvbId)` - Get all work history for a member
   - Return: [{ team_name, is_backfill, last_synced_at }]

5. `getWorkHistoryByMember(db)` - Get all work history grouped by member
   - Return Map<knvb_id, Set<team_name>> for change detection

6. `updateWorkHistorySyncState(db, knvbId, teamName, sourceHash)` - Mark as synced

7. `deleteWorkHistory(db, knvbId, teamName)` - Remove a work history record

8. `deleteAllMemberWorkHistory(db, knvbId)` - Remove all work history for a member

Export all new functions in module.exports.
  </action>
  <verify>
Run: `node -e "const db = require('./lib/stadion-db'); console.log(Object.keys(db).filter(k => k.includes('WorkHistory')))"` should show all work history functions.
  </verify>
  <done>
stadion_work_history table exists with composite unique key on (knvb_id, team_name). All work history tracking functions exported and usable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create work history sync script</name>
  <files>submit-stadion-work-history.js</files>
  <action>
Create submit-stadion-work-history.js following established patterns from submit-stadion-sync.js and submit-stadion-teams.js:

**Core logic:**

1. **extractMemberTeams(sportlinkMember)** - Extract teams for a member
   - Get from UnionTeams (priority) and ClubTeams (fallback)
   - Return array of team names (member can be in multiple teams)
   - Return empty array if no teams

2. **formatDateForACF(date)** - Convert JS Date to ACF Ymd format (YYYYMMDD)
   - Used for start_date and end_date fields

3. **buildWorkHistoryEntry(teamStadionId, isBackfill)** - Build ACF work_history entry
   - job_title: "Speler"
   - is_current: true
   - start_date: "" if backfill, formatDateForACF(today) if new
   - end_date: ""
   - post_object: teamStadionId (integer)

4. **detectTeamChanges(db, knvbId, currentTeams)** - Compare current vs tracked teams
   - Get tracked teams from getWorkHistoryByMember or getMemberWorkHistory
   - Return { added: [], removed: [], unchanged: [] }

5. **syncWorkHistoryForMember(member, currentTeams, db, teamMap, options)** - Sync one member
   - Skip if no stadion_id (member not yet synced to Stadion)
   - Skip if no currentTeams (member has no team assignment)
   - Detect changes: added, removed, unchanged
   - For added teams:
     - Verify team exists in teamMap (getAllTeams mapping)
     - Create work_history entry with proper start_date
   - For removed teams:
     - End the work_history entry (set end_date, is_current=false)
   - Fetch existing work_history from Stadion (GET /wp/v2/people/{id})
   - Merge: keep manually created entries + update sync entries
   - PUT updated work_history array to Stadion
   - Update SQLite tracking

6. **runSync(options)** - Main orchestration
   - options: { logger, verbose, force, backfillOnly }
   - Open database
   - Load team mapping: getAllTeams(db) -> Map<team_name, stadion_id>
   - Load Sportlink members from SQLite (via laposta-db getAllMembers)
   - For each member:
     - Extract teams using extractMemberTeams
     - Build work history records for upsertWorkHistory
   - Upsert all to stadion_work_history (tracks what teams each member has)
   - Get members needing sync (hash changed or backfillOnly=true)
   - Sync each member's work history
   - Collect and return result: { success, total, synced, created, updated, ended, skipped, errors }

**Edge cases:**
- Member with no teams: skip entirely (don't create work_history)
- Member had teams but now has none: end all existing work_history entries
- Team not found in Stadion: log warning, skip that team
- Preserve manually created entries: filter by comparing with tracked entries

**CLI interface:**
- `--verbose`: Detailed logging
- `--force`: Resync all (not just changed)
- `--backfill-only`: Only process members not yet synced (for initial backfill)

Follow module/CLI hybrid pattern (export runSync, CLI if require.main === module).
  </action>
  <verify>
Run: `node submit-stadion-work-history.js --verbose` should show work history sync progress and results (may show 0 if already synced).
  </verify>
  <done>
submit-stadion-work-history.js creates work_history entries in Stadion linking persons to teams. Members can have multiple teams. Team changes are detected and old entries ended with new entries created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test backfill and change detection</name>
  <files>submit-stadion-work-history.js</files>
  <action>
Test the work history sync with real data:

1. **Initial backfill test:**
   - Run: `node submit-stadion-work-history.js --verbose --backfill-only`
   - Verify: Backfilled entries have empty start_date
   - Verify: job_title = "Speler", is_current = true
   - Check one person in WordPress admin to confirm work_history appears

2. **Idempotency test:**
   - Run the same command again
   - Verify: Shows "0 synced" or "X skipped" (no duplicates created)

3. **Verify SQLite tracking:**
   - Run: `sqlite3 stadion-sync.sqlite "SELECT COUNT(*) FROM stadion_work_history"`
   - Should show count matching members with teams

4. **Inspect sample data:**
   - Run: `sqlite3 stadion-sync.sqlite "SELECT * FROM stadion_work_history LIMIT 5"`
   - Verify: Records have knvb_id, team_name, source_hash, last_synced_hash

If any issues found, fix them in the sync script before completing.
  </action>
  <verify>
Work history sync runs without errors. SQLite has tracking records. Stadion persons have work_history entries with correct team references.
  </verify>
  <done>
Work history sync creates backfilled entries correctly. Hash-based change detection prevents duplicate syncs. SQLite tracks all member-team pairings.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:

1. **SQLite schema:** `sqlite3 stadion-sync.sqlite ".schema stadion_work_history"` shows table with UNIQUE(knvb_id, team_name)

2. **Work history in Stadion:** Pick a member with a team, verify they have work_history entry in WordPress with:
   - job_title = "Speler"
   - is_current = true
   - post_object = correct team ID

3. **Hash change detection:** Modify a member's team in Sportlink data (or force change), run sync again, verify only changed members sync

4. **No regressions:** `npm run sync-all` still works (Phase 15 will integrate work history)
</verification>

<success_criteria>
- [ ] stadion_work_history table exists with proper schema and indexes
- [ ] submit-stadion-work-history.js exports runSync and works as CLI
- [ ] Work history entries created in Stadion with job_title="Speler" and is_current=true
- [ ] Backfilled entries have empty start_date
- [ ] Hash-based change detection prevents duplicate syncs
- [ ] Team changes detected: old entries ended, new entries created
- [ ] Manually created work_history in WordPress preserved (not overwritten)
- [ ] SQLite tracks all member-team pairings
</success_criteria>

<output>
After completion, create `.planning/phases/14-work-history-sync/14-01-SUMMARY.md`
</output>
