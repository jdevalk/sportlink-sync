---
phase: 38-email-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/alert-email.js
  - scripts/sync.sh
  - scripts/send-email.js
  - lib/web-server.js
  - .env.example
autonomous: true

must_haves:
  truths:
    - "A successful pipeline run sends no email"
    - "A pipeline run that crashes or exits non-zero sends an email with pipeline name, timestamp, and dashboard run detail link"
    - "Each failed pipeline sends its own separate email, even when sync-all runs multiple pipelines"
    - "Overdue pipelines trigger a grouped email alert with dashboard overview link"
    - "Overdue alerts repeat with a 4-hour cooldown while pipelines remain overdue"
    - "Alert email subject lines follow the format: [Rondo Sync] FAILED: people pipeline or [Rondo Sync] OVERDUE: people, nikki"
  artifacts:
    - path: "lib/alert-email.js"
      provides: "Alert email module for failure and overdue notifications"
      exports: ["sendFailureAlert", "sendOverdueAlert", "checkAndAlertOverdue"]
    - path: "scripts/sync.sh"
      provides: "Updated sync wrapper that sends failure-only alerts"
      contains: "send-failure-alert"
    - path: "lib/web-server.js"
      provides: "Web server with periodic overdue check"
      contains: "checkAndAlertOverdue"
  key_links:
    - from: "scripts/sync.sh"
      to: "lib/alert-email.js"
      via: "CLI invocation on non-zero exit code"
      pattern: "send-failure-alert"
    - from: "lib/web-server.js"
      to: "lib/alert-email.js"
      via: "periodic setInterval calling checkAndAlertOverdue"
      pattern: "checkAndAlertOverdue"
    - from: "lib/alert-email.js"
      to: "dashboard URL"
      via: "DASHBOARD_URL env var + run ID"
      pattern: "DASHBOARD_URL.*run/"
---

<objective>
Replace always-send email reports with error-only alerts containing dashboard links.

Purpose: Emails become alerts, not reports. Successful runs produce no email (the dashboard is the source of truth). Failed pipeline runs and overdue pipelines trigger minimal emails with clickable links to the dashboard.

Output: New `lib/alert-email.js` module, updated `sync.sh`, overdue check in web server, deleted old `scripts/send-email.js`.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-email-migration/38-CONTEXT.md

@lib/web-server.js
@lib/dashboard-queries.js
@lib/run-tracker.js
@scripts/sync.sh
@scripts/send-email.js
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create alert email module and update sync.sh for failure-only alerts</name>
  <files>lib/alert-email.js, scripts/sync.sh, scripts/send-email.js, .env.example</files>
  <action>
**Create `lib/alert-email.js`** — New module that sends alert emails via Postmark. Does NOT parse log files. Works with pipeline/run data directly.

Functions to implement:

1. `sendFailureAlert({ pipeline, runId, error, startedAt })` — Sends a single failure alert email.
   - Subject: `[Rondo Sync] FAILED: {pipeline} pipeline`
   - Body: Simple HTML with pipeline name, when it failed, error summary, and a clickable link to `${DASHBOARD_URL}/run/${runId}`
   - Uses POSTMARK_API_KEY, POSTMARK_FROM_EMAIL, OPERATOR_EMAIL env vars (same as current)
   - Uses DASHBOARD_URL env var for link construction (e.g., `https://sync.rfreimann.nl`)
   - If POSTMARK_API_KEY is not set, log a warning and return silently (don't crash)

2. `sendOverdueAlert(overduePipelines)` — Sends a grouped overdue alert.
   - Takes array of `{ name, displayName, hoursSince }` objects
   - Subject: `[Rondo Sync] OVERDUE: {comma-separated pipeline names}`
   - Body: Simple HTML listing each overdue pipeline with how long since last run, and a link to `${DASHBOARD_URL}/` (overview page)
   - Same env var pattern as above

3. `checkAndAlertOverdue()` — Checks for overdue pipelines and sends alert if needed.
   - Reuses the PIPELINE_CONFIG overdue thresholds from `lib/dashboard-queries.js` (extract the config into a shared location or import it)
   - Queries dashboard database for latest run per pipeline
   - Computes overdue status same way as `getPipelineOverview()`
   - **4-hour cooldown**: Track last overdue alert timestamp in a module-level variable. Only send if 4+ hours since last alert OR if the set of overdue pipelines has changed (new pipeline became overdue)
   - If any pipelines are overdue, call `sendOverdueAlert()`

The HTML email template should be minimal: clean font stack, max-width 600px, one prominent link button. No log parsing, no complex formatting.

The module should follow the existing module/CLI hybrid pattern:
```javascript
module.exports = { sendFailureAlert, sendOverdueAlert, checkAndAlertOverdue };
if (require.main === module) { /* CLI: send-failure-alert or check-overdue */ }
```

CLI modes:
- `node lib/alert-email.js send-failure-alert --pipeline people --run-id 42` (for sync.sh)
- `node lib/alert-email.js check-overdue` (could be used standalone, but primary use is from web server)

**Update `scripts/sync.sh`**:
- Remove the old email sending block (lines 179-182 that call `scripts/send-email.js`)
- Add a new block after capturing EXIT_CODE that:
  - Only sends email if EXIT_CODE is non-zero (pipeline failure)
  - Extracts the most recent run ID for this pipeline from the dashboard database using a small inline query: `node -e "const db = require('./lib/dashboard-db').openDb(); const row = db.prepare('SELECT id FROM runs WHERE pipeline = ? ORDER BY started_at DESC LIMIT 1').get('$SYNC_TYPE'); console.log(row ? row.id : ''); db.close();"` (or alternatively, make the alert-email.js CLI accept the pipeline name and look up the run ID itself — this is cleaner)
  - Actually, **simplest approach**: Have alert-email.js `send-failure-alert` mode accept `--pipeline {name}` and look up the latest run ID internally. This avoids inline node queries in bash.
  - Calls: `node "$PROJECT_DIR/lib/alert-email.js" send-failure-alert --pipeline "$SYNC_TYPE"`
- Keep log files (they're still useful for debugging, per Claude's discretion). The logging (`tee -a`) stays.

**Delete `scripts/send-email.js`**: Remove the file entirely (cold switch per user decision). Use `git rm`.

**Update `.env.example`**: Add `DASHBOARD_URL=` entry after the existing Postmark/operator entries.

Important implementation details:
- Load env vars with `require('varlock/auto-load')` at the top of alert-email.js
- Use the `postmark` npm package (already in package.json)
- The `From` field should be `Rondo SYNC <${process.env.POSTMARK_FROM_EMAIL}>` (matching current style)
- For the overdue check's database access, use `openDb()` from `lib/dashboard-db.js` and close the connection after the check
  </action>
  <verify>
1. `node lib/alert-email.js --help` or running without args shows usage
2. `scripts/send-email.js` no longer exists
3. `.env.example` contains DASHBOARD_URL
4. In `scripts/sync.sh`, the old send-email.js call is gone and a new failure-alert call is present
5. `grep -c 'send-email.js' scripts/sync.sh` returns 0
  </verify>
  <done>
Alert email module exists with sendFailureAlert, sendOverdueAlert, and checkAndAlertOverdue functions. sync.sh sends failure alerts only on non-zero exit. Old send-email.js is deleted. DASHBOARD_URL added to .env.example.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add periodic overdue check to web server</name>
  <files>lib/web-server.js</files>
  <action>
**Add periodic overdue pipeline check to the Fastify web server** in `lib/web-server.js`.

Implementation:
1. Import `checkAndAlertOverdue` from `../lib/alert-email.js` (use relative path `./alert-email`)
2. After all routes are registered (before the `return app` line), set up a periodic check:
   ```javascript
   // Periodic overdue pipeline check (every 30 minutes)
   const overdueInterval = setInterval(() => {
     checkAndAlertOverdue().catch(err => {
       app.log.error(`Overdue check failed: ${err.message}`);
     });
   }, 30 * 60 * 1000); // 30 minutes
   ```
3. Run the check once on startup (after a short delay to let the server initialize):
   ```javascript
   // Initial overdue check after 10-second startup delay
   setTimeout(() => {
     checkAndAlertOverdue().catch(err => {
       app.log.error(`Initial overdue check failed: ${err.message}`);
     });
   }, 10000);
   ```
4. Clean up interval on server close:
   ```javascript
   app.addHook('onClose', async () => {
     clearInterval(overdueInterval);
     closeDb();
   });
   ```
   Note: the existing `onClose` hook already calls `closeDb()`. Update it to also clear the interval (don't add a second onClose hook — modify the existing one).

This means overdue checks happen:
- 10 seconds after server start
- Every 30 minutes thereafter
- The 4-hour cooldown in `checkAndAlertOverdue()` prevents email spam (at most 1 email per 4 hours while pipelines remain overdue)

Why web server periodic task (not cron): The web server is already a long-running process managed by systemd. Adding a setInterval is simpler than another cron job and keeps email alerting logic co-located. The 30-minute check interval combined with the 4-hour cooldown provides responsive detection without spam.
  </action>
  <verify>
1. `grep 'checkAndAlertOverdue' lib/web-server.js` shows the import and periodic call
2. `grep 'clearInterval' lib/web-server.js` shows cleanup in onClose
3. `grep 'setInterval' lib/web-server.js` shows the 30-minute periodic check
  </verify>
  <done>
Web server runs overdue pipeline checks every 30 minutes, with an initial check on startup. Interval is cleaned up on server shutdown.
  </done>
</task>

</tasks>

<verification>
1. **No email on success**: In sync.sh, the alert email call is gated on `EXIT_CODE != 0`. Successful runs skip the email block entirely.
2. **Failure email with dashboard link**: The alert-email.js `sendFailureAlert` constructs a URL using DASHBOARD_URL + run ID, producing a clickable link in the email body.
3. **Overdue email with dashboard link**: The `sendOverdueAlert` links to the dashboard overview page.
4. **Subject line format**: Verify `[Rondo Sync] FAILED:` and `[Rondo Sync] OVERDUE:` patterns in alert-email.js.
5. **Old email code removed**: `scripts/send-email.js` no longer exists, `sync.sh` has no reference to it.
6. **4-hour cooldown**: `checkAndAlertOverdue` tracks last alert time and skips if within cooldown window.
</verification>

<success_criteria>
- `scripts/send-email.js` does not exist
- `lib/alert-email.js` exports sendFailureAlert, sendOverdueAlert, checkAndAlertOverdue
- `scripts/sync.sh` only sends email on non-zero exit code
- `lib/web-server.js` runs periodic overdue checks
- `.env.example` includes DASHBOARD_URL
- EMAIL-01 satisfied: successful pipeline runs send no email
- EMAIL-02 satisfied: failure emails contain clickable dashboard link to run detail
</success_criteria>

<output>
After completion, create `.planning/phases/38-email-migration/38-01-SUMMARY.md`
</output>
