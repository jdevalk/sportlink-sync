---
phase: 19-photo-api-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stadion-db.js
  - download-data-from-sportlink.js
autonomous: true

must_haves:
  truths:
    - "Members have photo_url and photo_date columns in stadion_members table"
    - "MemberHeader API is captured for ALL members during general page visit"
    - "Photo URL and date are stored for all members (not just function holders)"
  artifacts:
    - path: "lib/stadion-db.js"
      provides: "Photo URL/date columns in stadion_members + MemberHeader capture for all"
      contains: "photo_url TEXT"
    - path: "download-data-from-sportlink.js"
      provides: "MemberHeader API capture during member data download"
      contains: "MemberHeader"
  key_links:
    - from: "download-data-from-sportlink.js"
      to: "lib/stadion-db.js"
      via: "upsertMembers with photo_url and photo_date fields"
      pattern: "photo_url.*photo_date"
---

<objective>
Extend MemberHeader capture to ALL members and add photo_url/photo_date columns to stadion_members table.

Purpose: Phase 17 captured photo data only for members with functions/committees (~500 members). This plan extends capture to ALL members (~700+) during the existing member data download, enabling API-based photo sync for the entire membership.

Output: Schema migration for stadion_members, MemberHeader capture integrated into member download loop.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-memberheader-data-capture/17-01-SUMMARY.md
@.planning/phases/19-photo-api-optimization/19-CONTEXT.md
@.planning/phases/19-photo-api-optimization/19-RESEARCH.md

Key context from research:
- Photo.Url and Photo.PhotoDate already captured for function holders in sportlink_member_free_fields
- Gap: Regular members (no functions) don't have photo data captured
- Solution: Add photo_url/photo_date to stadion_members, capture MemberHeader during member download
- MemberHeader API endpoint: fetched automatically when visiting member detail pages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add photo_url and photo_date columns to stadion_members</name>
  <files>lib/stadion-db.js</files>
  <action>
Add conditional schema migration to add photo_url and photo_date columns to stadion_members table.

In initDb(), after the existing photo state column migrations (around line 243), add:

```javascript
// Add photo URL columns if they don't exist (Phase 19 migration)
if (!memberColumns.some(col => col.name === 'photo_url')) {
  db.exec('ALTER TABLE stadion_members ADD COLUMN photo_url TEXT');
}

if (!memberColumns.some(col => col.name === 'photo_date')) {
  db.exec('ALTER TABLE stadion_members ADD COLUMN photo_date TEXT');
}
```

Update upsertMembers() to accept and store photo_url and photo_date:
1. Add photo_url and photo_date to the INSERT column list
2. Add @photo_url and @photo_date to VALUES
3. Add photo_url = excluded.photo_url and photo_date = excluded.photo_date to ON CONFLICT UPDATE
4. Update the photo_state CASE to use photo_url instead of person_image_date for change detection:

```javascript
photo_state = CASE
  -- Photo added or changed (URL or date differs)
  WHEN excluded.photo_url IS NOT NULL
       AND (stadion_members.photo_url IS NULL
            OR excluded.photo_url != stadion_members.photo_url
            OR excluded.photo_date != stadion_members.photo_date)
    THEN 'pending_download'
  -- Photo removed
  WHEN excluded.photo_url IS NULL
       AND stadion_members.photo_url IS NOT NULL
    THEN 'pending_delete'
  -- No change: keep current state
  ELSE stadion_members.photo_state
END
```

In the rows mapping (around line 406), add:
```javascript
photo_url: member.photo_url || null,
photo_date: member.photo_date || null,
```

Also update photo_state_updated_at CASE logic to match the new photo_url detection.

IMPORTANT: Keep person_image_date column and handling for backwards compatibility during transition.
  </action>
  <verify>
Run: `node -c lib/stadion-db.js` - syntax check passes
Grep for photo_url in the file to confirm column addition
  </verify>
  <done>
stadion_members table has photo_url and photo_date columns.
upsertMembers() accepts and stores photo_url/photo_date.
Photo state detection uses photo_url/photo_date for change detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Capture MemberHeader API for ALL members during download</name>
  <files>download-data-from-sportlink.js</files>
  <action>
Extend the member download loop to capture MemberHeader API response for each member.

1. After navigating to member general page and capturing basic data, set up MemberHeader API capture:

In the member processing loop (where each member's detail page is visited), add MemberHeader capture similar to how Phase 17 captures it in download-functions-from-sportlink.js:

```javascript
// Set up MemberHeader API capture BEFORE navigation
const memberHeaderPromise = page.waitForResponse(
  response => response.url().includes('MemberHeader') && response.status() === 200,
  { timeout: 10000 }
).catch(() => null);

// Navigate to member detail page (existing code)
await page.goto(memberUrl, { waitUntil: 'domcontentloaded' });

// Capture MemberHeader response
const memberHeaderResponse = await memberHeaderPromise;
let photoUrl = null;
let photoDate = null;

if (memberHeaderResponse) {
  try {
    const headerData = await memberHeaderResponse.json();
    photoUrl = headerData?.Photo?.Url || null;
    photoDate = headerData?.Photo?.PhotoDate || null;
  } catch (e) {
    // Log warning but continue - photo data is optional
    if (logger) logger.verbose(`  Failed to parse MemberHeader for ${knvbId}: ${e.message}`);
  }
}
```

2. Include photo_url and photo_date in the member data object that gets returned from processMember():

```javascript
return {
  // ... existing fields
  photo_url: photoUrl,
  photo_date: photoDate,
  person_image_date: personImageDate, // Keep for backwards compatibility
};
```

3. Ensure the photo data flows through to upsertMembers() call.

Note: The MemberHeader API is automatically called by Sportlink when viewing member details. We just need to intercept the response during existing page navigation. No additional page loads required.
  </action>
  <verify>
Run: `node -c download-data-from-sportlink.js` - syntax check passes
Grep for "MemberHeader" in the file to confirm capture implementation
Grep for "photo_url" to confirm it's included in member data
  </verify>
  <done>
MemberHeader API response is captured during member detail page visit.
Photo URL and PhotoDate are extracted and included in member data.
Photo data flows through to database storage via upsertMembers().
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `node -c lib/stadion-db.js` - no syntax errors
2. `node -c download-data-from-sportlink.js` - no syntax errors
3. Grep for photo_url in both files confirms implementation
4. Schema migration code follows existing PRAGMA pattern
5. MemberHeader capture uses same pattern as Phase 17 (Promise setup before navigation)
</verification>

<success_criteria>
- stadion_members table will get photo_url and photo_date columns on next sync
- upsertMembers() stores photo_url and photo_date from member data
- Photo state change detection uses photo_url/photo_date (not just person_image_date)
- MemberHeader API captured for ALL members during regular member download
- Photo URL and PhotoDate extracted and stored for entire membership
- Code passes syntax checks
</success_criteria>

<output>
After completion, create `.planning/phases/19-photo-api-optimization/19-01-SUMMARY.md`
</output>
