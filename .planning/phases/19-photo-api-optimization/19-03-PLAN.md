---
phase: 19-photo-api-optimization
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - sync-people.js
  - scripts/sync.sh
  - scripts/install-cron.sh
autonomous: true

must_haves:
  truths:
    - "Photo download and upload are integrated into hourly people sync"
    - "Photos sync merges into people pipeline (no separate daily photo run)"
    - "Cron schedule removes separate photo sync job"
    - "'scripts/sync.sh photos' still works (aliases to people sync)"
  artifacts:
    - path: "sync-people.js"
      provides: "Integrated photo download and upload steps"
      contains: "runPhotoDownload"
    - path: "scripts/install-cron.sh"
      provides: "Updated cron without separate photo job"
  key_links:
    - from: "sync-people.js"
      to: "download-photos-from-api.js"
      via: "import and runPhotoDownload call"
      pattern: "runPhotoDownload"
    - from: "sync-people.js"
      to: "upload-photos-to-stadion.js"
      via: "import and runPhotoSync call"
      pattern: "runPhotoSync"
---

<objective>
Integrate photo sync into hourly people pipeline and update cron schedules.

Purpose: Merge photo download and upload into the people sync pipeline so photos sync hourly instead of daily. Remove the separate photo sync cron job since it's now redundant.

Output: Updated sync-people.js with photo steps, modified cron configuration.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-photo-api-optimization/19-02-PLAN.md
@.planning/phases/19-photo-api-optimization/19-CONTEXT.md
@sync-people.js (current people sync - needs photo integration)
@upload-photos-to-stadion.js (existing upload - reuse)
@scripts/sync.sh (update photos case)
@scripts/install-cron.sh (remove photo cron job)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate photo download and upload into people sync</name>
  <files>sync-people.js</files>
  <action>
Extend sync-people.js to include photo download and upload steps.

1. **Add imports at top:**
```javascript
const { runPhotoDownload } = require('./download-photos-from-api');
const { runPhotoSync } = require('./upload-photos-to-stadion');
```

2. **Add photo stats to stats object (around line 108):**
```javascript
photos: {
  downloaded: 0,
  uploaded: 0,
  deleted: 0,
  skipped: 0,
  errors: []
}
```

3. **Add photo download step after birthday sync (around line 252):**
```javascript
// Step 6: Photo Download (API-based)
logger.verbose('Downloading photos from Sportlink API...');
try {
  const photoDownloadResult = await runPhotoDownload({ logger, verbose, force });

  stats.photos.downloaded = photoDownloadResult.downloaded;
  if (photoDownloadResult.errors?.length > 0) {
    stats.photos.errors.push(...photoDownloadResult.errors.map(e => ({
      knvb_id: e.knvb_id,
      message: e.message,
      system: 'photo-download'
    })));
  }
} catch (err) {
  logger.error(`Photo download failed: ${err.message}`);
  stats.photos.errors.push({
    message: `Photo download failed: ${err.message}`,
    system: 'photo-download'
  });
}
```

4. **Add photo upload/delete step after download:**
```javascript
// Step 7: Photo Upload/Delete
logger.verbose('Syncing photos to Stadion...');
try {
  const photoSyncResult = await runPhotoSync({ logger, verbose });

  stats.photos.uploaded = photoSyncResult.upload.synced;
  stats.photos.deleted = photoSyncResult.delete.deleted;
  stats.photos.skipped = photoSyncResult.upload.skipped;

  if (photoSyncResult.upload.errors?.length > 0) {
    stats.photos.errors.push(...photoSyncResult.upload.errors.map(e => ({
      knvb_id: e.knvb_id,
      message: e.message,
      system: 'photo-upload'
    })));
  }
  if (photoSyncResult.delete.errors?.length > 0) {
    stats.photos.errors.push(...photoSyncResult.delete.errors.map(e => ({
      knvb_id: e.knvb_id,
      message: e.message,
      system: 'photo-delete'
    })));
  }
} catch (err) {
  logger.error(`Photo sync failed: ${err.message}`);
  stats.photos.errors.push({
    message: `Photo sync failed: ${err.message}`,
    system: 'photo-sync'
  });
}
```

5. **Update printSummary to include photo stats (add after BIRTHDAY SYNC section):**
```javascript
logger.log('PHOTO SYNC');
logger.log(minorDivider);
if (stats.photos.downloaded > 0 || stats.photos.uploaded > 0 || stats.photos.deleted > 0) {
  logger.log(`Downloaded: ${stats.photos.downloaded}, Uploaded: ${stats.photos.uploaded}, Deleted: ${stats.photos.deleted}`);
  if (stats.photos.skipped > 0) {
    logger.log(`Skipped: ${stats.photos.skipped} (no local file)`);
  }
} else {
  logger.log('No photo changes');
}
logger.log('');
```

6. **Include photo errors in allErrors array (around line 65):**
```javascript
const allErrors = [
  ...stats.errors,
  ...stats.stadion.errors,
  ...stats.birthdays.errors,
  ...stats.photos.errors
];
```

7. **Update success condition (around line 263):**
```javascript
return {
  success: stats.errors.length === 0 &&
           stats.stadion.errors.length === 0 &&
           stats.birthdays.errors.length === 0 &&
           stats.photos.errors.length === 0,
  stats
};
```
  </action>
  <verify>
Run: `node -c sync-people.js` - syntax check passes
Grep for "runPhotoDownload" to confirm import
Grep for "PHOTO SYNC" to confirm summary section
  </verify>
  <done>
sync-people.js includes photo download and upload steps.
Photo stats tracked and displayed in summary.
Photo errors included in overall error tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sync.sh to alias photos to people</name>
  <files>scripts/sync.sh</files>
  <action>
Update scripts/sync.sh so that 'photos' argument runs sync-people.js instead of sync-photos.js.

In the case statement (around line 76), change the photos case:

```bash
    photos)
        # Photos now integrated into people sync
        SYNC_SCRIPT="sync-people.js"
        ;;
```

This maintains backwards compatibility - `scripts/sync.sh photos` still works but now runs the people pipeline which includes photo sync.

Optionally, add a log message to indicate the change:
```bash
    photos)
        # Photos now integrated into people sync (Phase 19)
        echo "Note: Photo sync is now integrated into people sync" >&2
        SYNC_SCRIPT="sync-people.js"
        ;;
```
  </action>
  <verify>
Check that photos case maps to sync-people.js
Run: `bash -n scripts/sync.sh` - syntax check
  </verify>
  <done>
'scripts/sync.sh photos' runs sync-people.js (integrated pipeline).
Backwards compatibility maintained for existing scripts/cron.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove separate photo cron job from install script</name>
  <files>scripts/install-cron.sh</files>
  <action>
Update scripts/install-cron.sh to remove the separate daily photo sync job since photos now sync hourly with people.

1. **Update the intro text (around line 11-17):**
Change from:
```bash
echo "This will set up five sync schedules:"
echo "  - People sync:    hourly (members, parents, birthdays)"
echo "  - Photo sync:     daily at 6:00 AM"
```

To:
```bash
echo "This will set up four sync schedules:"
echo "  - People sync:    hourly (members, parents, birthdays, photos)"
```

2. **Remove the photo cron entry from CRON_ENTRIES (around line 110-111):**
Delete these lines:
```bash
# Photo sync: daily at 6:00 AM
0 6 * * * $PROJECT_DIR/scripts/sync.sh photos
```

3. **Update the "Scheduled jobs" summary (around line 129-130):**
Change from:
```bash
echo "  - People sync:    every hour (members, parents, birthdays)"
echo "  - Photo sync:     daily at 6:00 AM"
```

To:
```bash
echo "  - People sync:    every hour (members, parents, birthdays, photos)"
```

4. **Update the help commands section (around line 144):**
Change from:
```bash
echo "  Manual sync:                $PROJECT_DIR/scripts/sync.sh {people|photos|teams|functions|nikki|all}"
```

To:
```bash
echo "  Manual sync:                $PROJECT_DIR/scripts/sync.sh {people|teams|functions|nikki|all}"
```

(Note: photos still works but is now an alias to people, so it's optional to mention)

The net result: Four cron jobs instead of five:
- People sync: hourly (now includes photos)
- Nikki sync: daily at 7:00 AM
- Team sync: weekly Sunday at 6:00 AM
- Functions sync: weekly Sunday at 7:00 AM
  </action>
  <verify>
Run: `bash -n scripts/install-cron.sh` - syntax check
Grep for "four sync schedules" to confirm text update
Confirm no "Photo sync: daily" in CRON_ENTRIES
  </verify>
  <done>
install-cron.sh creates four cron jobs (not five).
Photo sync merged into hourly people sync.
Documentation updated to reflect integrated pipeline.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `node -c sync-people.js` - no syntax errors
2. `bash -n scripts/sync.sh` - no syntax errors
3. `bash -n scripts/install-cron.sh` - no syntax errors
4. sync-people.js imports both runPhotoDownload and runPhotoSync
5. Photo summary section added to printSummary
6. sync.sh photos case maps to sync-people.js
7. install-cron.sh has 4 cron entries (not 5)
</verification>

<success_criteria>
- Photo download and upload integrated into sync-people.js pipeline
- Photo stats included in people sync summary report
- Photo errors tracked and reported with other sync errors
- 'scripts/sync.sh photos' runs people sync (backwards compatible)
- install-cron.sh creates 4 jobs (photos merged into hourly people)
- All scripts pass syntax checks
</success_criteria>

<output>
After completion, create `.planning/phases/19-photo-api-optimization/19-03-SUMMARY.md`
</output>
