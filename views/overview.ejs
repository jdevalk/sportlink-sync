<%- include('partials/head', { title, page, user }) %>

<div class="pipeline-grid">
  <% pipelines.forEach(pipeline => { %>
    <a href="/pipeline/<%= pipeline.name %>" class="pipeline-card">
      <div class="pipeline-header">
        <span class="status-indicator status-<%= pipeline.status %>"></span>
        <h3><%= pipeline.displayName %></h3>
        <% if (pipeline.isOverdue) { %>
          <span class="badge-overdue">OVERDUE</span>
        <% } %>
        <button class="btn-start" <% if (pipeline.status === 'running') { %>disabled title="Pipeline is currently running"<% } %> onclick="startPipeline('<%= pipeline.name %>', this); event.preventDefault(); event.stopPropagation();"><%= pipeline.status === 'running' ? 'Running' : 'Start' %></button>
      </div>

      <% if (pipeline.description) { %>
        <div class="pipeline-description"><%= pipeline.description %></div>
      <% } %>

      <% if (pipeline.status === 'running' && pipeline.lastRun) { %>
        <div class="last-run running-info">
          Running since <%= formatRelativeTime(pipeline.lastRun.started_at) %>
        </div>
        <% if (pipeline.previousRun) { %>
          <div class="duration">
            Previous run: <%= formatDuration(pipeline.previousRun.duration_ms) %>
          </div>
        <% } %>
      <% } else if (pipeline.lastRun) { %>
        <div class="last-run">
          Last run: <%= formatRelativeTime(pipeline.lastRun.started_at) %>
        </div>

        <div class="counts">
          <% if (pipeline.lastRun.total_created > 0) { %>
            <span>Created: <%= pipeline.lastRun.total_created %></span>
          <% } %>
          <% if (pipeline.lastRun.total_updated > 0) { %>
            <span>Updated: <%= pipeline.lastRun.total_updated %></span>
          <% } %>
          <% if (pipeline.lastRun.total_failed > 0) { %>
            <span class="count-failed">Failed: <%= pipeline.lastRun.total_failed %></span>
          <% } %>
        </div>

        <div class="duration">
          Duration: <%= formatDuration(pipeline.lastRun.duration_ms) %>
        </div>
      <% } else { %>
        <div class="last-run">
          Never run
        </div>
      <% } %>

      <% if (pipeline.nextRun) { %>
        <div class="next-run">
          Next: <%= formatNextRun(pipeline.nextRun) %> <span class="schedule-label">(<%= pipeline.nextRun.label %>)</span>
        </div>
      <% } else if (pipeline.manualNote) { %>
        <div class="next-run">
          <span class="schedule-label"><%= pipeline.manualNote %></span>
        </div>
      <% } %>
    </a>
  <% }) %>
</div>

<script>
async function startPipeline(name, btn) {
  btn.disabled = true;
  btn.textContent = 'Starting\u2026';
  try {
    const res = await fetch('/api/pipeline/' + encodeURIComponent(name) + '/start', { method: 'POST' });
    if (res.status === 409) {
      btn.textContent = 'Running';
      btn.disabled = true;
      return;
    }
    const data = await res.json();
    if (data.ok) {
      btn.textContent = 'Started';
      setTimeout(() => { window.location.reload(); }, 1000);
    } else {
      btn.textContent = 'Error';
      setTimeout(() => { btn.textContent = 'Start'; btn.disabled = false; }, 3000);
    }
  } catch (e) {
    btn.textContent = 'Error';
    setTimeout(() => { btn.textContent = 'Start'; btn.disabled = false; }, 3000);
  }
}
</script>

<%- include('partials/foot') %>
