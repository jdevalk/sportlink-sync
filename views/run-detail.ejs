<%- include('partials/head', { title, page, user }) %>

<div class="breadcrumb">
  <a href="/">Overview</a> &gt; <a href="/pipeline/<%= run.pipeline %>"><%= pipelineDisplayName %></a> &gt; Run #<%= run.id %>
</div>

<div class="run-summary">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2 style="margin: 0;">Run #<%= run.id %></h2>
    <span class="outcome-badge outcome-<%= run.outcome %>">
      <%= run.outcome %>
    </span>
  </div>

  <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
    <div>Started: <%= new Date(run.started_at).toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }) %></div>
    <% if (run.finished_at) { %>
      <div>Finished: <%= new Date(run.finished_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }) %></div>
    <% } %>
    <div>Duration: <%= formatDuration(run.duration_ms) %></div>
  </div>

  <div class="counts">
    <div class="count-item">
      <div class="count-number"><%= run.total_created %></div>
      <div class="count-label">Created</div>
    </div>
    <div class="count-item">
      <div class="count-number"><%= run.total_updated %></div>
      <div class="count-label">Updated</div>
    </div>
    <div class="count-item">
      <div class="count-number"><%= run.total_skipped %></div>
      <div class="count-label">Skipped</div>
    </div>
    <div class="count-item">
      <div class="count-number <%= run.total_failed > 0 ? 'count-failed' : '' %>"><%= run.total_failed %></div>
      <div class="count-label">Failed</div>
    </div>
  </div>

  <% if (errorCount > 0) { %>
    <div style="margin-top: 1rem;">
      <a href="/errors?run_id=<%= run.id %>" class="btn-errors">
        View <%= errorCount %> error<%= errorCount !== 1 ? 's' : '' %>
      </a>
    </div>
  <% } %>
</div>

<h3>Steps</h3>

<% if (steps.length === 0) { %>
  <p style="color: #666; padding: 2rem; text-align: center;">No step data recorded</p>
<% } else { %>
  <div class="table-wrapper">
    <table class="data-table">
      <thead>
        <tr>
          <th>Step Name</th>
          <th>Duration</th>
          <th>Outcome</th>
          <th>Created</th>
          <th>Updated</th>
          <th>Skipped</th>
          <th>Failed</th>
        </tr>
      </thead>
      <tbody>
        <% steps.forEach(step => { %>
          <tr>
            <td><%= step.step_name %></td>
            <td><%= formatDuration(step.duration_ms) %></td>
            <td>
              <span class="outcome-<%= step.outcome %>">
                <%= step.outcome %>
              </span>
            </td>
            <td><%= step.created_count %></td>
            <td><%= step.updated_count %></td>
            <td><%= step.skipped_count %></td>
            <td>
              <% if (step.failed_count > 0) { %>
                <span class="outcome-failure"><%= step.failed_count %></span>
              <% } else { %>
                <%= step.failed_count %>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
<% } %>

<%- include('partials/foot') %>
